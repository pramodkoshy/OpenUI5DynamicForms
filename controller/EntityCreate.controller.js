sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Text","sap/m/Input","sap/m/TextArea","sap/m/CheckBox","sap/m/DatePicker","sap/m/ComboBox","sap/ui/core/Item"],function(e,t,o,a,r,n,i,s,l){"use strict";return e.extend("com.supabase.easyui5.controller.EntityCreate",{onInit:function(){console.log("EntityCreate controller initializing");const e=new t({tableName:"",tableId:"",entity:{},busy:false,validationErrors:{},parentInfo:null});this.setModel(e,"viewModel");this.getRouter().getRoute("entityCreate").attachPatternMatched(this._onRouteMatched,this);this._loadParentEntityInfo()},_loadParentEntityInfo:function(){try{const e=sessionStorage.getItem("parentEntityInfo");console.log("Loading parent entity info from session storage:",e);if(e){const t=JSON.parse(e);console.log("Parsed parent info:",JSON.stringify(t,null,2));if(t.parentTable&&t.parentId&&t.foreignKey){console.log("Setting parent info in view model");const e=this.getModel("viewModel");e.setProperty("/parentInfo",t);this._parentInfoBackup=JSON.parse(JSON.stringify(t));console.log("Parent info backup created")}else{console.warn("Parent info is incomplete:",JSON.stringify(t))}}else{console.log("No parent info found in session storage")}}catch(e){console.error("Error loading parent entity info:",e)}},_onRouteMatched:function(e){try{const t=e.getParameter("arguments").table;console.log("EntityCreate route matched with table:",t);const o=this.getModel("viewModel");o.setProperty("/tableId",t);const a=t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ");o.setProperty("/tableName",a);this.getView().byId("entityCreatePage").setTitle("Create New "+a);o.setProperty("/entity",{});o.setProperty("/validationErrors",{});this._loadParentEntityInfo();this.getTableMetadata(t).then(e=>{console.log("Table metadata loaded:",JSON.stringify(e,null,2));this._initializeEntityData(e);this._configureForm(e)}).catch(e=>{console.error("Error loading metadata:",e);this.showErrorMessage("Error loading metadata: "+e.message)})}catch(e){console.error("Error in route matched handler:",e);this.showErrorMessage("An unexpected error occurred: "+e.message)}},_initializeEntityData:function(e){const t={};const o=this.getModel("viewModel");const a=o.getProperty("/parentInfo");console.log("Initializing entity data with metadata:",JSON.stringify(e.columns.map(e=>e.name),null,2));console.log("Parent info:",a?JSON.stringify(a):"none");e.columns.forEach(e=>{if(a&&e.name===a.foreignKey){console.log(`Setting foreign key ${e.name} to parent ID ${a.parentId}`);t[e.name]=a.parentId}else if(e.type==="boolean"){t[e.name]=false}else if(e.type==="number"){t[e.name]=0}else if(e.type==="date"){t[e.name]=(new Date).toISOString().split("T")[0]}else{t[e.name]=""}});console.log("Initialized entity data:",JSON.stringify(t,null,2));o.setProperty("/entity",t)},_configureForm:function(e){console.log("Detailed Metadata:",JSON.stringify(e,null,2));const t=this.getView().byId("entityCreateContainer");if(!t){console.error("CRITICAL: Form container not found!");return}t.removeAllFormElements();const o=this.getModel("viewModel");const a=o.getProperty("/entity");const r=o.getProperty("/parentInfo");console.log("Current Entity Data:",JSON.stringify(a,null,2));console.log("Parent Info:",JSON.stringify(r,null,2));const n="createForm_"+Date.now()+"_";const i=e.columns.filter(t=>!(t.editable===false||t.name===e.primaryKey||t.name==="created_at"||t.name==="updated_at"));i.forEach((e,o)=>{console.log(`Processing column: ${e.name}`);const a=e.required===true;const i=new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:e.label||e.name,required:a})});const s="viewModel>/entity/"+e.name;const l=n+e.name+"_"+o;const c=r&&e.name===r.foreignKey;console.log(`Column ${e.name} - Type: ${e.type}`);try{const o=this._createInputField(e,s,a,l,c);if(o){i.addField(o);t.addFormElement(i);console.log(`Added form element for ${e.name}`)}else{console.error(`Failed to create control for ${e.name}`)}}catch(t){console.error(`Error creating control for ${e.name}:`,t)}});console.log(`Form configuration complete.`);const s=this.getView().byId("entityCreateForm");if(s){s.invalidate()}},_loadRelationOptions:function(e,t,o){console.log(`Loading relation options for ${o} from table ${t}`);this.getTableMetadata(t).then(function(o){console.log(`Metadata for related table ${t}:`,JSON.stringify(o,null,2));const a=o.primaryKey;const r=o.titleField||a;console.log(`Primary Key: ${a}, Title Field: ${r}`);this.getSupabaseClient().from(t).select("*").then(({data:t,error:o})=>{if(o){console.error("Error loading relation options",o);return}console.log(`Loaded ${t?t.length:0} relation options`);if(t&&t.length>0){console.log(`Sample record fields: ${Object.keys(t[0]).join(", ")}`)}e.removeAllItems();if(t){t.forEach(t=>{let o=t[r];if(!o){const e=["name","customer_name","company_name","title","display_name","full_name","label"];for(const a of e){if(t[a]){o=t[a];console.log(`Using alternative field '${a}' for display text`);break}}if(!o){const e=Object.keys(t).filter(e=>e!==a&&!e.endsWith("_id")&&!e.includes("created_at")&&!e.includes("updated_at"));if(e.length>0){o=t[e[0]];console.log(`Using fallback field '${e[0]}' for display text`)}}if(!o){o=`ID: ${t[a]}`}}const n=new sap.ui.core.Item({key:t[a],text:o});e.addItem(n);console.log(`Added item: Key=${t[a]}, Text=${o}`)})}})}.bind(this))},_createInputField:function(e,t,o,a,r){let n;switch(e.type){case"relation":if(r){n=new sap.m.Text({id:a,text:`Connected to parent ${this.getModel("viewModel").getProperty("/parentInfo/parentTable")} (ID: ${this.getModel("viewModel").getProperty("/parentInfo/parentId")})`})}else{n=new sap.m.ComboBox({id:a,selectedKey:{path:t},width:"100%",required:o,showSecondaryValues:true,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",selectionChange:function(t){t.getSource().setValueState("None");const o=this.getModel("viewModel");const a=o.getProperty("/validationErrors")||{};if(a[e.name]){delete a[e.name];o.setProperty("/validationErrors",a)}}.bind(this)});this._loadRelationOptions(n,e.relation,e.name)}break;case"boolean":n=new sap.m.CheckBox({id:a,selected:{path:t},width:"100%",select:function(t){const o=this.getModel("viewModel");const a=o.getProperty("/validationErrors");if(a&&a[e.name]){delete a[e.name];o.setProperty("/validationErrors",a)}}.bind(this)});break;case"date":n=new sap.m.DatePicker({id:a,value:{path:t,type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",change:function(t){if(t.getParameter("valid")){t.getSource().setValueState("None");const o=this.getModel("viewModel");const a=o.getProperty("/validationErrors");if(a&&a[e.name]){delete a[e.name];o.setProperty("/validationErrors",a)}}else{t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid date");const o=this.getModel("viewModel");const a=o.getProperty("/validationErrors")||{};a[e.name]="Please enter a valid date";o.setProperty("/validationErrors",a)}}.bind(this)});break;case"number":n=new sap.m.Input({id:a,value:{path:t,type:new sap.ui.model.type.Float({minFractionDigits:0,maxFractionDigits:2})},type:"Number",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:function(t){const o=t.getParameter("value");const a=this.getModel("viewModel");const r=a.getProperty("/validationErrors")||{};if(o&&isNaN(parseFloat(o))){t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid number");r[e.name]="Please enter a valid number";a.setProperty("/validationErrors",r)}else{t.getSource().setValueState("None");if(r[e.name]){delete r[e.name];a.setProperty("/validationErrors",r)}}}.bind(this)});break;case"email":n=new sap.m.Input({id:a,value:{path:t},type:"Email",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:function(t){const o=t.getParameter("value");const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;const r=this.getModel("viewModel");const n=r.getProperty("/validationErrors")||{};if(o&&!a.test(o)){t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid email address");n[e.name]="Please enter a valid email address";r.setProperty("/validationErrors",n)}else{t.getSource().setValueState("None");if(n[e.name]){delete n[e.name];r.setProperty("/validationErrors",n)}}}.bind(this)});break;case"url":n=new sap.m.Input({id:a,value:{path:t},type:"Url",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:function(t){const o=t.getParameter("value");const a=/^(http|https):\/\/[^ "]+$/;const r=this.getModel("viewModel");const n=r.getProperty("/validationErrors")||{};if(o&&!a.test(o)){t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid URL (starting with http:// or https://)");n[e.name]="Please enter a valid URL (starting with http:// or https://)";r.setProperty("/validationErrors",n)}else{t.getSource().setValueState("None");if(n[e.name]){delete n[e.name];r.setProperty("/validationErrors",n)}}}.bind(this)});break;case"text":n=new sap.m.TextArea({id:a,value:{path:t},rows:3,width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});break;default:n=new sap.m.Input({id:a,value:{path:t},width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"})}if(n.setId){n.setId(this.getView().createId(e.name+"Input"))}return n},_resetFormErrorStates:function(){console.log("Resetting error states on all form fields");const e=[];this.getView().$().find(".sapMInputBase").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});this.getView().$().find(".sapMCb").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});this.getView().$().find(".sapMComboBox").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});console.log("Found",e.length,"controls to reset");e.forEach(e=>{if(e.setValueState){console.log("Resetting value state for",e.getId());e.setValueState("None");if(e.setValueStateText){e.setValueStateText("")}}});const t=this.getModel("viewModel");if(t){t.setProperty("/validationErrors",{})}console.log("Form error states reset complete")},_validateForm:function(e,t){const o={};let a=true;const r=[];this.getView().$().find(".sapMInputBase, .sapMCheckBox").each(function(){const e=this.id;const t=sap.ui.getCore().byId(e);if(t){r.push(t)}});console.log("Found input controls:",r.length);r.forEach(e=>{if(e.setValueState){e.setValueState("None");if(e.setValueStateText){e.setValueStateText("")}}});e.columns.forEach(n=>{if(n.editable===false||n.name===e.primaryKey||n.name==="created_at"||n.name==="updated_at"){return}const i=n.name;const s=t[i];let l=null;for(let e=0;e<r.length;e++){const t=r[e].getId();if(t.endsWith(i+"Input")||t.indexOf(i+"Input")!==-1){l=r[e];break}}if(!l){console.log("Control not found for field:",i)}else{console.log("Found control for field:",i,l.getId())}if(n.required&&(s===undefined||s===null||s==="")){a=false;o[i]="This field is required";if(l&&l.setValueState){l.setValueState("Error");if(l.setValueStateText){l.setValueStateText("This field is required")}}console.log("Required field validation failed:",i)}else if(s!==undefined&&s!==null&&s!==""){let e=true;let t="";switch(n.type){case"number":if(isNaN(parseFloat(s))||!isFinite(s)){e=false;t="Please enter a valid number"}break;case"date":const o=new Date(s);if(isNaN(o.getTime())){e=false;t="Please enter a valid date"}break;case"email":const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!a.test(s)){e=false;t="Please enter a valid email address"}break;case"url":const r=/^(http|https):\/\/[^ "]+$/;if(!r.test(s)){e=false;t="Please enter a valid URL (starting with http:// or https://)"}break}if(!e){a=false;o[i]=t;if(l&&l.setValueState){l.setValueState("Error");if(l.setValueStateText){l.setValueStateText(t)}}console.log("Type validation failed:",i,t)}}});const n=this.getModel("viewModel");if(n){n.setProperty("/validationErrors",o)}console.log("Validation result:",a?"Valid":"Invalid",o);return a},onNavBack:function(){const e=this.getModel("viewModel").getProperty("/tableId");this.getRouter().navTo("entityList",{table:e})},onSavePress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entity");console.log("Save pressed with entity data:",JSON.stringify(o,null,2));this._resetFormErrorStates();e.setProperty("/busy",true);let a=e.getProperty("/parentInfo");if(!a&&this._parentInfoBackup){console.log("Using parent info backup");a=this._parentInfoBackup}if(!a){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){a=JSON.parse(e);console.log("Retrieved parent info from session storage:",JSON.stringify(a,null,2))}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}console.log("Final parent info for saving:",a?JSON.stringify(a):"none");this.getTableMetadata(t).then(r=>{if(!this._validateForm(r,o)){this.showErrorMessage("Please correct the errors in the form");e.setProperty("/busy",false);return}const n={};r.columns.forEach(e=>{if(e.editable===false&&e.name!==r.primaryKey||e.name===r.primaryKey||e.name==="created_at"||e.name==="updated_at"){return}n[e.name]=o[e.name]});if(a&&a.foreignKey&&a.parentId){console.log(`Setting foreign key ${a.foreignKey} = ${a.parentId}`);n[a.foreignKey]=a.parentId}console.log("Data to insert:",JSON.stringify(n,null,2));this.getSupabaseClient().from(t).insert(n).then(({data:o,error:r})=>{e.setProperty("/busy",false);if(r){console.error("Error creating entity:",r);this.showErrorMessage("Error creating entity: "+r.message);return}const n=e.getProperty("/tableName");this.showSuccessMessage(n+" created successfully");try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}this._navigateAfterSave(a,t)}).catch(t=>{console.error("Error in Supabase query:",t);this.showErrorMessage("Error creating entity: "+t.message);e.setProperty("/busy",false)})}).catch(t=>{console.error("Error getting table metadata:",t);this.showErrorMessage("Error getting table metadata: "+t.message);e.setProperty("/busy",false)})},_navigateAfterSave:function(e,t){console.log("Navigating after save");if(e&&e.parentTable&&e.parentId){console.log("Navigating to parent entity:",e.parentTable,e.parentId);try{setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:e.parentTable,id:e.parentId});console.log("Navigation to parent initiated")},100)}catch(e){console.error("Error during navigation to parent:",e);try{this.getRouter().navTo("entityList",{table:t});console.log("Fallback navigation to list view initiated")}catch(e){console.error("Error during fallback navigation:",e)}}}else{console.log("No parent info, navigating to list view");this.getRouter().navTo("entityList",{table:t})}},onCancelPress:function(){console.log("Cancel pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");let o=e.getProperty("/parentInfo");if(!o&&this._parentInfoBackup){console.log("Using parent info backup for cancel");o=this._parentInfoBackup}if(!o){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){o=JSON.parse(e);console.log("Retrieved parent info from session storage for cancel")}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}if(o&&o.parentTable&&o.parentId){console.log("Navigating to parent entity after cancel:",o.parentTable,o.parentId);try{setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:o.parentTable,id:o.parentId});console.log("Navigation to parent initiated after cancel")},100)}catch(e){console.error("Error during navigation to parent after cancel:",e);this.getRouter().navTo("entityList",{table:t})}}else{console.log("No parent info, navigating to list view after cancel");this.getRouter().navTo("entityList",{table:t})}}})});
//# sourceMappingURL=EntityCreate.controller.js.map