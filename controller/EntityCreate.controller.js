sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Text","sap/m/Input","sap/m/TextArea","sap/m/CheckBox","sap/m/DatePicker","sap/m/ComboBox","sap/ui/core/Item"],function(e,t,o,n,a,r,i,s,l){"use strict";return e.extend("com.supabase.easyui5.controller.EntityCreate",{onInit:function(){console.log("EntityCreate controller initializing");const e=new t({tableName:"",tableId:"",entity:{},busy:false,validationErrors:{},parentInfo:null});this.setModel(e,"viewModel");console.log("EntityCreate view:",this.getView());console.log("EntityCreate view ID:",this.getView().getId());const o=this.getRouter();if(o){const e=o.getRoute("entityCreate");if(e){e.attachPatternMatched(this._onRouteMatched,this)}const t=o.getRoute("create");if(t){t.attachPatternMatched(this._onRouteMatched,this)}if(!e&&!t){console.error("Could not find create/entityCreate route")}}this._loadParentEntityInfo()},onBeforeShow:function(){console.log("EntityCreate view onBeforeShow called")},onAfterRendering:function(){console.log("EntityCreate view onAfterRendering called");const e=this.getView().byId("entityCreatePage");if(e){console.log("EntityCreate page found, visible:",e.getVisible())}},_onRouteMatched:function(e){try{const t=e.getParameter("arguments");const o=t.table;console.log("EntityCreate._onRouteMatched called");console.log("Route name:",e.getParameter("name"));console.log("Table ID:",o);this._cleanupFormControls();this._sTableName=o;const n=this.getModel("viewModel");n.setProperty("/tableId",o);const a=o.charAt(0).toUpperCase()+o.slice(1).replace(/_/g," ");n.setProperty("/tableName",a);const r=this.getView().byId("entityCreatePage");if(r){r.setTitle("Create New "+a);r.setVisible(true);console.log("EntityCreate page title set and made visible")}else{console.error("EntityCreate page not found!")}n.setProperty("/entity",{});n.setProperty("/validationErrors",{});this._loadParentEntityInfo();this.getTableMetadata(o).then(e=>{console.log("Table metadata loaded for",o);console.log("Metadata columns:",e.columns.length);this._initializeEntityData(e);this._configureForm(e);const t=this.getView().byId("entityCreatePage");if(t){t.rerender()}}).catch(e=>{console.error("Error loading metadata:",e);this.showErrorMessage("Error loading metadata: "+e.message)})}catch(e){console.error("Error in route matched handler:",e);this.showErrorMessage("An unexpected error occurred: "+e.message)}},_cleanupFormControls:function(){console.log("Cleaning up existing form controls");const e=this.getView().byId("entityCreateContainer");if(e){const t=e.getFormElements();t.forEach(e=>{const t=e.getFields();t.forEach(e=>{if(e&&e.destroy){console.log("Destroying control with ID:",e.getId());e.destroy()}});if(e&&e.destroy){e.destroy()}});e.removeAllFormElements()}},_configureForm:function(e){console.log("Configuring form with metadata");const t=this.getView();if(!t){console.error("View not available!");return}const o=t.byId("entityCreateContainer");if(!o){console.error("Form container 'entityCreateContainer' not found!");console.log("Available view controls:",Object.keys(t.mAggregations||{}));const e=t.byId("entityCreateForm");if(e){console.log("Form found, containers:",e.getFormContainers().length)}return}this._cleanupFormControls();const n=this.getModel("viewModel");const a=n.getProperty("/parentInfo");const r="createForm_"+Date.now()+"_";console.log("Using unique prefix:",r);e.columns.forEach((t,n)=>{if(t.editable===false||t.name===e.primaryKey||t.name==="created_at"||t.name==="updated_at"){return}console.log(`Processing column: ${t.name}`);const i=t.required===true;const s=new sap.ui.layout.form.FormElement({label:new sap.m.Label({text:t.label||t.name,required:i})});const l="viewModel>/entity/"+t.name;const c=r+t.name+"_"+n;console.log(`Creating control with ID: ${c}`);const d=a&&t.name===a.foreignKey;const g=this._createInputField(t,l,i,c,d);if(g){s.addField(g);o.addFormElement(s);console.log(`Added form element for field: ${t.name}`)}});const i=o.getFormElements().length;console.log(`Form configuration complete. Total form elements: ${i}`);o.invalidate()},_createInputField:function(e,t,o,n,a){let r;const i=this.getView().createId(n);console.log(`Creating control type '${e.type}' with ID: ${i}`);switch(e.type){case"relation":if(a){r=new sap.m.Text({id:i,text:`Connected to parent ${this.getModel("viewModel").getProperty("/parentInfo/parentTable")} (ID: ${this.getModel("viewModel").getProperty("/parentInfo/parentId")})`})}else{r=new sap.m.ComboBox({id:i,selectedKey:{path:t},width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});this._loadRelationOptions(r,e.relation,e.name)}break;case"boolean":r=new sap.m.CheckBox({id:i,selected:{path:t},width:"100%"});break;case"date":r=new sap.m.DatePicker({id:i,value:{path:t,type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});break;case"number":r=new sap.m.Input({id:i,value:{path:t},type:"Number",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});break;case"email":r=new sap.m.Input({id:i,value:{path:t},type:"Email",width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});break;case"text":r=new sap.m.TextArea({id:i,value:{path:t},rows:3,width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});break;default:r=new sap.m.Input({id:i,value:{path:t},width:"100%",required:o,valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}"});break}if(r){r.data("columnName",e.name)}return r},onSavePress:async function(){try{const e=window.supabaseClient;if(!e){throw new Error("Supabase client not initialized")}if(!this._sTableName){throw new Error("Table name is not set. Please navigate back and try again.")}console.log("Creating entity for table:",this._sTableName);const t=this.getModel("viewModel");t.setProperty("/busy",true);const o=t.getProperty("/entity");const n=await this.getTableMetadata(this._sTableName);const a={};let r=false;const i={};for(const e in o){if(e==="created_at"||e==="updated_at"){continue}const t=n.columns.find(t=>t.name===e);if(t&&t.editable===false&&e!==n.primaryKey){continue}if(e===n.primaryKey){continue}const s=o[e];if(t&&t.required===true){if(s===undefined||s===null||s===""){i[e]=`${t.label||e} is required`;r=true}}if(s!==undefined&&s!==null&&s!==""){a[e]=s}else if(t&&t.required===true){a[e]=null}}if(r){t.setProperty("/validationErrors",i);t.setProperty("/busy",false);sap.m.MessageToast.show("Please fill in all required fields");return}console.log("Form data collected:",a);const s=t.getProperty("/parentInfo");if(s&&s.foreignKey&&s.parentId){console.log(`Setting foreign key ${s.foreignKey} = ${s.parentId}`);a[s.foreignKey]=s.parentId}const l=["customers","products","lead","campaigns","contacts","activities"];let c;if(l.includes(this._sTableName)){let t=this._sTableName;if(t.endsWith("s")){t=t.substring(0,t.length-1)}const o={entity_type:t,name:a.name||a.company_name||a.product_name||a.subject||"New "+t,description:a.description||""};console.log("Creating entity with data:",o);const{data:n,error:r}=await e.from("entities").insert(o).select().single();if(r){throw r}console.log("Entity created:",n);a.entity_id=n.entity_id}console.log("Inserting into "+this._sTableName+" table:",a);const{data:d,error:g}=await e.from(this._sTableName).insert(a).select().single();if(g){console.error("Error inserting into "+this._sTableName+":",g);if(a.entity_id){await e.from("entities").delete().eq("entity_id",a.entity_id)}throw g}c=d;console.log("Table record created:",c);t.setProperty("/busy",false);this._navigateAfterSave(s,c,n);const m=this._sTableName.charAt(0).toUpperCase()+this._sTableName.slice(1).replace(/_/g," ");sap.m.MessageToast.show("Successfully created "+m)}catch(e){console.error("Error creating entity:",e);const t=this.getModel("viewModel");t.setProperty("/busy",false);let o="Error creating record: ";if(e.code==="PGRST204"){o+="Column not found in database schema"}else if(e.code==="23502"){o+="Required field missing"}else{o+=e.message||"Unknown error"}sap.m.MessageToast.show(o)}},_loadParentEntityInfo:function(){try{const e=sessionStorage.getItem("parentEntityInfo");console.log("Loading parent entity info from session storage:",e);if(e){const t=JSON.parse(e);console.log("Parsed parent info:",JSON.stringify(t,null,2));if(t.parentTable&&t.parentId&&t.foreignKey){console.log("Setting parent info in view model");const e=this.getModel("viewModel");e.setProperty("/parentInfo",t);this._parentInfoBackup=JSON.parse(JSON.stringify(t));console.log("Parent info backup created")}else{console.warn("Parent info is incomplete:",JSON.stringify(t))}}else{console.log("No parent info found in session storage")}}catch(e){console.error("Error loading parent entity info:",e)}},_initializeEntityData:function(e){const t={};const o=this.getModel("viewModel");const n=o.getProperty("/parentInfo");console.log("Initializing entity data for table:",this._sTableName);e.columns.forEach(e=>{if(n&&e.name===n.foreignKey){console.log(`Setting foreign key ${e.name} to parent ID ${n.parentId}`);t[e.name]=n.parentId}else if(e.type==="boolean"){t[e.name]=false}else if(e.type==="number"){t[e.name]=null}else if(e.type==="date"){t[e.name]=null}else{t[e.name]=""}});console.log("Initialized entity data:",JSON.stringify(t,null,2));o.setProperty("/entity",t)},_loadRelationOptions:function(e,t,o){console.log(`Loading relation options for ${o} from table ${t}`);this.getTableMetadata(t).then(function(o){const n=o.primaryKey;const a=o.titleField||n;this.getSupabaseClient().from(t).select("*").then(({data:t,error:o})=>{if(o){console.error("Error loading relation options",o);return}e.removeAllItems();if(t){t.forEach(t=>{const o=t[a]||t.name||`ID: ${t[n]}`;e.addItem(new sap.ui.core.Item({key:t[n],text:o}))})}})}.bind(this))},_navigateAfterSave:function(e,t,o){console.log("Navigating after save");try{sessionStorage.removeItem("parentEntityInfo")}catch(e){console.warn("Could not clear session storage:",e)}if(e&&e.parentTable&&e.parentId){console.log("Navigating to parent detail",e.parentTable,e.parentId);this.getRouter().navTo("detail",{table:e.parentTable,id:e.parentId})}else{console.log("Navigating to list view",this._sTableName);try{const e="list"||"entityList";this.getRouter().navTo(e,{table:this._sTableName},true)}catch(e){console.error("Navigation to list failed:",e);try{this.getRouter().navTo("entityList",{table:this._sTableName})}catch(e){console.error("Fallback navigation also failed:",e);this.getRouter().navTo("home")}}}},onCancelPress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/parentInfo");try{sessionStorage.removeItem("parentEntityInfo")}catch(e){console.warn("Could not clear session storage:",e)}if(t&&t.parentTable&&t.parentId){this.getRouter().navTo("detail",{table:t.parentTable,id:t.parentId})}else{this.getRouter().navTo("list",{table:this._sTableName})}},onToggleNav:function(){const e=this.getOwnerComponent().getSplitApp();if(e){if(e.isMasterShown()){e.hideMaster()}else{e.showMaster()}}}})});
//# sourceMappingURL=EntityCreate.controller.js.map