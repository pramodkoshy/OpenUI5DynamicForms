sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Dialog","sap/m/Button","sap/m/Text","sap/m/Input","sap/m/TextArea","sap/m/Select","sap/m/CheckBox","sap/m/MessageBox","sap/m/MessageToast","sap/m/Table","sap/m/Column","sap/m/ColumnListItem","sap/m/Label","sap/m/HBox","sap/m/VBox","sap/m/Panel","sap/ui/core/Item","sap/ui/unified/FileUploader"],function(e,t,o,n,r,s,i,a,l,c,d,g,u,f,p,y,m,h,E,b){"use strict";return e.extend("com.supabase.easyui5.controller.EntityDetail",{formatter:{formatDate:function(e){if(!e){return""}return new Date(e).toLocaleDateString()},formatBoolean:function(e){return e?"Yes":"No"},formatNumber:function(e){if(e===undefined||e===null){return""}return parseFloat(e).toFixed(2)}},onInit:function(){console.log("EntityDetail controller initialized");const e=new t({tableName:"",tableId:"",entityId:"",entityTitle:"",entitySubtitle:"",entity:{},originalEntity:{},relatedItems:[],filteredRelatedItems:[],editMode:false,busy:false,delay:0,validationErrors:{},parentInfo:null});this.setModel(e,"viewModel");this.getRouter().getRoute("entityDetail").attachPatternMatched(this._onRouteMatched,this);this._loadParentInfoForEdit();try{this._registerExtensions()}catch(e){console.error("Could not register extensions:",e)}},_loadParentInfoForEdit:function(){try{const e=sessionStorage.getItem("parentEntityInfo");console.log("Checking for parent info in detail view:",e);if(e){const t=JSON.parse(e);console.log("Found parent info:",JSON.stringify(t,null,2));const o=t.timestamp&&(new Date).getTime()-t.timestamp<5*60*1e3;const n=this.getModel("viewModel");n.setProperty("/parentInfo",t);this._parentInfoBackup=JSON.parse(JSON.stringify(t));console.log("Parent info stored in view model and backup created");console.log("Parent entity:",t.parentTable,t.parentId);console.log("Is editing:",t.isEditing);console.log("Foreign key:",t.foreignKey);console.log("Info freshness:",o?"Fresh":"Stale")}else{console.log("No parent info found in session storage")}}catch(e){console.error("Error parsing parent entity info:",e)}},_registerExtensions:function(){console.log("Registering controller extensions");try{sap.ui.require(["com/supabase/easyui5/controller/EntityDetailExtensions.controller"],function(e){if(e){const t=e();console.log("Extensions loaded successfully");if(t.form&&t.form._configureForm){this._configureForm=t.form._configureForm.bind(this)}if(t.relatedItems&&t.relatedItems._loadRelatedItems){this._loadRelatedItems=t.relatedItems._loadRelatedItems.bind(this)}if(t.actions){if(t.actions.onSavePress){this.onSavePress=t.actions.onSavePress.bind(this)}if(t.actions.onCancelPress){this.onCancelPress=t.actions.onCancelPress.bind(this)}if(t.actions.onEditPress){this.onEditPress=t.actions.onEditPress.bind(this)}}}}.bind(this))}catch(e){console.error("Error registering extensions:",e)}},_onRouteMatched:function(e){console.log("üîç ROUTE DEBUG: EntityDetail route matched event fired");try{const t=e.getParameter("arguments").table;const o=e.getParameter("arguments").id;console.log("üîç ROUTE DEBUG: Parameters - Table ID:",t,"Entity ID:",o);console.log("üîç ROUTE DEBUG: View available?",!!this.getView());const n=this.getModel("viewModel");if(!n){console.error("üîç ROUTE DEBUG: viewModel not found! Creating a new one.");const e=new sap.ui.model.json.JSONModel({tableName:"",tableId:"",entityId:"",entityTitle:"",entitySubtitle:"",entity:{},originalEntity:{},relatedItems:[],filteredRelatedItems:[],editMode:false,busy:false,delay:0,validationErrors:{}});this.setModel(e,"viewModel")}const r=this.getModel("viewModel");console.log("üîç ROUTE DEBUG: Setting properties in viewModel");r.setProperty("/tableId",t);r.setProperty("/entityId",o);const s=t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ");r.setProperty("/tableName",s);r.setProperty("/validationErrors",{});r.setProperty("/editMode",false);r.setProperty("/busy",true);r.setProperty("/relatedItems",[]);r.setProperty("/filteredRelatedItems",[]);console.log("üîç ROUTE DEBUG: Checking for relatedItemsTable in view");const i=this.getView().byId("relatedItemsTable");console.log("üîç ROUTE DEBUG: Table found?",!!i);if(i){console.log("üîç ROUTE DEBUG: Current table binding:",i.isBound("items")?"Bound":"Not bound");if(i.isBound("items")){const e=i.getBinding("items");console.log("üîç ROUTE DEBUG: Current binding path:",e?e.getPath():"unknown")}console.log("üîç ROUTE DEBUG: Pre-initializing table with empty template");try{if(!i.getBindingInfo("items")||!i.getBindingInfo("items").template){const e=new sap.m.ColumnListItem;i.bindItems({path:"viewModel>/filteredRelatedItems",template:e});console.log("üîç ROUTE DEBUG: Applied temporary binding with empty template")}}catch(e){console.error("üîç ROUTE DEBUG: Error applying temporary binding:",e)}}console.log("üîç ROUTE DEBUG: Pre-initializing related items table");this._configureRelatedItemsTable(t);console.log("üîç ROUTE DEBUG: Getting table metadata");this.getTableMetadata(t).then(e=>{console.log("üîç ROUTE DEBUG: Metadata loaded successfully");this._oTableMetadata=e;console.log("üîç ROUTE DEBUG: Now loading entity data");this._loadEntity(t,o);this._loadNotesAndFiles(t,o)}).catch(e=>{console.error("üîç ROUTE DEBUG: Error loading metadata:",e);console.error("üîç ROUTE DEBUG: Error stack:",e.stack);r.setProperty("/busy",false)})}catch(e){console.error("üîç ROUTE DEBUG: Critical error in _onRouteMatched:",e);console.error("üîç ROUTE DEBUG: Error stack:",e.stack);try{const e=this.getModel("viewModel");if(e){e.setProperty("/busy",false)}}catch(e){console.error("üîç ROUTE DEBUG: Error resetting busy state:",e)}}},_configureForm:function(e,t){try{console.log("Finding suitable container for entity details");let o=null;o=this.getView().byId("detailContentArea")||this.getView().byId("entityDetailsContainer");if(!o){const e=this.getView().getControlsByType("sap.uxap.ObjectPageSubSection");if(e&&e.length>0){o=e[0];console.log("Using ObjectPageSubSection as container")}}if(!o){const e=this.getView().getControlsByType("sap.ui.layout.form.SimpleForm")||this.getView().getControlsByType("sap.ui.layout.form.Form")||this.getView().getControlsByType("sap.m.VBox")||this.getView().getControlsByType("sap.m.Panel");if(e&&e.length>0){o=e[0];console.log("Using layout container:",o.getMetadata().getName())}}if(!o){const e=this.getView().getControlsByType("sap.m.Page")[0]||this.getView().getControlsByType("sap.uxap.ObjectPageLayout")[0];if(e){if(e.getContent&&e.addContent){o=e;console.log("Using page as container")}}}if(!o){console.error("Could not find any suitable container for entity details");return}const n=new sap.ui.layout.Grid({defaultSpan:"XL4 L4 M6 S12",vSpacing:1,hSpacing:1,width:"100%"});e.columns.forEach(e=>{if(!e.visible)return;const o=new sap.m.VBox({width:"100%",alignItems:"Start"});o.addItem(new p({text:e.label,design:"Bold",width:"100%"}).addStyleClass("sapUiTinyMarginBottom"));let s;switch(e.type){case"relation":s=new r({text:t[e.name+"_text"]||t[e.name]||""});break;case"boolean":s=new r({text:t[e.name]?"Yes":"No"});break;case"date":s=new r({text:t[e.name]?new Date(t[e.name]).toLocaleDateString():""});break;case"number":s=new r({text:t[e.name]!==undefined?parseFloat(t[e.name]).toFixed(2):""});break;default:s=new r({text:t[e.name]||""})}s.addStyleClass("sapUiTinyMarginTop");s.setWidth("100%");o.addItem(s);n.addContent(o.addStyleClass("sapUiSmallMargin"))});const s=new sap.m.Panel({headerText:"Details",expandable:false,expanded:true,backgroundDesign:"Solid",content:[n]});if(o.removeAllContent){o.removeAllContent();o.addContent(s)}else if(o.removeAllItems){o.removeAllItems();o.addItem(s)}else if(o.removeAllFormElements){o.removeAllFormElements();const e=new sap.ui.layout.form.FormElement;e.addField(s);o.addFormElement(e)}else if(o.addContent){o.addContent(s)}else{console.error("Container doesn't have a method to add content:",o)}console.log("Entity details added to container")}catch(e){console.error("Error in dynamic _configureForm:",e)}},_configureRelatedItemsTable:function(e){console.log("üîç TABLE DEBUG: Started _configureRelatedItemsTable for table:",e);try{const t=this.getView().byId("relatedItemsTable");console.log("üîç TABLE DEBUG: Found table?",!!t,"Table ID:",t?t.getId():"null");if(!t){console.error("üîç TABLE DEBUG: Related items table not found in the view! Check ID in XML");return}const o=t.getBindingInfo("items");console.log("üîç TABLE DEBUG: Current binding info:",o);console.log("üîç TABLE DEBUG: Existing columns count:",t.getColumns().length);t.removeAllColumns();console.log("üîç TABLE DEBUG: Removed all columns");this.getTableMetadata(e).then(o=>{console.log("üîç TABLE DEBUG: Got metadata for table",e,":",JSON.stringify(o,null,2));const n=o.columns.filter(e=>e.visible).slice(0,5);console.log("üîç TABLE DEBUG: Visible columns:",n.length);n.forEach((e,o)=>{console.log(`üîç TABLE DEBUG: Adding column ${o+1}:`,e.name);t.addColumn(new sap.m.Column({header:new sap.m.Label({text:e.label})}))});console.log("üîç TABLE DEBUG: Adding actions column");t.addColumn(new sap.m.Column({header:new sap.m.Label({text:"Actions"}),hAlign:"Right"}));console.log("üîç TABLE DEBUG: Finished adding columns, total:",t.getColumns().length);console.log("üîç TABLE DEBUG: Creating template for binding");const r=new sap.m.ColumnListItem({type:"Navigation",press:this.onRelatedItemPress.bind(this)});n.forEach((e,t)=>{console.log(`üîç TABLE DEBUG: Adding cell ${t+1} for column:`,e.name);let o;switch(e.type){case"relation":o=new sap.m.Text({text:"{viewModel>"+e.name+"_text}"});break;case"boolean":o=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:this.formatter.formatBoolean}});break;case"date":o=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:this.formatter.formatDate}});break;case"number":o=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:this.formatter.formatNumber}});break;default:o=new sap.m.Text({text:"{viewModel>"+e.name+"}"})}r.addCell(o)});console.log("üîç TABLE DEBUG: Adding actions cell to template");const s=new sap.m.HBox({justifyContent:"End",items:[new sap.m.Button({icon:"sap-icon://edit",type:"Transparent",tooltip:"Edit",press:this.onEditRelatedItemPress.bind(this)}),new sap.m.Button({icon:"sap-icon://delete",type:"Transparent",tooltip:"Delete",press:this.onDeleteRelatedItemPress.bind(this)})]});r.addCell(s);console.log("üîç TABLE DEBUG: Template created with cells:",r.getCells().length);const i=this.getModel("viewModel");const a=i.getProperty("/filteredRelatedItems")||[];console.log("üîç TABLE DEBUG: Current data in model:",JSON.stringify(a));try{console.log("üîç TABLE DEBUG: About to bind items to table");const e={path:"viewModel>/filteredRelatedItems",template:r};console.log("üîç TABLE DEBUG: Binding settings:",JSON.stringify(e,function(e,t){if(e==="template")return"[Template Object]";return t}));if(t.isBound("items")){console.log("üîç TABLE DEBUG: Unbinding existing items");t.unbindItems()}t.bindItems(e);console.log("üîç TABLE DEBUG: Items bound successfully");const o=t.getBindingInfo("items");console.log("üîç TABLE DEBUG: New binding info path:",o?o.path:"none","Has template:",!!o&&!!o.template)}catch(e){console.error("üîç TABLE DEBUG: Error during item binding:",e);console.error("üîç TABLE DEBUG: Error stack:",e.stack)}console.log("üîç TABLE DEBUG: Table configuration completed");t.invalidate();console.log("üîç TABLE DEBUG: Table invalidated for re-rendering")}).catch(e=>{console.error("üîç TABLE DEBUG: Error getting metadata:",e);console.error("üîç TABLE DEBUG: Error stack:",e.stack)})}catch(e){console.error("üîç TABLE DEBUG: Critical error in _configureRelatedItemsTable:",e);console.error("üîç TABLE DEBUG: Error stack:",e.stack)}},onToggleNav:function(){try{const e=this.getOwnerComponent().getSplitApp();if(!e){console.error("SplitApp control not found!");return}const t=this.getOwnerComponent().getModel("appView");if(!t){console.error("AppView model not found!");return}const o=t.getProperty("/navExpanded");const n=this.getView().byId("navToggleButton");if(o){e.hideMaster();if(n){n.setIcon("sap-icon://menu2");n.setTooltip("Show Navigation")}t.setProperty("/navExpanded",false)}else{e.showMaster();if(n){n.setIcon("sap-icon://navigation-left-arrow");n.setTooltip("Hide Navigation")}t.setProperty("/navExpanded",true)}}catch(e){console.error("Error in menu toggle:",e)}},_createEditFormContent:function(e,t){const o=[];this._editControls={};e.columns.forEach(n=>{if(n.editable===false||!n.visible||n.name===e.primaryKey||n.name==="created_at"||n.name==="updated_at"){return}o.push(new sap.m.Label({text:n.label,required:n.required===true}));let r;switch(n.type){case"relation":r=new sap.m.ComboBox({selectedKey:t[n.name],required:n.required===true,showSecondaryValues:true});this._loadRelationOptionsForEdit(r,n.relation,n.name);break;case"boolean":r=new sap.m.CheckBox({selected:t[n.name]===true});break;case"date":r=new sap.m.DatePicker({value:t[n.name]?new Date(t[n.name]).toISOString().split("T")[0]:null,valueFormat:"yyyy-MM-dd",displayFormat:"medium",required:n.required===true,change:function(e){if(e.getParameter("valid")){e.getSource().setValueState("None")}else{e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid date")}}});break;case"number":r=new sap.m.Input({value:t[n.name],type:"Number",required:n.required===true,liveChange:function(e){const t=e.getParameter("value");if(t&&isNaN(parseFloat(t))){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid number")}else{e.getSource().setValueState("None")}}});break;case"email":r=new sap.m.Input({value:t[n.name],type:"Email",required:n.required===true,liveChange:function(e){const t=e.getParameter("value");const o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(t&&!o.test(t)){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid email address")}else{e.getSource().setValueState("None")}}});break;case"url":r=new sap.m.Input({value:t[n.name],type:"Url",required:n.required===true,liveChange:function(e){const t=e.getParameter("value");const o=/^(http|https):\/\/[^ "]+$/;if(t&&!o.test(t)){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid URL (starting with http:// or https://)")}else{e.getSource().setValueState("None")}}});break;case"text":r=new sap.m.TextArea({value:t[n.name],rows:3,required:n.required===true});break;default:r=new sap.m.Input({value:t[n.name],required:n.required===true})}this._editControls[n.name]=r;o.push(r)});return o},_validateEditForm:function(e){let t=true;e.columns.forEach(o=>{if(o.editable===false||!o.visible||o.name===e.primaryKey||o.name==="created_at"||o.name==="updated_at"){return}const n=this._editControls[o.name];if(!n)return;if(n.setValueState){n.setValueState("None");if(n.setValueStateText){n.setValueStateText("")}}let r;if(n instanceof sap.m.CheckBox){r=n.getSelected()}else if(n.getValue){r=n.getValue()}if(o.required===true&&(r===undefined||r===null||r==="")){t=false;if(n.setValueState){n.setValueState("Error");if(n.setValueStateText){n.setValueStateText("This field is required")}}console.log("Validation failed for",o.name,": Required field is empty");return}if(r===undefined||r===null||r===""){return}let s=true;let i="";switch(o.type){case"number":if(isNaN(parseFloat(r))||!isFinite(r)){s=false;i="Please enter a valid number"}break;case"date":const e=new Date(r);if(isNaN(e.getTime())){s=false;i="Please enter a valid date"}break;case"email":const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!t.test(r)){s=false;i="Please enter a valid email address"}break;case"url":const o=/^(http|https):\/\/[^ "]+$/;if(!o.test(r)){s=false;i="Please enter a valid URL (starting with http:// or https://)"}break}if(!s){t=false;if(n.setValueState){n.setValueState("Error");if(n.setValueStateText){n.setValueStateText(i)}}console.log("Validation failed for",o.name,":",i)}});return t},_areObjectsEqual:function(e,t){if(e===t)return true;if(!e||!t)return false;const o=[...new Set([...Object.keys(e),...Object.keys(t)])];const n=["created_at","updated_at"];for(const r of o){if(n.includes(r))continue;const o=e[r];const s=t[r];if(typeof o==="object"&&typeof s==="object"&&o!==null&&s!==null){if(!this._areObjectsEqual(o,s))return false}else if(o instanceof Date&&s instanceof Date){if(o.getTime()!==s.getTime())return false}else if((o===null||o===undefined)&&(s===null||s===undefined)){continue}else if(o!==s){return false}}return true},_saveEntity:function(e,t,o,n){const r=this.getModel("viewModel");r.setProperty("/busy",true);if(typeof t==="object"||!t){console.log("Entity ID is not a string, getting from model");t=r.getProperty("/entityId");if(!t){this.showErrorMessage("Error: Missing entity ID for update operation");r.setProperty("/busy",false);return}}console.log("Using Entity ID for update:",t,"Type:",typeof t);if(!e){console.error("Missing table ID for _saveEntity");r.setProperty("/busy",false);this.showErrorMessage("Error updating entity: Missing table ID");return}const s=n||r.getProperty("/entity");if(!s){console.error("No entity data available for saving");r.setProperty("/busy",false);this.showErrorMessage("Error updating entity: No data available");return}this.getTableMetadata(e).then(o=>{if(!o||!o.columns){throw new Error("Invalid metadata structure - missing columns")}console.log("Using metadata for save:",o);const n={};const r=o.primaryKey;if(!r){throw new Error("No primary key defined in metadata")}console.log("Using primary key for update:",r);const i=async()=>{const e=[];for(const t of o.columns){if(t.editable===false&&t.name!==r||t.name===r){continue}if(t.type==="relation"){const o=t.name;let r=s[o];console.log(`Processing relation field ${o}, current value:`,r,typeof r);if(r&&(isNaN(Number(r))||typeof r==="string"&&r.includes(" "))){const s=this._resolveRelationKey(t.relation,r).then(e=>{if(e!==null){console.log(`Resolved relation key for ${o}: ${e}`);n[o]=e}else{console.log(`Could not resolve relation key for ${o}, using original value`);n[o]=r}});e.push(s)}else{if(typeof r==="string"&&!isNaN(parseInt(r))){r=parseInt(r)}n[o]=r;console.log(`Using relation value for ${o}:`,r,typeof r)}}else{n[t.name]=s[t.name]}}await Promise.all(e)};return i().then(()=>{const s=o.columns.some(e=>e.name==="updated_at");if(s){n["updated_at"]=(new Date).toISOString()}console.log("Final data to update:",n);console.log("Table ID:",e);console.log("Entity ID:",t,"Type:",typeof t);return this.getSupabaseClient().from(e).update(n).eq(r,t).then(({data:e,error:t})=>{if(t){throw t}return e})})}).then(o=>{r.setProperty("/busy",false);r.setProperty("/editMode",false);this.showSuccessMessage("Entity updated successfully");this._loadEntity(e,t)}).catch(e=>{console.error("Error updating entity:",e);this.showErrorMessage("Error updating entity: "+(e.message||JSON.stringify(e)));r.setProperty("/busy",false)})},_resolveRelationKey:function(e,t){console.log(`Trying to resolve relation key for ${e} with display value: "${t}"`);return this.getTableMetadata(e).then(o=>{const n=o.primaryKey;const r=o.titleField||n;console.log(`Using primary key ${n} and title field ${r} for relation resolution`);return this.getSupabaseClient().from(e).select(n).eq(r,t).then(({data:o,error:r})=>{if(r){console.error(`Error querying relation ${e}:`,r);return null}if(o&&o.length>0){console.log(`Found exact match for ${t} in ${e}:`,o[0][n]);return o[0][n]}const s=extractNumberFromString(t);if(s!==null){console.log(`Extracted potential key ${s} from "${t}"`);return this.getSupabaseClient().from(e).select(n).eq(n,s).then(({data:t,error:o})=>{if(o){console.error(`Error verifying key ${s}:`,o);return null}if(t&&t.length>0){console.log(`Verified key ${s} exists in ${e}`);return s}console.log(`Could not verify key ${s} in ${e}`);return null})}console.log(`No relation key found for ${t} in ${e}`);return null})}).catch(e=>{console.error(`Error resolving relation key:`,e);return null})},extractNumberFromString(e){if(!e||typeof e!=="string")return null;const t=e.match(/\d+/g);if(t&&t.length>0){return parseInt(t[t.length-1],10)}return null},onDeletePress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");const n=e.getProperty("/tableName");const r=e.getProperty("/relatedItems")||[];if(r&&r.length>0){sap.m.MessageBox.error("Cannot delete this "+e.getProperty("/tableName")+" because it has related items. Please delete all related items first.",{title:"Delete Not Allowed"});return}sap.m.MessageBox.confirm("Are you sure you want to delete this "+n+"?",{title:"Delete Confirmation",onClose:function(e){if(e===sap.m.MessageBox.Action.OK){this._deleteEntity(t,o)}}.bind(this),styleClass:this.getOwnerComponent().getContentDensityClass()})},_deleteEntity:function(e,t){const o=this.getModel("viewModel");o.setProperty("/busy",true);this.getTableMetadata(e).then(n=>{const r=n.primaryKey;this.getSupabaseClient().from(e).delete().eq(r,t).then(({error:t})=>{o.setProperty("/busy",false);if(t){this.showErrorMessage("Error deleting entity",t);return}const n=o.getProperty("/tableName");this.showSuccessMessage(n+" deleted successfully");this.getRouter().navTo("entityList",{table:e})}).catch(e=>{console.error("Error in Supabase query:",e);this.showErrorMessage("Error deleting entity: "+e.message);o.setProperty("/busy",false)})}).catch(e=>{console.error("Error getting table metadata:",e);this.showErrorMessage("Error getting table metadata: "+e.message);o.setProperty("/busy",false)})},onSavePress:function(){console.log("Save button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");if(!o){this.showErrorMessage("Cannot save: Missing entity ID");return}console.log("Saving entity with ID:",o);const n=JSON.parse(JSON.stringify(e.getProperty("/entity")));e.setProperty("/originalEntity",n);e.setProperty("/busy",true);let r=e.getProperty("/parentInfo");if(!r&&this._parentInfoBackup){console.log("Using parent info backup");r=this._parentInfoBackup}if(!r){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){r=JSON.parse(e);console.log("Retrieved parent info from session storage")}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}console.log("Parent info for navigation after save:",r?JSON.stringify(r,null,2):"none");this.getTableMetadata(t).then(s=>{if(!this.validateForm(s,n)){this.showErrorMessage("Please correct the errors in the form");e.setProperty("/busy",false);return}const i=s.primaryKey;const a={};s.columns.forEach(e=>{if(e.editable===false&&e.name!==i||e.name===i){return}a[e.name]=n[e.name]});a["updated_at"]=(new Date).toISOString();console.log("Data to update:",JSON.stringify(a,null,2));this.getSupabaseClient().from(t).update(a).eq(i,o).then(({data:n,error:s})=>{e.setProperty("/busy",false);if(s){console.error("Update error:",s);this.showErrorMessage("Error updating entity",s);return}e.setProperty("/editMode",false);this.showSuccessMessage("Entity updated successfully");try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}if(r&&r.isEditing&&r.parentTable&&r.parentId){console.log("Navigating back to parent entity after edit:",r.parentTable,r.parentId);setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:r.parentTable,id:r.parentId});console.log("Navigation back to parent initiated")},100)}else{this._loadEntity(t,o)}}).catch(t=>{console.error("Error in Supabase query:",t);this.showErrorMessage("Error updating entity: "+t.message);e.setProperty("/busy",false)})}).catch(t=>{console.error("Error getting table metadata:",t);this.showErrorMessage("Error getting table metadata: "+t.message);e.setProperty("/busy",false)})},onCancelPress:function(){console.log("Cancel button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");let o=e.getProperty("/parentInfo");if(!o&&this._parentInfoBackup){console.log("Using parent info backup for cancel");o=this._parentInfoBackup}if(!o){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){o=JSON.parse(e);console.log("Retrieved parent info from session storage for cancel")}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}e.setProperty("/editMode",false);if(o&&o.parentTable&&o.parentId){console.log("Navigating to parent entity after cancel:",o.parentTable,o.parentId);try{setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:o.parentTable,id:o.parentId});console.log("Navigation to parent initiated after cancel")},100)}catch(e){console.error("Error during navigation to parent after cancel:",e);this.getRouter().navTo("entityList",{table:t})}}else{this._loadEntity(t,e.getProperty("/entityId"))}},onAddRelatedItemPress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");this.getTableMetadata(t).then(e=>{if(!e.relations||e.relations.length===0){this.showErrorMessage("No relations defined for this entity");return}const n=e.relations[0];const r={parentTable:t,parentId:o,foreignKey:n.foreignKey};sessionStorage.setItem("parentEntityInfo",JSON.stringify(r));this.getRouter().navTo("entityCreate",{table:n.table})})},onEditRelatedItemPress:function(e){console.log("Edit related item button pressed");if(e.preventDefault){e.preventDefault()}const t=e.getSource();let o=t;let n=0;while(o&&!(o instanceof sap.m.ColumnListItem)&&n<5){o=o.getParent();n++}if(!o||!(o instanceof sap.m.ColumnListItem)){console.error("Could not find parent list item");return}const r=o.getBindingContext("viewModel");if(!r){console.error("No binding context found for related item");return}const s=r.getObject();const i=this.getModel("viewModel");const a=i.getProperty("/tableId");const l=i.getProperty("/entityId");console.log("Editing related item from parent:",a,l);this.getTableMetadata(a).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");sap.m.MessageBox.error("No relations defined for this entity");return}const t=e.relations[0];const o=t.table;console.log(`Relation found: ${o} with foreign key ${t.foreignKey}`);this.getTableMetadata(o).then(e=>{const n=e.primaryKey;const r=s[n];console.log(`Related item primary key: ${n}, value: ${r}`);const i={parentTable:a,parentId:l,isEditing:true,foreignKey:t.foreignKey,sourceView:"EntityDetail",timestamp:(new Date).getTime()};console.log("Setting parent info in session storage:",JSON.stringify(i,null,2));try{sessionStorage.removeItem("parentEntityInfo");sessionStorage.setItem("parentEntityInfo",JSON.stringify(i));console.log("Parent info successfully stored in session storage")}catch(e){console.error("Failed to store parent info in session storage:",e);sap.m.MessageBox.error("Failed to store navigation state. Back navigation may not work correctly.")}setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:o,id:r});console.log("Navigation to edit related item initiated")},100)})})},onDeleteRelatedItemPress:function(e){const t=e.getSource();const o=t.getParent().getParent();const n=o.getBindingContext("viewModel");if(!n){console.error("No binding context found for related item");return}const r=n.getObject();const s=this.getModel("viewModel");const i=s.getProperty("/tableId");console.log("Delete related item:",r);this.getTableMetadata(i).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const o=e.primaryKey;const n=r[o];console.log(`Confirming deletion of related item: ${t.table}/${n}`);this.showConfirmationDialog("Are you sure you want to delete this related item?",()=>{console.log(`Deleting related item: ${t.table}/${n}`);this.getSupabaseClient().from(t.table).delete().eq(o,n).then(({error:e})=>{if(e){console.error("Error deleting related item:",e);this.showErrorMessage("Error deleting related item",e);return}console.log("Related item deleted successfully");this._loadEntity(i,s.getProperty("/entityId"));this.showSuccessMessage("Related item deleted successfully")})},"Delete Confirmation")})})},onRelatedItemPress:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");console.log("Item pressed:",n);this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined for navigation");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const o=e.primaryKey;const r=n[o];console.log(`Navigating to related item details: ${t.table}/${r}`);this.getRouter().navTo("entityDetail",{table:t.table,id:r})})})},onRelatedItemsSearch:function(e){const t=e.getParameter("query").toLowerCase();const o=this.getModel("viewModel");const n=[...o.getProperty("/relatedItems")];if(!t){o.setProperty("/filteredRelatedItems",n);return}const r=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t));o.setProperty("/filteredRelatedItems",r)},resetFormErrorStates:function(){console.log("Resetting error states on all form fields");const e=[];this.getView().$().find(".sapMInputBase").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});this.getView().$().find(".sapMCb").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});this.getView().$().find(".sapMComboBox").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});console.log("Found",e.length,"controls to reset");e.forEach(e=>{if(e.setValueState){console.log("Resetting value state for",e.getId());e.setValueState("None");if(e.setValueStateText){e.setValueStateText("")}}});const t=this.getModel("viewModel");if(t){t.setProperty("/validationErrors",{})}console.log("Form error states reset complete")},_loadEntity:function(e,t){console.log("üîç ENTITY DEBUG: Starting _loadEntity method",{tableId:e,entityId:t});try{const o=this.getModel("viewModel");if(!o){console.error("üîç ENTITY DEBUG: viewModel not found!");return}o.setProperty("/busy",true);if(!this._oTableMetadata){console.log("üîç ENTITY DEBUG: No stored metadata, loading it now");this.getTableMetadata(e).then(o=>{console.log("üîç ENTITY DEBUG: Metadata loaded successfully");this._oTableMetadata=o;this._continueLoadingEntity(e,t,o)}).catch(e=>{console.error("üîç ENTITY DEBUG: Error loading metadata:",e);o.setProperty("/busy",false)})}else{console.log("üîç ENTITY DEBUG: Using stored metadata");this._continueLoadingEntity(e,t,this._oTableMetadata)}}catch(e){console.error("üîç ENTITY DEBUG: Critical error in _loadEntity:",e);try{const e=this.getModel("viewModel");if(e){e.setProperty("/busy",false)}}catch(e){console.error("üîç ENTITY DEBUG: Error resetting busy state:",e)}}},_continueLoadingEntity:function(e,t,o){console.log("üîç ENTITY DEBUG: Continuing entity loading with metadata");try{const n=this.getModel("viewModel");const r=o.primaryKey||`${e}_id`;console.log("üîç ENTITY DEBUG: Using primary key:",r);if(!r){console.error("üîç ENTITY DEBUG: No primary key defined in metadata");n.setProperty("/busy",false);return}if(!t){console.error("üîç ENTITY DEBUG: No entity ID specified");n.setProperty("/busy",false);return}if(!this.getSupabaseClient()){console.error("üîç ENTITY DEBUG: Supabase client not available");n.setProperty("/busy",false);return}console.log(`üîç ENTITY DEBUG: Building query: ${e}.select('*').eq('${r}', '${t}')`);this.getSupabaseClient().from(e).select("*").eq(r,t).single().then(async({data:e,error:t})=>{if(t){console.error("üîç ENTITY DEBUG: Error loading entity data:",t);n.setProperty("/busy",false);return}if(!e){console.error("üîç ENTITY DEBUG: No data found for entity");n.setProperty("/busy",false);return}console.log("üîç ENTITY DEBUG: Entity data loaded:",JSON.stringify(e,null,2));const s=o.columns.some(e=>e.name==="entity_id");if(s&&e.entity_id){try{console.log("üîç ENTITY DEBUG: Loading polymorphic entity data for entity_id:",e.entity_id);const{data:t,error:o}=await this.getSupabaseClient().from("entities").select("*").eq("entity_id",e.entity_id).single();if(!o&&t){console.log("üîç ENTITY DEBUG: Loaded entity data:",t);e.entity_data=t}}catch(e){console.error("üîç ENTITY DEBUG: Error loading entity data:",e)}}console.log("üîç ENTITY DEBUG: Processing relation fields");for(const t of o.columns){if(t.type==="relation"&&e[t.name]){const o=e[t.name];const n=t.relation;console.log(`üîç ENTITY DEBUG: Processing relation ${t.name} -> ${n} (ID: ${o})`);try{const r=await this.getTableMetadata(n);const s=r.primaryKey||`${n}_id`;console.log(`üîç ENTITY DEBUG: Loading related data from ${n} where ${s}=${o}`);const{data:i,error:a}=await this.getSupabaseClient().from(n).select("*").eq(s,o).single();if(!a&&i){const o=r.titleField||s;e[t.name+"_text"]=i[o];e[t.name+"_obj"]=i;console.log(`üîç ENTITY DEBUG: Loaded related text: ${e[t.name+"_text"]}`)}else if(a){console.error(`üîç ENTITY DEBUG: Error loading related data:`,a)}}catch(e){console.error(`üîç ENTITY DEBUG: Exception loading related data:`,e)}}}console.log("üîç ENTITY DEBUG: Setting entity data to model");n.setProperty("/entity",e);n.setProperty("/originalEntity",JSON.parse(JSON.stringify(e)));const i=o.titleField||r;const a=o.subtitleField;n.setProperty("/entityTitle",e[i]);if(a&&e[a]){n.setProperty("/entitySubtitle",e[a])}else{n.setProperty("/entitySubtitle","ID: "+e[r])}console.log("üîç ENTITY DEBUG: Configuring entity form");this._configureForm(o,e);console.log("üîç ENTITY DEBUG: Loading related items");this._loadRelatedItems(o,e)}).catch(e=>{console.error("üîç ENTITY DEBUG: Error in Supabase query:",e);n.setProperty("/busy",false)})}catch(e){console.error("üîç ENTITY DEBUG: Critical error in _continueLoadingEntity:",e);try{const e=this.getModel("viewModel");if(e){e.setProperty("/busy",false)}}catch(e){console.error("üîç ENTITY DEBUG: Error resetting busy state:",e)}}},_loadRelatedItems:function(e,t){console.log("üîç RELATED DEBUG: Starting _loadRelatedItems method");try{const o=this.getModel("viewModel");const n=o.getProperty("/tableId");const r=this.getView().byId("relatedItemsSection");if(r){r.setVisible(true)}const s=e.columns.some(e=>e.name==="entity_id");let i=null;if(s&&t.entity_id){i=t.entity_id;console.log("üîç RELATED DEBUG: Using polymorphic relationship via entity_id:",i)}const a=e.relations&&e.relations.length>0;if(!a&&!i){console.log("üîç RELATED DEBUG: No relations defined for table:",n);o.setProperty("/relatedItems",[]);o.setProperty("/filteredRelatedItems",[]);this._configureRelatedItemsTable(n);o.setProperty("/busy",false);return}const l=e.primaryKey||`${n}_id`;const c=t[l];if(!c&&!i){console.error("üîç RELATED DEBUG: Primary key value not found in entity data!");o.setProperty("/relatedItems",[]);o.setProperty("/filteredRelatedItems",[]);this._configureRelatedItemsTable(n);o.setProperty("/busy",false);return}let d=[];if(a){const t=e.relations[0];console.log(`üîç RELATED DEBUG: Loading standard relation data from ${t.table} where ${t.foreignKey}=${c}`);const o=this.getSupabaseClient().from(t.table).select("*").eq(t.foreignKey,c).then(({data:e,error:o})=>{if(o){console.error("üîç RELATED DEBUG: Error loading standard relation items:",o);return[]}const n=e||[];console.log(`üîç RELATED DEBUG: Loaded ${n.length} standard relation items`);return this._processRelatedItemsRelations(t.table,n)}).catch(e=>{console.error("üîç RELATED DEBUG: Error in standard relation query:",e);return[]});d.push(o)}if(i){console.log(`üîç RELATED DEBUG: Loading polymorphic relation data for entity_id ${i}`);const e=this.getSupabaseClient().from("notes").select("*").eq("entity_id",i).then(({data:e,error:t})=>{if(t){console.error("üîç RELATED DEBUG: Error loading notes:",t);return[]}const o=e||[];console.log(`üîç RELATED DEBUG: Loaded ${o.length} notes`);o.forEach(e=>{e._item_type="Note";e._relation_type="polymorphic"});return o}).catch(e=>{console.error("üîç RELATED DEBUG: Error in notes query:",e);return[]});d.push(e);const t=this.getSupabaseClient().from("files").select("*").eq("entity_id",i).then(({data:e,error:t})=>{if(t){console.error("üîç RELATED DEBUG: Error loading files:",t);return[]}const o=e||[];console.log(`üîç RELATED DEBUG: Loaded ${o.length} files`);o.forEach(e=>{e._item_type="File";e._relation_type="polymorphic"});return o}).catch(e=>{console.error("üîç RELATED DEBUG: Error in files query:",e);return[]});d.push(t);const o=this.getSupabaseClient().from("entity_tags").select("*, tags(*)").eq("entity_id",i).then(({data:e,error:t})=>{if(t){console.error("üîç RELATED DEBUG: Error loading entity_tags:",t);return[]}const o=e||[];console.log(`üîç RELATED DEBUG: Loaded ${o.length} entity_tags`);o.forEach(e=>{e._item_type="Tag";e._relation_type="polymorphic";if(e.tags){e.name=e.tags.name;e.category=e.tags.category;e.color=e.tags.color}});return o}).catch(e=>{console.error("üîç RELATED DEBUG: Error in entity_tags query:",e);return[]});d.push(o)}Promise.all(d).then(e=>{const t=[].concat(...e);console.log(`üîç RELATED DEBUG: Combined ${t.length} related items from all sources`);o.setProperty("/relatedItems",t);o.setProperty("/filteredRelatedItems",t);this._updateDeleteButtonState(t);this._configureRelatedItemsTable(n);o.setProperty("/busy",false);console.log("üîç RELATED DEBUG: Related items loading complete");return t}).catch(e=>{console.error("üîç RELATED DEBUG: Error loading related items:",e);o.setProperty("/busy",false);return[]})}catch(e){console.error("üîç RELATED DEBUG: Critical error in _loadRelatedItems:",e);const t=this.getModel("viewModel");if(t){t.setProperty("/busy",false)}return Promise.resolve([])}},_loadRelationOptionsForEdit:function(e,t,o){console.log(`Loading relation options for ${o} from table ${t}`);this.getTableMetadata(t).then(function(n){const r=n.primaryKey;const s=n.titleField||r;console.log(`Relation ${o}: Using primary key '${r}' and title field '${s}' from ${t}`);this.getSupabaseClient().from(t).select(`${r}, ${s}`).then(({data:t,error:i})=>{if(i){console.error(`Error loading relation options for ${o}:`,i);return}console.log(`Loaded ${t?t.length:0} relation options for ${o}`);e.removeAllItems();const a=n.columns.find(e=>e.name===o);if(a&&!a.required){e.addItem(new sap.ui.core.Item({key:"",text:"- None -"}))}if(t&&t.length>0){t.forEach(t=>{const o=t[r];const n=t[s]||o;e.addItem(new sap.ui.core.Item({key:o,text:n}));console.log(`Added relation option: key=${o}, text=${n}`)})}console.log(`Initial selected key for ${o}: ${e.getSelectedKey()}`)})}.bind(this)).catch(e=>{console.error(`Error getting metadata for relation ${o}:`,e)})},onNavBack:function(){console.log("Back button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");const n=()=>{let t=e.getProperty("/parentInfo");if(t&&t.parentTable&&t.parentId){console.log("Using parent info from view model");return t}if(this._parentInfoBackup&&this._parentInfoBackup.parentTable&&this._parentInfoBackup.parentId){console.log("Using parent info from backup");return this._parentInfoBackup}try{const e=sessionStorage.getItem("parentEntityInfo");if(e){const t=JSON.parse(e);if(t.parentTable&&t.parentId){console.log("Using parent info from session storage");return t}}}catch(e){console.error("Error retrieving parent info from session storage:",e)}return null};const r=n();if(r){console.log("Found valid parent info:",JSON.stringify(r,null,2));const e=r.parentTable;const t=r.parentId;setTimeout(()=>{console.log(`Navigating to parent entity: ${e}/${t}`);this.getRouter().navTo("entityDetail",{table:e,id:t});setTimeout(()=>{try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage after navigation")}catch(e){console.warn("Could not clear session storage after navigation:",e)}},300)},100)}else{console.log("No parent info, navigating to list view after back button");this.getRouter().navTo("entityList",{table:t});try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}}},_updateDeleteButtonState:function(e){let t=null;const o=this.getView().byId("ObjectPageLayout");if(o){const e=o.getHeaderTitle();if(e){const o=e.getActions()||[];for(let e=0;e<o.length;e++){const n=o[e];if(n.getIcon&&n.getIcon()==="sap-icon://delete"){t=n;break}}}}if(!t){t=this.getView().byId("deleteButton")}if(t){const o=e&&e.length>0;t.setEnabled(!o);if(o){t.setTooltip("Cannot delete while related items exist")}else{t.setTooltip("Delete this entity")}}},onEditPress:function(){console.log("Edit button pressed - fetching latest data from server");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");if(!o){this.showErrorMessage("Cannot edit: Missing entity ID");return}console.log("Fetching latest data for entity ID:",o);e.setProperty("/busy",true);this.getTableMetadata(t).then(n=>{const r=n.primaryKey;this.getSupabaseClient().from(t).select("*").eq(r,o).single().then(async({data:t,error:o})=>{e.setProperty("/busy",false);if(o){console.error("Error fetching latest entity data:",o);this.showErrorMessage("Error fetching latest data",o);return}if(!t){console.error("No data found for entity");this.showErrorMessage("Entity not found");return}console.log("Latest entity data fetched:",t);for(const e of n.columns){if(e.type==="relation"&&t[e.name]){const o=t[e.name];const n=e.relation;try{const r=await this.getTableMetadata(n);const s=r.primaryKey;const{data:i,error:a}=await this.getSupabaseClient().from(n).select("*").eq(s,o).single();if(!a&&i){const o=r.titleField||s;t[e.name+"_text"]=i[o];t[e.name+"_obj"]=i}}catch(e){console.error("Error loading related data",e)}}}e.setProperty("/entity",t);e.setProperty("/originalEntity",JSON.parse(JSON.stringify(t)));this._openEditDialogWithFreshData(n,t)}).catch(t=>{console.error("Error in Supabase query:",t);this.showErrorMessage("Error fetching latest data: "+t.message);e.setProperty("/busy",false)})}).catch(t=>{console.error("Error getting table metadata:",t);this.showErrorMessage("Error getting table metadata: "+t.message);e.setProperty("/busy",false)})},_openEditDialogWithFreshData:function(e,t){const o=new sap.m.Dialog({title:"Edit "+this.getModel("viewModel").getProperty("/tableName"),contentWidth:"40rem",content:[new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,columnsXL:1,columnsL:1,content:this._createEditFormContent(e,t)})],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){let n=true;this._editControls=this._editControls||{};Object.values(this._editControls).forEach(function(e){if(e.setValueState){e.setValueState("None")}});n=this._validateEditForm(e);if(!n){sap.m.MessageToast.show("Please correct the errors before saving");return}const r=JSON.parse(JSON.stringify(t));e.columns.forEach(t=>{if(t.editable===false||!t.visible||t.name===e.primaryKey||t.name==="created_at"||t.name==="updated_at"){return}const o=this._editControls[t.name];if(!o)return;if(o instanceof sap.m.CheckBox){r[t.name]=o.getSelected()}else if(o instanceof sap.m.DatePicker){r[t.name]=o.getValue()}else if(o.getValue){r[t.name]=o.getValue()}});if(this._areObjectsEqual(r,t)){sap.m.MessageBox.information("No changes were made to this record.",{title:"No Changes",onClose:function(){o.close()}});return}this._saveEntity(this.getModel("viewModel").getProperty("/tableId"),this.getModel("viewModel").getProperty("/entityId"),e,r);o.close()}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){o.close()}}),afterClose:function(){o.destroy();this._editControls=null}.bind(this)});this.getView().addDependent(o);o.open()},_loadNotesAndFiles:function(e,t){console.log("Loading notes and files for entity:",e,t);const o=this.getModel("viewModel");if(!o.getProperty("/notes")){o.setProperty("/notes",[])}if(!o.getProperty("/files")){o.setProperty("/files",[])}const n=e.replace(/_$/,"");this.getSupabaseClient().from("notes").select("*").eq("entity_id",t).eq("entity_type",n).order("created_at",{ascending:false}).then(({data:e,error:t})=>{if(t){console.error("Error loading notes:",t);return}o.setProperty("/notes",e||[]);console.log(`Loaded ${e?.length||0} notes`)});this.getSupabaseClient().from("files").select("*").eq("entity_id",t).eq("entity_type",n).order("created_at",{ascending:false}).then(({data:e,error:t})=>{if(t){console.error("Error loading files:",t);return}o.setProperty("/files",e||[]);console.log(`Loaded ${e?.length||0} files`)})},onAddNote:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const r=e.getProperty("/entityId");if(!this._oNoteDialog){this._oNoteDialog=new o({title:"Add Note",contentWidth:"600px",content:[new m({items:[new p({text:"Title",required:true}),new s({id:this.createId("noteTitle"),width:"100%"}),new p({text:"Content",required:true}),new i({id:this.createId("noteContent"),width:"100%",rows:6,growing:true}),new p({text:"Category"}),new a({id:this.createId("noteCategory"),width:"100%",items:[new E({key:"general",text:"General"}),new E({key:"meeting",text:"Meeting"}),new E({key:"task",text:"Task"}),new E({key:"reminder",text:"Reminder"})]}),new l({id:this.createId("notePrivate"),text:"Private Note",selected:false})]}).addStyleClass("sapUiMediumMargin")],beginButton:new n({text:"Save",type:"Emphasized",press:this._saveNote.bind(this)}),endButton:new n({text:"Cancel",press:function(){this._oNoteDialog.close()}.bind(this)}),afterClose:function(){this.byId("noteTitle").setValue("");this.byId("noteContent").setValue("");this.byId("noteCategory").setSelectedKey("general");this.byId("notePrivate").setSelected(false)}.bind(this)});this.getView().addDependent(this._oNoteDialog)}this._oNoteDialog.open()},_saveNote:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");const n=t.replace(/_$/,"");const r=this.byId("noteTitle").getValue();const s=this.byId("noteContent").getValue();const i=this.byId("noteCategory").getSelectedKey();const a=this.byId("notePrivate").getSelected();if(!r||!s){c.error("Please enter both title and content for the note.");return}const l={entity_id:o,entity_type:n,title:r,note:s,category:i||"general",is_private:a,created_by:"Current User",created_at:(new Date).toISOString()};this.getSupabaseClient().from("notes").insert(l).then(({data:e,error:n})=>{if(n){console.error("Error saving note:",n);c.error("Failed to save note: "+n.message);return}d.show("Note saved successfully");this._oNoteDialog.close();this._loadNotesAndFiles(t,o)}).catch(e=>{console.error("Error in Supabase query:",e);c.error("Failed to save note.")})},onEditNote:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");const n=o.getObject();this._openNoteEditDialog(n)},onDeleteNote:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");const n=o.getObject();c.confirm("Are you sure you want to delete this note?",{title:"Delete Confirmation",actions:[c.Action.YES,c.Action.NO],onClose:e=>{if(e===c.Action.YES){this._deleteNote(n.note_id)}}})},onEditFile:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");const n=o.getObject();this._openFileEditDialog(n)},_openNoteEditDialog:function(e){if(!this._oNoteEditDialog){this._oNoteEditDialog=new o({title:"Edit Note",contentWidth:"600px",content:[new m({items:[new p({text:"Title",required:true}),new s({id:this.createId("editNoteTitle"),width:"100%"}),new p({text:"Content",required:true}),new i({id:this.createId("editNoteContent"),width:"100%",rows:6,growing:true}),new p({text:"Category"}),new a({id:this.createId("editNoteCategory"),width:"100%",items:[new E({key:"general",text:"General"}),new E({key:"meeting",text:"Meeting"}),new E({key:"task",text:"Task"}),new E({key:"reminder",text:"Reminder"})]}),new l({id:this.createId("editNotePrivate"),text:"Private Note",selected:false})]}).addStyleClass("sapUiMediumMargin")],beginButton:new n({text:"Save Changes",type:"Emphasized",press:()=>{this._updateNote(e.note_id)}}),endButton:new n({text:"Cancel",press:()=>{this._oNoteEditDialog.close()}})});this.getView().addDependent(this._oNoteEditDialog)}this.byId("editNoteTitle").setValue(e.title);this.byId("editNoteContent").setValue(e.note);this.byId("editNoteCategory").setSelectedKey(e.category||"general");this.byId("editNotePrivate").setSelected(e.is_private||false);this._oNoteEditDialog.open()},_deleteNote:function(e){const t=this.getModel("viewModel");const o=t.getProperty("/tableId");const n=t.getProperty("/entityId");this.getSupabaseClient().from("notes").delete().eq("note_id",e).then(({error:e})=>{if(e){console.error("Error deleting note:",e);c.error("Failed to delete note: "+e.message);return}d.show("Note deleted successfully");this._loadNotesAndFiles(o,n)}).catch(e=>{console.error("Error in Supabase query:",e);c.error("Failed to delete note.")})},_deleteFile:function(e){const t=this.getModel("viewModel");const o=t.getProperty("/tableId");const n=t.getProperty("/entityId");this.getSupabaseClient().from("files").delete().eq("file_id",e).then(({error:e})=>{if(e){console.error("Error deleting file:",e);c.error("Failed to delete file: "+e.message);return}d.show("File deleted successfully");this._loadNotesAndFiles(o,n)}).catch(e=>{console.error("Error in Supabase query:",e);c.error("Failed to delete file.")})},formatFileSize:function(e){if(!e)return"0 B";if(e<1024){return Math.round(e)+" KB"}else if(e<1024*1024){return(e/1024).toFixed(1)+" MB"}else{return(e/(1024*1024)).toFixed(1)+" GB"}},formatDate:function(e){if(!e)return"";const t=new Date(e);const o=new Date;const n=o-t;const r=Math.round(n/6e4);const s=Math.round(n/36e5);const i=Math.round(n/864e5);if(r<1){return"just now"}else if(r<60){return r+" mins ago"}else if(s<24){return s+" hours ago"}else if(i===1){return"yesterday"}else if(i<7){return i+" days ago"}else{return t.toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}},formatCategory:function(e){if(!e)return"";const t={general:"General",meeting:"Meeting",task:"Task",reminder:"Reminder",document:"Document",image:"Image",spreadsheet:"Spreadsheet",presentation:"Presentation",other:"Other"};return t[e]||e.charAt(0).toUpperCase()+e.slice(1)},isPrivateNote:function(e){return!!e},hasNoNotes:function(e){return!e||e.length===0},_createEntityWithNotesFiles:function(e,t){const o=e.replace(/_$/,"");return this.getSupabaseClient().from("entities").insert({entity_type:o,name:t.name||t[Object.keys(t)[1]],description:t.description||""}).select().then(({data:o,error:n})=>{if(n)throw new Error("Failed to create entity record");const r=o[0].entity_id;const s={...t,entity_id:r};return this.getSupabaseClient().from(e).insert(s).select().then(({data:e,error:t})=>{if(t){this.getSupabaseClient().from("entities").delete().eq("entity_id",r);throw t}return e})})},_uploadFile:function(e){const t=this.getSupabaseClient();const o=this.getModel("viewModel");const n=o.getProperty("/entityId");const r=o.getProperty("/tableName");if(!e||!n){sap.m.MessageToast.show("Invalid file or entity");return}let s=r.toLowerCase();if(s.endsWith("s")){s=s.slice(0,-1)}const i=Date.now();const a=e.name;const l=a.split(".").pop().toLowerCase();const c=`${s}_${n}_${i}.${l}`;o.setProperty("/uploadingFile",true);const d=async()=>{try{console.log("Uploading file:",a,"as:",c);const s="uploads";const{data:i,error:d}=await t.storage.from(s).upload(c,e,{cacheControl:"3600",upsert:true});if(d){console.error("Storage upload error:",d);if(d.message&&d.message.includes("bucket")){throw new Error(`Storage bucket '${s}' not found. Please create it in Supabase Storage.`)}throw d}console.log("File uploaded to storage:",i);const{data:g}=t.storage.from(s).getPublicUrl(c);const u={entity_id:n,entity_type:r.toLowerCase(),file_name:a,original_name:a,file_type:l,file_size:Math.round(e.size/1024),mime_type:e.type||"application/octet-stream",storage_path:`${s}/${c}`,public_url:g?.publicUrl||null,description:"",category:"document",is_private:false,uploaded_by:"system"};console.log("Inserting file metadata:",u);const{data:f,error:p}=await t.from("files").insert(u).select().single();if(p){console.error("Database error:",p);try{await t.storage.from(s).remove([c])}catch(e){console.error("Cleanup error:",e)}throw p}console.log("File metadata saved:",f);const y=o.getProperty("/files")||[];y.unshift(f);o.setProperty("/files",y);sap.m.MessageToast.show("File uploaded successfully")}catch(e){console.error("Error uploading file:",e);let t="Error uploading file: ";if(e.message){t+=e.message}else if(e.code){t+=e.code}else{t+="Unknown error"}sap.m.MessageToast.show(t)}finally{o.setProperty("/uploadingFile",false)}};d()},onAddFile:function(){const e=document.createElement("input");e.type="file";e.onchange=e=>{const t=e.target.files;if(t&&t.length>0){const e=t[0];const o=10*1024*1024;if(e.size>o){sap.m.MessageToast.show("File size exceeds 10MB limit");return}this._uploadFile(e)}};e.click()},onViewFile:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");const n=o.getObject();if(n.public_url){window.open(n.public_url,"_blank")}else if(n.storage_path){const e=this.getSupabaseClient();const[t,...o]=n.storage_path.split("/");const r=o.join("/");e.storage.from(t).createSignedUrl(r,3600).then(({data:e,error:t})=>{if(t){console.error("Error creating signed URL:",t);sap.m.MessageToast.show("Unable to view file")}else if(e?.signedUrl){window.open(e.signedUrl,"_blank")}})}else{sap.m.MessageToast.show("File URL not available")}},onDeleteFile:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");const n=o.getObject();sap.m.MessageBox.confirm("Are you sure you want to delete this file?",{actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],onClose:async e=>{if(e===sap.m.MessageBox.Action.YES){try{const e=this.getSupabaseClient();if(n.storage_path){const[t,...o]=n.storage_path.split("/");const r=o.join("/");const{error:s}=await e.storage.from(t).remove([r]);if(s){console.error("Error deleting from storage:",s)}}const{error:t}=await e.from("files").delete().eq("file_id",n.file_id);if(t){throw t}const o=this.getModel("viewModel");const r=o.getProperty("/files");const s=r.findIndex(e=>e.file_id===n.file_id);if(s>-1){r.splice(s,1);o.setProperty("/files",r)}sap.m.MessageToast.show("File deleted successfully")}catch(e){console.error("Error deleting file:",e);sap.m.MessageToast.show("Error deleting file: "+e.message)}}}})}})});
//# sourceMappingURL=EntityDetail.controller.js.map