sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Text","sap/m/Input","sap/m/Label","sap/m/Column","sap/m/ColumnListItem"],function(e,t,o,n,r,s,a){"use strict";return e.extend("com.supabase.easyui5.controller.EntityDetail",{formatter:{formatDate:function(e){if(!e){return""}return new Date(e).toLocaleDateString()},formatBoolean:function(e){return e?"Yes":"No"},formatNumber:function(e){if(e===undefined||e===null){return""}return parseFloat(e).toFixed(2)}},onInit:function(){console.log("EntityDetail controller initialized");const e=new t({tableName:"",tableId:"",entityId:"",entityTitle:"",entitySubtitle:"",entity:{},originalEntity:{},relatedItems:[],filteredRelatedItems:[],editMode:false,busy:false,delay:0,validationErrors:{},parentInfo:null});this.setModel(e,"viewModel");this.getRouter().getRoute("entityDetail").attachPatternMatched(this._onRouteMatched,this);this._loadParentInfoForEdit();try{this._registerExtensions()}catch(e){console.error("Could not register extensions:",e)}},_loadParentInfoForEdit:function(){try{const e=sessionStorage.getItem("parentEntityInfo");console.log("Checking for parent info in detail view:",e);if(e){const t=JSON.parse(e);console.log("Found parent info:",JSON.stringify(t,null,2));const o=t.timestamp&&(new Date).getTime()-t.timestamp<5*60*1e3;const n=this.getModel("viewModel");n.setProperty("/parentInfo",t);this._parentInfoBackup=JSON.parse(JSON.stringify(t));console.log("Parent info stored in view model and backup created");console.log("Parent entity:",t.parentTable,t.parentId);console.log("Is editing:",t.isEditing);console.log("Foreign key:",t.foreignKey);console.log("Info freshness:",o?"Fresh":"Stale")}else{console.log("No parent info found in session storage")}}catch(e){console.error("Error parsing parent entity info:",e)}},_registerExtensions:function(){console.log("Registering controller extensions");try{sap.ui.require(["com/supabase/easyui5/controller/EntityDetailExtensions.controller"],function(e){if(e){const t=e();console.log("Extensions loaded successfully");if(t.form&&t.form._configureForm){this._configureForm=t.form._configureForm.bind(this)}if(t.relatedItems&&t.relatedItems._loadRelatedItems){this._loadRelatedItems=t.relatedItems._loadRelatedItems.bind(this)}if(t.actions){if(t.actions.onSavePress){this.onSavePress=t.actions.onSavePress.bind(this)}if(t.actions.onCancelPress){this.onCancelPress=t.actions.onCancelPress.bind(this)}if(t.actions.onEditPress){this.onEditPress=t.actions.onEditPress.bind(this)}}}}.bind(this))}catch(e){console.error("Error registering extensions:",e)}},_onRouteMatched:function(e){console.log("ðŸ” ROUTE DEBUG: EntityDetail route matched event fired");try{const t=e.getParameter("arguments").table;const o=e.getParameter("arguments").id;console.log("ðŸ” ROUTE DEBUG: Parameters - Table ID:",t,"Entity ID:",o);console.log("ðŸ” ROUTE DEBUG: View available?",!!this.getView());const n=this.getModel("viewModel");if(!n){console.error("ðŸ” ROUTE DEBUG: viewModel not found! Creating a new one.");const e=new sap.ui.model.json.JSONModel({tableName:"",tableId:"",entityId:"",entityTitle:"",entitySubtitle:"",entity:{},originalEntity:{},relatedItems:[],filteredRelatedItems:[],editMode:false,busy:false,delay:0,validationErrors:{}});this.setModel(e,"viewModel")}const r=this.getModel("viewModel");console.log("ðŸ” ROUTE DEBUG: Setting properties in viewModel");r.setProperty("/tableId",t);r.setProperty("/entityId",o);const s=t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ");r.setProperty("/tableName",s);r.setProperty("/validationErrors",{});r.setProperty("/editMode",false);r.setProperty("/busy",true);r.setProperty("/relatedItems",[]);r.setProperty("/filteredRelatedItems",[]);console.log("ðŸ” ROUTE DEBUG: Checking for relatedItemsTable in view");const a=this.getView().byId("relatedItemsTable");console.log("ðŸ” ROUTE DEBUG: Table found?",!!a);if(a){console.log("ðŸ” ROUTE DEBUG: Current table binding:",a.isBound("items")?"Bound":"Not bound");if(a.isBound("items")){const e=a.getBinding("items");console.log("ðŸ” ROUTE DEBUG: Current binding path:",e?e.getPath():"unknown")}console.log("ðŸ” ROUTE DEBUG: Pre-initializing table with empty template");try{if(!a.getBindingInfo("items")||!a.getBindingInfo("items").template){const e=new sap.m.ColumnListItem;a.bindItems({path:"viewModel>/filteredRelatedItems",template:e});console.log("ðŸ” ROUTE DEBUG: Applied temporary binding with empty template")}}catch(e){console.error("ðŸ” ROUTE DEBUG: Error applying temporary binding:",e)}}console.log("ðŸ” ROUTE DEBUG: Pre-initializing related items table");this._configureRelatedItemsTable(t);console.log("ðŸ” ROUTE DEBUG: Getting table metadata");this.getTableMetadata(t).then(e=>{console.log("ðŸ” ROUTE DEBUG: Metadata loaded successfully");this._oTableMetadata=e;console.log("ðŸ” ROUTE DEBUG: Now loading entity data");this._loadEntity(t,o)}).catch(e=>{console.error("ðŸ” ROUTE DEBUG: Error loading metadata:",e);console.error("ðŸ” ROUTE DEBUG: Error stack:",e.stack);r.setProperty("/busy",false)})}catch(e){console.error("ðŸ” ROUTE DEBUG: Critical error in _onRouteMatched:",e);console.error("ðŸ” ROUTE DEBUG: Error stack:",e.stack);try{const e=this.getModel("viewModel");if(e){e.setProperty("/busy",false)}}catch(e){console.error("ðŸ” ROUTE DEBUG: Error resetting busy state:",e)}}},_configureForm:function(e,t){try{console.log("Finding suitable container for entity details");let n=null;n=this.getView().byId("detailContentArea")||this.getView().byId("entityDetailsContainer");if(!n){const e=this.getView().getControlsByType("sap.uxap.ObjectPageSubSection");if(e&&e.length>0){n=e[0];console.log("Using ObjectPageSubSection as container")}}if(!n){const e=this.getView().getControlsByType("sap.ui.layout.form.SimpleForm")||this.getView().getControlsByType("sap.ui.layout.form.Form")||this.getView().getControlsByType("sap.m.VBox")||this.getView().getControlsByType("sap.m.Panel");if(e&&e.length>0){n=e[0];console.log("Using layout container:",n.getMetadata().getName())}}if(!n){const e=this.getView().getControlsByType("sap.m.Page")[0]||this.getView().getControlsByType("sap.uxap.ObjectPageLayout")[0];if(e){if(e.getContent&&e.addContent){n=e;console.log("Using page as container")}}}if(!n){console.error("Could not find any suitable container for entity details");return}const s=new sap.ui.layout.Grid({defaultSpan:"XL4 L4 M6 S12",vSpacing:1,hSpacing:1,width:"100%"});e.columns.forEach(e=>{if(!e.visible)return;const n=new sap.m.VBox({width:"100%",alignItems:"Start"});n.addItem(new r({text:e.label,design:"Bold",width:"100%"}).addStyleClass("sapUiTinyMarginBottom"));let a;switch(e.type){case"relation":a=new o({text:t[e.name+"_text"]||t[e.name]||""});break;case"boolean":a=new o({text:t[e.name]?"Yes":"No"});break;case"date":a=new o({text:t[e.name]?new Date(t[e.name]).toLocaleDateString():""});break;case"number":a=new o({text:t[e.name]!==undefined?parseFloat(t[e.name]).toFixed(2):""});break;default:a=new o({text:t[e.name]||""})}a.addStyleClass("sapUiTinyMarginTop");a.setWidth("100%");n.addItem(a);s.addContent(n.addStyleClass("sapUiSmallMargin"))});const a=new sap.m.Panel({headerText:"Details",expandable:false,expanded:true,backgroundDesign:"Solid",content:[s]});if(n.removeAllContent){n.removeAllContent();n.addContent(a)}else if(n.removeAllItems){n.removeAllItems();n.addItem(a)}else if(n.removeAllFormElements){n.removeAllFormElements();const e=new sap.ui.layout.form.FormElement;e.addField(a);n.addFormElement(e)}else if(n.addContent){n.addContent(a)}else{console.error("Container doesn't have a method to add content:",n)}console.log("Entity details added to container")}catch(e){console.error("Error in dynamic _configureForm:",e)}},_configureRelatedItemsTable:function(e){console.log("ðŸ” TABLE DEBUG: Started _configureRelatedItemsTable for table:",e);try{const t=this.getView().byId("relatedItemsTable");console.log("ðŸ” TABLE DEBUG: Found table?",!!t,"Table ID:",t?t.getId():"null");if(!t){console.error("ðŸ” TABLE DEBUG: Related items table not found in the view! Check ID in XML");return}const o=t.getBindingInfo("items");console.log("ðŸ” TABLE DEBUG: Current binding info:",o);console.log("ðŸ” TABLE DEBUG: Existing columns count:",t.getColumns().length);t.removeAllColumns();console.log("ðŸ” TABLE DEBUG: Removed all columns");this.getTableMetadata(e).then(o=>{console.log("ðŸ” TABLE DEBUG: Got metadata for table",e,":",JSON.stringify(o,null,2));const n=o.columns.filter(e=>e.visible).slice(0,5);console.log("ðŸ” TABLE DEBUG: Visible columns:",n.length);n.forEach((e,o)=>{console.log(`ðŸ” TABLE DEBUG: Adding column ${o+1}:`,e.name);t.addColumn(new sap.m.Column({header:new sap.m.Label({text:e.label})}))});console.log("ðŸ” TABLE DEBUG: Adding actions column");t.addColumn(new sap.m.Column({header:new sap.m.Label({text:"Actions"}),hAlign:"Right"}));console.log("ðŸ” TABLE DEBUG: Finished adding columns, total:",t.getColumns().length);console.log("ðŸ” TABLE DEBUG: Creating template for binding");const r=new sap.m.ColumnListItem({type:"Navigation",press:this.onRelatedItemPress.bind(this)});n.forEach((e,t)=>{console.log(`ðŸ” TABLE DEBUG: Adding cell ${t+1} for column:`,e.name);let o;switch(e.type){case"relation":o=new sap.m.Text({text:"{viewModel>"+e.name+"_text}"});break;case"boolean":o=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:this.formatter.formatBoolean}});break;case"date":o=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:this.formatter.formatDate}});break;case"number":o=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:this.formatter.formatNumber}});break;default:o=new sap.m.Text({text:"{viewModel>"+e.name+"}"})}r.addCell(o)});console.log("ðŸ” TABLE DEBUG: Adding actions cell to template");const s=new sap.m.HBox({justifyContent:"End",items:[new sap.m.Button({icon:"sap-icon://edit",type:"Transparent",tooltip:"Edit",press:this.onEditRelatedItemPress.bind(this)}),new sap.m.Button({icon:"sap-icon://delete",type:"Transparent",tooltip:"Delete",press:this.onDeleteRelatedItemPress.bind(this)})]});r.addCell(s);console.log("ðŸ” TABLE DEBUG: Template created with cells:",r.getCells().length);const a=this.getModel("viewModel");const i=a.getProperty("/filteredRelatedItems")||[];console.log("ðŸ” TABLE DEBUG: Current data in model:",JSON.stringify(i));try{console.log("ðŸ” TABLE DEBUG: About to bind items to table");const e={path:"viewModel>/filteredRelatedItems",template:r};console.log("ðŸ” TABLE DEBUG: Binding settings:",JSON.stringify(e,function(e,t){if(e==="template")return"[Template Object]";return t}));if(t.isBound("items")){console.log("ðŸ” TABLE DEBUG: Unbinding existing items");t.unbindItems()}t.bindItems(e);console.log("ðŸ” TABLE DEBUG: Items bound successfully");const o=t.getBindingInfo("items");console.log("ðŸ” TABLE DEBUG: New binding info path:",o?o.path:"none","Has template:",!!o&&!!o.template)}catch(e){console.error("ðŸ” TABLE DEBUG: Error during item binding:",e);console.error("ðŸ” TABLE DEBUG: Error stack:",e.stack)}console.log("ðŸ” TABLE DEBUG: Table configuration completed");t.invalidate();console.log("ðŸ” TABLE DEBUG: Table invalidated for re-rendering")}).catch(e=>{console.error("ðŸ” TABLE DEBUG: Error getting metadata:",e);console.error("ðŸ” TABLE DEBUG: Error stack:",e.stack)})}catch(e){console.error("ðŸ” TABLE DEBUG: Critical error in _configureRelatedItemsTable:",e);console.error("ðŸ” TABLE DEBUG: Error stack:",e.stack)}},onToggleNav:function(){try{const e=this.getOwnerComponent().getSplitApp();if(!e){console.error("SplitApp control not found!");return}const t=this.getOwnerComponent().getModel("appView");if(!t){console.error("AppView model not found!");return}const o=t.getProperty("/navExpanded");const n=this.getView().byId("navToggleButton");if(o){e.hideMaster();if(n){n.setIcon("sap-icon://menu2");n.setTooltip("Show Navigation")}t.setProperty("/navExpanded",false)}else{e.showMaster();if(n){n.setIcon("sap-icon://navigation-left-arrow");n.setTooltip("Hide Navigation")}t.setProperty("/navExpanded",true)}}catch(e){console.error("Error in menu toggle:",e)}},_createEditFormContent:function(e,t){const o=[];this._editControls={};e.columns.forEach(n=>{if(n.editable===false||!n.visible||n.name===e.primaryKey||n.name==="created_at"||n.name==="updated_at"){return}o.push(new sap.m.Label({text:n.label,required:n.required===true}));let r;switch(n.type){case"relation":r=new sap.m.ComboBox({selectedKey:t[n.name],required:n.required===true,showSecondaryValues:true});this._loadRelationOptionsForEdit(r,n.relation,n.name);break;case"boolean":r=new sap.m.CheckBox({selected:t[n.name]===true});break;case"date":r=new sap.m.DatePicker({value:t[n.name]?new Date(t[n.name]).toISOString().split("T")[0]:null,valueFormat:"yyyy-MM-dd",displayFormat:"medium",required:n.required===true,change:function(e){if(e.getParameter("valid")){e.getSource().setValueState("None")}else{e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid date")}}});break;case"number":r=new sap.m.Input({value:t[n.name],type:"Number",required:n.required===true,liveChange:function(e){const t=e.getParameter("value");if(t&&isNaN(parseFloat(t))){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid number")}else{e.getSource().setValueState("None")}}});break;case"email":r=new sap.m.Input({value:t[n.name],type:"Email",required:n.required===true,liveChange:function(e){const t=e.getParameter("value");const o=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(t&&!o.test(t)){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid email address")}else{e.getSource().setValueState("None")}}});break;case"url":r=new sap.m.Input({value:t[n.name],type:"Url",required:n.required===true,liveChange:function(e){const t=e.getParameter("value");const o=/^(http|https):\/\/[^ "]+$/;if(t&&!o.test(t)){e.getSource().setValueState("Error");e.getSource().setValueStateText("Please enter a valid URL (starting with http:// or https://)")}else{e.getSource().setValueState("None")}}});break;case"text":r=new sap.m.TextArea({value:t[n.name],rows:3,required:n.required===true});break;default:r=new sap.m.Input({value:t[n.name],required:n.required===true})}this._editControls[n.name]=r;o.push(r)});return o},_validateEditForm:function(e){let t=true;e.columns.forEach(o=>{if(o.editable===false||!o.visible||o.name===e.primaryKey||o.name==="created_at"||o.name==="updated_at"){return}const n=this._editControls[o.name];if(!n)return;if(n.setValueState){n.setValueState("None");if(n.setValueStateText){n.setValueStateText("")}}let r;if(n instanceof sap.m.CheckBox){r=n.getSelected()}else if(n.getValue){r=n.getValue()}if(o.required===true&&(r===undefined||r===null||r==="")){t=false;if(n.setValueState){n.setValueState("Error");if(n.setValueStateText){n.setValueStateText("This field is required")}}console.log("Validation failed for",o.name,": Required field is empty");return}if(r===undefined||r===null||r===""){return}let s=true;let a="";switch(o.type){case"number":if(isNaN(parseFloat(r))||!isFinite(r)){s=false;a="Please enter a valid number"}break;case"date":const e=new Date(r);if(isNaN(e.getTime())){s=false;a="Please enter a valid date"}break;case"email":const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!t.test(r)){s=false;a="Please enter a valid email address"}break;case"url":const o=/^(http|https):\/\/[^ "]+$/;if(!o.test(r)){s=false;a="Please enter a valid URL (starting with http:// or https://)"}break}if(!s){t=false;if(n.setValueState){n.setValueState("Error");if(n.setValueStateText){n.setValueStateText(a)}}console.log("Validation failed for",o.name,":",a)}});return t},_areObjectsEqual:function(e,t){if(e===t)return true;if(!e||!t)return false;const o=[...new Set([...Object.keys(e),...Object.keys(t)])];const n=["created_at","updated_at"];for(const r of o){if(n.includes(r))continue;const o=e[r];const s=t[r];if(typeof o==="object"&&typeof s==="object"&&o!==null&&s!==null){if(!this._areObjectsEqual(o,s))return false}else if(o instanceof Date&&s instanceof Date){if(o.getTime()!==s.getTime())return false}else if((o===null||o===undefined)&&(s===null||s===undefined)){continue}else if(o!==s){return false}}return true},_saveEntity:function(e,t,o,n){const r=this.getModel("viewModel");r.setProperty("/busy",true);if(typeof t==="object"||!t){console.log("Entity ID is not a string, getting from model");t=r.getProperty("/entityId");if(!t){this.showErrorMessage("Error: Missing entity ID for update operation");r.setProperty("/busy",false);return}}console.log("Using Entity ID for update:",t,"Type:",typeof t);if(!e){console.error("Missing table ID for _saveEntity");r.setProperty("/busy",false);this.showErrorMessage("Error updating entity: Missing table ID");return}const s=n||r.getProperty("/entity");if(!s){console.error("No entity data available for saving");r.setProperty("/busy",false);this.showErrorMessage("Error updating entity: No data available");return}this.getTableMetadata(e).then(o=>{if(!o||!o.columns){throw new Error("Invalid metadata structure - missing columns")}console.log("Using metadata for save:",o);const n={};const r=o.primaryKey;if(!r){throw new Error("No primary key defined in metadata")}console.log("Using primary key for update:",r);const a=async()=>{const e=[];for(const t of o.columns){if(t.editable===false&&t.name!==r||t.name===r){continue}if(t.type==="relation"){const o=t.name;let r=s[o];console.log(`Processing relation field ${o}, current value:`,r,typeof r);if(r&&(isNaN(Number(r))||typeof r==="string"&&r.includes(" "))){const s=this._resolveRelationKey(t.relation,r).then(e=>{if(e!==null){console.log(`Resolved relation key for ${o}: ${e}`);n[o]=e}else{console.log(`Could not resolve relation key for ${o}, using original value`);n[o]=r}});e.push(s)}else{if(typeof r==="string"&&!isNaN(parseInt(r))){r=parseInt(r)}n[o]=r;console.log(`Using relation value for ${o}:`,r,typeof r)}}else{n[t.name]=s[t.name]}}await Promise.all(e)};return a().then(()=>{const s=o.columns.some(e=>e.name==="updated_at");if(s){n["updated_at"]=(new Date).toISOString()}console.log("Final data to update:",n);console.log("Table ID:",e);console.log("Entity ID:",t,"Type:",typeof t);return this.getSupabaseClient().from(e).update(n).eq(r,t).then(({data:e,error:t})=>{if(t){throw t}return e})})}).then(o=>{r.setProperty("/busy",false);r.setProperty("/editMode",false);this.showSuccessMessage("Entity updated successfully");this._loadEntity(e,t)}).catch(e=>{console.error("Error updating entity:",e);this.showErrorMessage("Error updating entity: "+(e.message||JSON.stringify(e)));r.setProperty("/busy",false)})},_resolveRelationKey:function(e,t){console.log(`Trying to resolve relation key for ${e} with display value: "${t}"`);return this.getTableMetadata(e).then(o=>{const n=o.primaryKey;const r=o.titleField||n;console.log(`Using primary key ${n} and title field ${r} for relation resolution`);return this.getSupabaseClient().from(e).select(n).eq(r,t).then(({data:o,error:r})=>{if(r){console.error(`Error querying relation ${e}:`,r);return null}if(o&&o.length>0){console.log(`Found exact match for ${t} in ${e}:`,o[0][n]);return o[0][n]}const s=extractNumberFromString(t);if(s!==null){console.log(`Extracted potential key ${s} from "${t}"`);return this.getSupabaseClient().from(e).select(n).eq(n,s).then(({data:t,error:o})=>{if(o){console.error(`Error verifying key ${s}:`,o);return null}if(t&&t.length>0){console.log(`Verified key ${s} exists in ${e}`);return s}console.log(`Could not verify key ${s} in ${e}`);return null})}console.log(`No relation key found for ${t} in ${e}`);return null})}).catch(e=>{console.error(`Error resolving relation key:`,e);return null})},extractNumberFromString(e){if(!e||typeof e!=="string")return null;const t=e.match(/\d+/g);if(t&&t.length>0){return parseInt(t[t.length-1],10)}return null},onDeletePress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");const n=e.getProperty("/tableName");const r=e.getProperty("/relatedItems")||[];if(r&&r.length>0){sap.m.MessageBox.error("Cannot delete this "+e.getProperty("/tableName")+" because it has related items. Please delete all related items first.",{title:"Delete Not Allowed"});return}sap.m.MessageBox.confirm("Are you sure you want to delete this "+n+"?",{title:"Delete Confirmation",onClose:function(e){if(e===sap.m.MessageBox.Action.OK){this._deleteEntity(t,o)}}.bind(this),styleClass:this.getOwnerComponent().getContentDensityClass()})},_deleteEntity:function(e,t){const o=this.getModel("viewModel");o.setProperty("/busy",true);this.getTableMetadata(e).then(n=>{const r=n.primaryKey;this.getSupabaseClient().from(e).delete().eq(r,t).then(({error:t})=>{o.setProperty("/busy",false);if(t){this.showErrorMessage("Error deleting entity",t);return}const n=o.getProperty("/tableName");this.showSuccessMessage(n+" deleted successfully");this.getRouter().navTo("entityList",{table:e})}).catch(e=>{console.error("Error in Supabase query:",e);this.showErrorMessage("Error deleting entity: "+e.message);o.setProperty("/busy",false)})}).catch(e=>{console.error("Error getting table metadata:",e);this.showErrorMessage("Error getting table metadata: "+e.message);o.setProperty("/busy",false)})},onSavePress:function(){console.log("Save button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");if(!o){this.showErrorMessage("Cannot save: Missing entity ID");return}console.log("Saving entity with ID:",o);const n=JSON.parse(JSON.stringify(e.getProperty("/entity")));e.setProperty("/originalEntity",n);e.setProperty("/busy",true);let r=e.getProperty("/parentInfo");if(!r&&this._parentInfoBackup){console.log("Using parent info backup");r=this._parentInfoBackup}if(!r){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){r=JSON.parse(e);console.log("Retrieved parent info from session storage")}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}console.log("Parent info for navigation after save:",r?JSON.stringify(r,null,2):"none");this.getTableMetadata(t).then(s=>{if(!this.validateForm(s,n)){this.showErrorMessage("Please correct the errors in the form");e.setProperty("/busy",false);return}const a=s.primaryKey;const i={};s.columns.forEach(e=>{if(e.editable===false&&e.name!==a||e.name===a){return}i[e.name]=n[e.name]});i["updated_at"]=(new Date).toISOString();console.log("Data to update:",JSON.stringify(i,null,2));this.getSupabaseClient().from(t).update(i).eq(a,o).then(({data:n,error:s})=>{e.setProperty("/busy",false);if(s){console.error("Update error:",s);this.showErrorMessage("Error updating entity",s);return}e.setProperty("/editMode",false);this.showSuccessMessage("Entity updated successfully");try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}if(r&&r.isEditing&&r.parentTable&&r.parentId){console.log("Navigating back to parent entity after edit:",r.parentTable,r.parentId);setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:r.parentTable,id:r.parentId});console.log("Navigation back to parent initiated")},100)}else{this._loadEntity(t,o)}}).catch(t=>{console.error("Error in Supabase query:",t);this.showErrorMessage("Error updating entity: "+t.message);e.setProperty("/busy",false)})}).catch(t=>{console.error("Error getting table metadata:",t);this.showErrorMessage("Error getting table metadata: "+t.message);e.setProperty("/busy",false)})},onCancelPress:function(){console.log("Cancel button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");let o=e.getProperty("/parentInfo");if(!o&&this._parentInfoBackup){console.log("Using parent info backup for cancel");o=this._parentInfoBackup}if(!o){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){o=JSON.parse(e);console.log("Retrieved parent info from session storage for cancel")}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}e.setProperty("/editMode",false);if(o&&o.parentTable&&o.parentId){console.log("Navigating to parent entity after cancel:",o.parentTable,o.parentId);try{setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:o.parentTable,id:o.parentId});console.log("Navigation to parent initiated after cancel")},100)}catch(e){console.error("Error during navigation to parent after cancel:",e);this.getRouter().navTo("entityList",{table:t})}}else{this._loadEntity(t,e.getProperty("/entityId"))}},onAddRelatedItemPress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");this.getTableMetadata(t).then(e=>{if(!e.relations||e.relations.length===0){this.showErrorMessage("No relations defined for this entity");return}const n=e.relations[0];const r={parentTable:t,parentId:o,foreignKey:n.foreignKey};sessionStorage.setItem("parentEntityInfo",JSON.stringify(r));this.getRouter().navTo("entityCreate",{table:n.table})})},onEditRelatedItemPress:function(e){console.log("Edit related item button pressed");if(e.preventDefault){e.preventDefault()}const t=e.getSource();let o=t;let n=0;while(o&&!(o instanceof sap.m.ColumnListItem)&&n<5){o=o.getParent();n++}if(!o||!(o instanceof sap.m.ColumnListItem)){console.error("Could not find parent list item");return}const r=o.getBindingContext("viewModel");if(!r){console.error("No binding context found for related item");return}const s=r.getObject();const a=this.getModel("viewModel");const i=a.getProperty("/tableId");const l=a.getProperty("/entityId");console.log("Editing related item from parent:",i,l);this.getTableMetadata(i).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");sap.m.MessageBox.error("No relations defined for this entity");return}const t=e.relations[0];const o=t.table;console.log(`Relation found: ${o} with foreign key ${t.foreignKey}`);this.getTableMetadata(o).then(e=>{const n=e.primaryKey;const r=s[n];console.log(`Related item primary key: ${n}, value: ${r}`);const a={parentTable:i,parentId:l,isEditing:true,foreignKey:t.foreignKey,sourceView:"EntityDetail",timestamp:(new Date).getTime()};console.log("Setting parent info in session storage:",JSON.stringify(a,null,2));try{sessionStorage.removeItem("parentEntityInfo");sessionStorage.setItem("parentEntityInfo",JSON.stringify(a));console.log("Parent info successfully stored in session storage")}catch(e){console.error("Failed to store parent info in session storage:",e);sap.m.MessageBox.error("Failed to store navigation state. Back navigation may not work correctly.")}setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:o,id:r});console.log("Navigation to edit related item initiated")},100)})})},onDeleteRelatedItemPress:function(e){const t=e.getSource();const o=t.getParent().getParent();const n=o.getBindingContext("viewModel");if(!n){console.error("No binding context found for related item");return}const r=n.getObject();const s=this.getModel("viewModel");const a=s.getProperty("/tableId");console.log("Delete related item:",r);this.getTableMetadata(a).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const o=e.primaryKey;const n=r[o];console.log(`Confirming deletion of related item: ${t.table}/${n}`);this.showConfirmationDialog("Are you sure you want to delete this related item?",()=>{console.log(`Deleting related item: ${t.table}/${n}`);this.getSupabaseClient().from(t.table).delete().eq(o,n).then(({error:e})=>{if(e){console.error("Error deleting related item:",e);this.showErrorMessage("Error deleting related item",e);return}console.log("Related item deleted successfully");this._loadEntity(a,s.getProperty("/entityId"));this.showSuccessMessage("Related item deleted successfully")})},"Delete Confirmation")})})},onRelatedItemPress:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");console.log("Item pressed:",n);this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined for navigation");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const o=e.primaryKey;const r=n[o];console.log(`Navigating to related item details: ${t.table}/${r}`);this.getRouter().navTo("entityDetail",{table:t.table,id:r})})})},onRelatedItemsSearch:function(e){const t=e.getParameter("query").toLowerCase();const o=this.getModel("viewModel");const n=[...o.getProperty("/relatedItems")];if(!t){o.setProperty("/filteredRelatedItems",n);return}const r=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t));o.setProperty("/filteredRelatedItems",r)},resetFormErrorStates:function(){console.log("Resetting error states on all form fields");const e=[];this.getView().$().find(".sapMInputBase").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});this.getView().$().find(".sapMCb").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});this.getView().$().find(".sapMComboBox").each(function(){const t=this.id;const o=sap.ui.getCore().byId(t);if(o){e.push(o)}});console.log("Found",e.length,"controls to reset");e.forEach(e=>{if(e.setValueState){console.log("Resetting value state for",e.getId());e.setValueState("None");if(e.setValueStateText){e.setValueStateText("")}}});const t=this.getModel("viewModel");if(t){t.setProperty("/validationErrors",{})}console.log("Form error states reset complete")},_loadEntity:function(e,t){console.log("ðŸ” ENTITY DEBUG: Starting _loadEntity method",{tableId:e,entityId:t});try{const o=this.getModel("viewModel");if(!o){console.error("ðŸ” ENTITY DEBUG: viewModel not found!");return}o.setProperty("/busy",true);if(!this._oTableMetadata){console.log("ðŸ” ENTITY DEBUG: No stored metadata, loading it now");this.getTableMetadata(e).then(o=>{console.log("ðŸ” ENTITY DEBUG: Metadata loaded successfully");this._oTableMetadata=o;this._continueLoadingEntity(e,t,o)}).catch(e=>{console.error("ðŸ” ENTITY DEBUG: Error loading metadata:",e);console.error("ðŸ” ENTITY DEBUG: Error stack:",e.stack);o.setProperty("/busy",false)})}else{console.log("ðŸ” ENTITY DEBUG: Using stored metadata");this._continueLoadingEntity(e,t,this._oTableMetadata)}}catch(e){console.error("ðŸ” ENTITY DEBUG: Critical error in _loadEntity:",e);console.error("ðŸ” ENTITY DEBUG: Error stack:",e.stack);try{const e=this.getModel("viewModel");if(e){e.setProperty("/busy",false)}}catch(e){console.error("ðŸ” ENTITY DEBUG: Error resetting busy state:",e)}}},_continueLoadingEntity:function(e,t,o){console.log("ðŸ” ENTITY DEBUG: Continuing entity loading with metadata");try{const n=this.getModel("viewModel");const r=o.primaryKey||`${e}_id`;console.log("ðŸ” ENTITY DEBUG: Using primary key:",r);if(!r){console.error("ðŸ” ENTITY DEBUG: No primary key defined in metadata");n.setProperty("/busy",false);return}if(!t){console.error("ðŸ” ENTITY DEBUG: No entity ID specified");n.setProperty("/busy",false);return}if(!this.getSupabaseClient()){console.error("ðŸ” ENTITY DEBUG: Supabase client not available");n.setProperty("/busy",false);return}console.log(`ðŸ” ENTITY DEBUG: Building query: ${e}.select('*').eq('${r}', '${t}')`);this.getSupabaseClient().from(e).select("*").eq(r,t).single().then(async({data:e,error:t})=>{if(t){console.error("ðŸ” ENTITY DEBUG: Error loading entity data:",t);n.setProperty("/busy",false);return}if(!e){console.error("ðŸ” ENTITY DEBUG: No data found for entity");n.setProperty("/busy",false);return}console.log("ðŸ” ENTITY DEBUG: Entity data loaded:",JSON.stringify(e,null,2));console.log("ðŸ” ENTITY DEBUG: Processing relation fields");for(const t of o.columns){if(t.type==="relation"&&e[t.name]){const o=e[t.name];const n=t.relation;console.log(`ðŸ” ENTITY DEBUG: Processing relation ${t.name} -> ${n} (ID: ${o})`);try{const r=await this.getTableMetadata(n);const s=r.primaryKey||`${n}_id`;console.log(`ðŸ” ENTITY DEBUG: Loading related data from ${n} where ${s}=${o}`);const{data:a,error:i}=await this.getSupabaseClient().from(n).select("*").eq(s,o).single();if(!i&&a){const o=r.titleField||s;e[t.name+"_text"]=a[o];e[t.name+"_obj"]=a;console.log(`ðŸ” ENTITY DEBUG: Loaded related text: ${e[t.name+"_text"]}`)}else if(i){console.error(`ðŸ” ENTITY DEBUG: Error loading related data:`,i)}}catch(e){console.error(`ðŸ” ENTITY DEBUG: Exception loading related data:`,e)}}}console.log("ðŸ” ENTITY DEBUG: Setting entity data to model");n.setProperty("/entity",e);n.setProperty("/originalEntity",JSON.parse(JSON.stringify(e)));const s=o.titleField||r;const a=o.subtitleField;n.setProperty("/entityTitle",e[s]);if(a&&e[a]){n.setProperty("/entitySubtitle",e[a])}else{n.setProperty("/entitySubtitle","ID: "+e[r])}console.log("ðŸ” ENTITY DEBUG: Configuring entity form");this._configureForm(o,e);console.log("ðŸ” ENTITY DEBUG: Loading related items");this._loadRelatedItems(o,e)}).catch(e=>{console.error("ðŸ” ENTITY DEBUG: Error in Supabase query:",e);console.error("ðŸ” ENTITY DEBUG: Error stack:",e.stack);n.setProperty("/busy",false)})}catch(e){console.error("ðŸ” ENTITY DEBUG: Critical error in _continueLoadingEntity:",e);console.error("ðŸ” ENTITY DEBUG: Error stack:",e.stack);try{const e=this.getModel("viewModel");if(e){e.setProperty("/busy",false)}}catch(e){console.error("ðŸ” ENTITY DEBUG: Error resetting busy state:",e)}}},_loadRelatedItems:function(e,t){console.log("ðŸ” RELATED DEBUG: Starting _loadRelatedItems method");console.log("ðŸ” RELATED DEBUG: Metadata:",JSON.stringify(e,null,2));console.log("ðŸ” RELATED DEBUG: Entity data:",JSON.stringify(t,null,2));try{const o=this.getModel("viewModel");if(!o){console.error("ðŸ” RELATED DEBUG: viewModel not found! Aborting method.");return}const n=o.getProperty("/tableId");console.log("ðŸ” RELATED DEBUG: Table ID from viewModel:",n);const r=this.getView().byId("relatedItemsSection");console.log("ðŸ” RELATED DEBUG: Related items section found?",!!r);if(r){console.log("ðŸ” RELATED DEBUG: Setting related items section to ALWAYS visible");r.setVisible(true)}else{console.error("ðŸ” RELATED DEBUG: Related items section not found in view! Check the ID in your XML")}console.log("ðŸ” RELATED DEBUG: Checking for relations in metadata");if(!e.relations||e.relations.length===0){console.log("ðŸ” RELATED DEBUG: No relations defined for table:",n);console.log("ðŸ” RELATED DEBUG: Setting empty arrays for items");o.setProperty("/relatedItems",[]);o.setProperty("/filteredRelatedItems",[]);console.log("ðŸ” RELATED DEBUG: Calling _configureRelatedItemsTable with empty data");this._configureRelatedItemsTable(n);o.setProperty("/busy",false);return}const s=e.relations[0];console.log("ðŸ” RELATED DEBUG: Found relation:",JSON.stringify(s));const a=e.primaryKey||`${n}_id`;console.log("ðŸ” RELATED DEBUG: Using primary key:",a);console.log("ðŸ” RELATED DEBUG: Entity data keys:",Object.keys(t).join(", "));console.log("ðŸ” RELATED DEBUG: Primary key value:",t[a]);const i=t[a];if(!i){console.error("ðŸ” RELATED DEBUG: Primary key value not found in entity data!");console.log("ðŸ” RELATED DEBUG: Setting empty arrays for related items");o.setProperty("/relatedItems",[]);o.setProperty("/filteredRelatedItems",[]);console.log("ðŸ” RELATED DEBUG: Calling _configureRelatedItemsTable with empty data");this._configureRelatedItemsTable(n);o.setProperty("/busy",false);return}console.log(`ðŸ” RELATED DEBUG: Will query: ${s.table}.select('*').eq('${s.foreignKey}', '${i}')`);if(!this.getSupabaseClient()){console.error("ðŸ” RELATED DEBUG: Supabase client not available!");o.setProperty("/busy",false);return}try{console.log("ðŸ” RELATED DEBUG: Executing Supabase query");this.getSupabaseClient().from(s.table).select("*").eq(s.foreignKey,i).then(({data:e,error:t})=>{console.log("ðŸ” RELATED DEBUG: Supabase query completed");if(t){console.error("ðŸ” RELATED DEBUG: Error loading related items:",t);o.setProperty("/busy",false);return}console.log("ðŸ” RELATED DEBUG: Related items loaded:",e?e.length:0);console.log("ðŸ” RELATED DEBUG: Full related items data:",JSON.stringify(e));console.log("ðŸ” RELATED DEBUG: Setting model data for related items");o.setProperty("/relatedItems",e||[]);o.setProperty("/filteredRelatedItems",e||[]);const n=o.getProperty("/filteredRelatedItems");console.log("ðŸ” RELATED DEBUG: Model data set, count:",n.length);console.log("ðŸ” RELATED DEBUG: Now configuring the table");this._configureRelatedItemsTable(s.table);o.setProperty("/busy",false);console.log("ðŸ” RELATED DEBUG: _loadRelatedItems completed successfully")}).catch(e=>{console.error("ðŸ” RELATED DEBUG: Error in Supabase query:",e);console.error("ðŸ” RELATED DEBUG: Error stack:",e.stack);o.setProperty("/busy",false)})}catch(e){console.error("ðŸ” RELATED DEBUG: Exception during Supabase query:",e);console.error("ðŸ” RELATED DEBUG: Error stack:",e.stack);o.setProperty("/busy",false)}}catch(e){console.error("ðŸ” RELATED DEBUG: Critical error in _loadRelatedItems:",e);console.error("ðŸ” RELATED DEBUG: Error stack:",e.stack);const t=this.getModel("viewModel");if(t){t.setProperty("/busy",false)}}},_loadRelationOptionsForEdit:function(e,t,o){console.log(`Loading relation options for ${o} from table ${t}`);this.getTableMetadata(t).then(function(n){const r=n.primaryKey;const s=n.titleField||r;console.log(`Relation ${o}: Using primary key '${r}' and title field '${s}' from ${t}`);this.getSupabaseClient().from(t).select(`${r}, ${s}`).then(({data:t,error:a})=>{if(a){console.error(`Error loading relation options for ${o}:`,a);return}console.log(`Loaded ${t?t.length:0} relation options for ${o}`);e.removeAllItems();const i=n.columns.find(e=>e.name===o);if(i&&!i.required){e.addItem(new sap.ui.core.Item({key:"",text:"- None -"}))}if(t&&t.length>0){t.forEach(t=>{const o=t[r];const n=t[s]||o;e.addItem(new sap.ui.core.Item({key:o,text:n}));console.log(`Added relation option: key=${o}, text=${n}`)})}console.log(`Initial selected key for ${o}: ${e.getSelectedKey()}`)})}.bind(this)).catch(e=>{console.error(`Error getting metadata for relation ${o}:`,e)})},onNavBack:function(){console.log("Back button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");const n=()=>{let t=e.getProperty("/parentInfo");if(t&&t.parentTable&&t.parentId){console.log("Using parent info from view model");return t}if(this._parentInfoBackup&&this._parentInfoBackup.parentTable&&this._parentInfoBackup.parentId){console.log("Using parent info from backup");return this._parentInfoBackup}try{const e=sessionStorage.getItem("parentEntityInfo");if(e){const t=JSON.parse(e);if(t.parentTable&&t.parentId){console.log("Using parent info from session storage");return t}}}catch(e){console.error("Error retrieving parent info from session storage:",e)}return null};const r=n();if(r){console.log("Found valid parent info:",JSON.stringify(r,null,2));const e=r.parentTable;const t=r.parentId;setTimeout(()=>{console.log(`Navigating to parent entity: ${e}/${t}`);this.getRouter().navTo("entityDetail",{table:e,id:t});setTimeout(()=>{try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage after navigation")}catch(e){console.warn("Could not clear session storage after navigation:",e)}},300)},100)}else{console.log("No parent info, navigating to list view after back button");this.getRouter().navTo("entityList",{table:t});try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}}},_updateDeleteButtonState:function(e){let t=null;const o=this.getView().byId("ObjectPageLayout");if(o){const e=o.getHeaderTitle();if(e){const o=e.getActions()||[];for(let e=0;e<o.length;e++){const n=o[e];if(n.getIcon&&n.getIcon()==="sap-icon://delete"){t=n;break}}}}if(!t){t=this.getView().byId("deleteButton")}if(t){const o=e&&e.length>0;t.setEnabled(!o);if(o){t.setTooltip("Cannot delete while related items exist")}else{t.setTooltip("Delete this entity")}}},onEditPress:function(){console.log("Edit button pressed - fetching latest data from server");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const o=e.getProperty("/entityId");if(!o){this.showErrorMessage("Cannot edit: Missing entity ID");return}console.log("Fetching latest data for entity ID:",o);e.setProperty("/busy",true);this.getTableMetadata(t).then(n=>{const r=n.primaryKey;this.getSupabaseClient().from(t).select("*").eq(r,o).single().then(async({data:t,error:o})=>{e.setProperty("/busy",false);if(o){console.error("Error fetching latest entity data:",o);this.showErrorMessage("Error fetching latest data",o);return}if(!t){console.error("No data found for entity");this.showErrorMessage("Entity not found");return}console.log("Latest entity data fetched:",t);for(const e of n.columns){if(e.type==="relation"&&t[e.name]){const o=t[e.name];const n=e.relation;try{const r=await this.getTableMetadata(n);const s=r.primaryKey;const{data:a,error:i}=await this.getSupabaseClient().from(n).select("*").eq(s,o).single();if(!i&&a){const o=r.titleField||s;t[e.name+"_text"]=a[o];t[e.name+"_obj"]=a}}catch(e){console.error("Error loading related data",e)}}}e.setProperty("/entity",t);e.setProperty("/originalEntity",JSON.parse(JSON.stringify(t)));this._openEditDialogWithFreshData(n,t)}).catch(t=>{console.error("Error in Supabase query:",t);this.showErrorMessage("Error fetching latest data: "+t.message);e.setProperty("/busy",false)})}).catch(t=>{console.error("Error getting table metadata:",t);this.showErrorMessage("Error getting table metadata: "+t.message);e.setProperty("/busy",false)})},_openEditDialogWithFreshData:function(e,t){const o=new sap.m.Dialog({title:"Edit "+this.getModel("viewModel").getProperty("/tableName"),contentWidth:"40rem",content:[new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,columnsXL:1,columnsL:1,content:this._createEditFormContent(e,t)})],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){let n=true;this._editControls=this._editControls||{};Object.values(this._editControls).forEach(function(e){if(e.setValueState){e.setValueState("None")}});n=this._validateEditForm(e);if(!n){sap.m.MessageToast.show("Please correct the errors before saving");return}const r=JSON.parse(JSON.stringify(t));e.columns.forEach(t=>{if(t.editable===false||!t.visible||t.name===e.primaryKey||t.name==="created_at"||t.name==="updated_at"){return}const o=this._editControls[t.name];if(!o)return;if(o instanceof sap.m.CheckBox){r[t.name]=o.getSelected()}else if(o instanceof sap.m.DatePicker){r[t.name]=o.getValue()}else if(o.getValue){r[t.name]=o.getValue()}});if(this._areObjectsEqual(r,t)){sap.m.MessageBox.information("No changes were made to this record.",{title:"No Changes",onClose:function(){o.close()}});return}this._saveEntity(this.getModel("viewModel").getProperty("/tableId"),this.getModel("viewModel").getProperty("/entityId"),e,r);o.close()}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){o.close()}}),afterClose:function(){o.destroy();this._editControls=null}.bind(this)});this.getView().addDependent(o);o.open()}})});
//# sourceMappingURL=EntityDetail.controller.js.map