sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/m/Label","sap/m/Text","sap/m/Input","sap/m/TextArea","sap/m/CheckBox","sap/m/DatePicker","sap/m/ComboBox","sap/ui/layout/Grid","sap/ui/layout/GridData","sap/m/VBox","sap/m/HBox","sap/m/Panel"],function(e,t,a,r,o,i,s,n,l,d,u,c,m){"use strict";return e.extend("com.supabase.easyui5.controller.EntityDetailForm",{configureForm:function(e,a){console.log("Configuring form with metadata:",e);const l=this.getView().byId("entityDetailsContainer");if(!l){console.error("Form container not found");return}l.removeAllFormElements();const d=this.getModel("viewModel");const u=d.getProperty("/editMode");console.log("Edit Mode:",u);if(u){this.initFormFields()}e.columns.forEach(e=>{if(!e.visible){return}const d=new sap.ui.layout.form.FormElement({label:new t({text:e.label,required:u&&e.required})});let c;const m="viewModel>/entity/"+e.name;if(u){if(e.type==="relation"){c=new n({selectedKey:{path:m,mode:"TwoWay"},width:"100%",enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",selectionChange:this.createFieldChangeHandler(e)});this.loadRelationOptions(c,e.relation,e.name)}else if(e.type==="boolean"){c=new i({selected:{path:m,mode:"TwoWay"},enabled:!(e.editable===false),select:this.createFieldChangeHandler(e)})}else if(e.type==="date"){c=new s({value:{path:m,mode:"TwoWay",type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"mediumDate",enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",change:function(t){if(t.getParameter("valid")){t.getSource().setValueState("None");this.clearFieldError(e.name)}else{t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid date");this.setFieldError(e.name,"Please enter a valid date")}}.bind(this)})}else if(e.type==="number"){c=new r({value:{path:m,mode:"TwoWay",type:new sap.ui.model.type.Float({decimals:2})},type:"Number",enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:function(t){const a=t.getParameter("value");if(a&&isNaN(parseFloat(a))){t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid number");this.setFieldError(e.name,"Please enter a valid number")}else{t.getSource().setValueState("None");this.clearFieldError(e.name)}}.bind(this)})}else if(e.type==="email"){c=new r({value:{path:m,mode:"TwoWay"},type:"Email",enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:function(t){const a=t.getParameter("value");const r=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(a&&!r.test(a)){t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid email address");this.setFieldError(e.name,"Please enter a valid email address")}else{t.getSource().setValueState("None");this.clearFieldError(e.name)}}.bind(this)})}else if(e.type==="url"){c=new r({value:{path:m,mode:"TwoWay"},type:"Url",enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:function(t){const a=t.getParameter("value");const r=/^(http|https):\/\/[^ "]+$/;if(a&&!r.test(a)){t.getSource().setValueState("Error");t.getSource().setValueStateText("Please enter a valid URL (starting with http:// or https://)");this.setFieldError(e.name,"Please enter a valid URL (starting with http:// or https://)")}else{t.getSource().setValueState("None");this.clearFieldError(e.name)}}.bind(this)})}else if(e.type==="text"){c=new o({value:{path:m,mode:"TwoWay"},rows:3,width:"100%",enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:this.createFieldChangeHandler(e)})}else{c=new r({value:{path:m,mode:"TwoWay"},enabled:!(e.editable===false),valueState:"{= ${viewModel>/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{viewModel>/validationErrors/"+e.name+"}",liveChange:this.createFieldChangeHandler(e)})}if(this.getView().getController()._formFields){this.getView().getController()._formFields[e.name]=c}}else{c=this.createDisplayField(e,a)}d.addField(c);l.addFormElement(d)});console.log("Form configuration complete")},configureGridForm:function(e,a){try{console.log("Finding suitable container for entity details");let r=null;r=this.getView().byId("detailContentArea")||this.getView().byId("entityDetailsContainer");if(!r){const e=this.getView().getControlsByType("sap.uxap.ObjectPageSubSection");if(e&&e.length>0){r=e[0];console.log("Using ObjectPageSubSection as container")}}if(!r){const e=this.getView().getControlsByType("sap.ui.layout.form.SimpleForm")||this.getView().getControlsByType("sap.ui.layout.form.Form")||this.getView().getControlsByType("sap.m.VBox")||this.getView().getControlsByType("sap.m.Panel");if(e&&e.length>0){r=e[0];console.log("Using layout container:",r.getMetadata().getName())}}if(!r){const e=this.getView().getControlsByType("sap.m.Page")[0]||this.getView().getControlsByType("sap.uxap.ObjectPageLayout")[0];if(e){if(e.getContent&&e.addContent){r=e;console.log("Using page as container")}}}if(!r){console.error("Could not find any suitable container for entity details");return}const o=new l({defaultSpan:"XL4 L4 M6 S12",vSpacing:1,hSpacing:1,width:"100%"});e.columns.forEach(e=>{if(!e.visible)return;const r=new u({width:"100%",alignItems:"Start"});r.addItem(new t({text:e.label,design:"Bold",width:"100%"}).addStyleClass("sapUiTinyMarginBottom"));let i=this.createDisplayField(e,a);i.addStyleClass("sapUiTinyMarginTop");i.setWidth("100%");r.addItem(i);o.addContent(r.addStyleClass("sapUiSmallMargin"))});const i=new m({headerText:"Details",expandable:false,expanded:true,backgroundDesign:"Solid",content:[o]});if(r.removeAllContent){r.removeAllContent();r.addContent(i)}else if(r.removeAllItems){r.removeAllItems();r.addItem(i)}else if(r.removeAllFormElements){r.removeAllFormElements();const e=new sap.ui.layout.form.FormElement;e.addField(i);r.addFormElement(e)}else if(r.addContent){r.addContent(i)}else{console.error("Container doesn't have a method to add content:",r)}console.log("Entity details added to container")}catch(e){console.error("Error in dynamic configureGridForm:",e)}},loadEntity:function(e,t){console.log("Loading entity data for table:",e,"entity ID:",t);const a=this.getModel("viewModel");a.setProperty("/busy",true);return new Promise((r,o)=>{this.getTableMetadata(e).then(i=>{console.log("Got metadata for table:",e);const s=i.primaryKey;console.log("Primary key from metadata:",s);if(!s){this.showErrorMessage("Error: No primary key defined in metadata");a.setProperty("/busy",false);o(new Error("No primary key defined"));return}if(!t){this.showErrorMessage("Error: No entity ID specified");a.setProperty("/busy",false);o(new Error("No entity ID specified"));return}this.getView().getController()._currentMetadata=i;this.getSupabaseClient().from(e).select("*").eq(s,t).single().then(async({data:e,error:t})=>{if(t){console.error("Error loading entity data:",t);this.showErrorMessage("Error loading entity: "+t.message);a.setProperty("/busy",false);o(t);return}if(!e){console.error("No data found for entity");this.showErrorMessage("Entity not found");a.setProperty("/busy",false);o(new Error("Entity not found"));return}console.log("Entity data loaded:",e);for(const t of i.columns){if(t.type==="relation"&&e[t.name]){const a=e[t.name];const r=t.relation;try{const o=await this.getTableMetadata(r);const{data:i,error:s}=await this.getSupabaseClient().from(r).select("*").eq(o.primaryKey,a).single();if(!s&&i){e[t.name+"_text"]=i[o.titleField];e[t.name+"_obj"]=i}}catch(e){console.error("Error loading related data",e)}}}console.log("Setting entity data to model");a.setProperty("/entity",e);const n=i.titleField||s;const l=i.subtitleField;a.setProperty("/entityTitle",e[n]);if(l&&e[l]){a.setProperty("/entitySubtitle",e[l])}else{a.setProperty("/entitySubtitle","ID: "+e[s])}const d=a.getProperty("/useGridForm");if(d){this.configureGridForm(i,e)}else{this.configureForm(i,e)}a.setProperty("/busy",false);r(e)}).catch(e=>{console.error("Error in Supabase query:",e);this.showErrorMessage("Error loading entity: "+e.message);a.setProperty("/busy",false);o(e)})}).catch(e=>{console.error("Error getting table metadata:",e);this.showErrorMessage("Error loading metadata: "+e.message);a.setProperty("/busy",false);o(e)})})},validateForm:function(){const e=this.getModel("viewModel");const t=e.getProperty("/entity");const a={};const r=this.getView().getController()._currentMetadata;let o=true;if(!r){console.error("No metadata available for validation");return false}const i=this.getView().getController()._formFields||{};Object.values(i).forEach(e=>{if(e.setValueState){e.setValueState("None")}});r.columns.forEach(e=>{if(e.editable===false||e.name===r.primaryKey||e.name==="created_at"||e.name==="updated_at"){return}const s=e.name;const n=t[s];const l=i[s];if(e.required&&(n===undefined||n===null||n==="")){o=false;a[s]="This field is required";if(l&&l.setValueState){l.setValueState("Error");if(l.setValueStateText){l.setValueStateText("This field is required")}}console.log("Required field validation failed:",s)}else if(n!==undefined&&n!==null&&n!==""){let t=true;let r="";switch(e.type){case"number":if(isNaN(parseFloat(n))||!isFinite(n)){t=false;r="Please enter a valid number"}break;case"date":const e=new Date(n);if(isNaN(e.getTime())){t=false;r="Please enter a valid date"}break;case"email":const a=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!a.test(n)){t=false;r="Please enter a valid email address"}break;case"url":const o=/^(http|https):\/\/[^ "]+$/;if(!o.test(n)){t=false;r="Please enter a valid URL (starting with http:// or https://)"}break}if(!t){o=false;a[s]=r;if(l&&l.setValueState){l.setValueState("Error");if(l.setValueStateText){l.setValueStateText(r)}}console.log("Type validation failed:",s,r)}}});e.setProperty("/validationErrors",a);return o},saveEntity:function(e,t){const a=this.getModel("viewModel");const r=a.getProperty("/entity");a.setProperty("/busy",true);return new Promise((o,i)=>{this.getTableMetadata(e).then(s=>{const n=s.primaryKey;if(!this.validateForm()){this.showErrorMessage("Please correct the errors in the form");a.setProperty("/busy",false);i(new Error("Validation failed"));return}const l=this.getEntityDataForSave(s,r,n);console.log("Data to update:",l);this.getSupabaseClient().from(e).update(l).eq(n,t).then(({data:s,error:n})=>{a.setProperty("/busy",false);if(n){console.error("Update error:",n);this.showErrorMessage("Error updating entity",n);i(n);return}a.setProperty("/editMode",false);this.showSuccessMessage("Entity updated successfully");this.loadEntity(e,t).then(e=>o(e)).catch(e=>{console.error("Error reloading entity after save:",e);o(r)})}).catch(e=>{console.error("Error in Supabase query:",e);this.showErrorMessage("Error updating entity: "+e.message);a.setProperty("/busy",false);i(e)})}).catch(e=>{console.error("Error getting table metadata:",e);this.showErrorMessage("Error getting table metadata: "+e.message);a.setProperty("/busy",false);i(e)})})}})});
//# sourceMappingURL=EntityDetailForm.controller.js.map