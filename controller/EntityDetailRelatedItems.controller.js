sap.ui.define(["sap/ui/core/mvc/ControllerExtension","sap/m/Column","sap/m/Label","sap/m/Text","sap/m/ColumnListItem","sap/m/HBox","sap/m/Button","sap/m/Dialog","sap/m/MessageBox"],function(e,t,a,o,n,r,s,i,l){"use strict";return e.extend("com.supabase.easyui5.controller.EntityDetailRelatedItems",{_processRelatedItemsRelations:function(e,t){if(!t||t.length===0){return Promise.resolve(t)}console.log("🔍 RELATED DEBUG: Processing relations for",t.length,"items");return this.getTableMetadata(e).then(e=>{const a=e.columns.filter(e=>e.type==="relation");if(a.length===0){return t}console.log("🔍 RELATED DEBUG: Found",a.length,"relation columns");const o=t.map(e=>{const t=a.filter(t=>e[t.name]).map(t=>{const a=e[t.name];const o=t.relation;console.log(`🔍 RELATED DEBUG: Processing relation ${t.name} -> ${o} (ID: ${a})`);return this.getTableMetadata(o).then(n=>{const r=n.primaryKey;const s=n.titleField||r;return this.getSupabaseClient().from(o).select("*").eq(r,a).single().then(({data:o,error:n})=>{if(!n&&o){e[t.name+"_text"]=o[s]||o[r];console.log(`🔍 RELATED DEBUG: Loaded related text: ${e[t.name+"_text"]}`)}else if(n){console.error(`🔍 RELATED DEBUG: Error loading related data:`,n);e[t.name+"_text"]=`ID: ${a}`}return e}).catch(o=>{console.error("🔍 RELATED DEBUG: Error processing relation in related item",o);e[t.name+"_text"]=`ID: ${a}`;return e})})});if(t.length===0){return Promise.resolve(e)}return Promise.all(t).then(()=>e)});return Promise.all(o).then(e=>{console.log("🔍 RELATED DEBUG: Completed processing relations for all items");return e})}).catch(e=>{console.error("🔍 RELATED DEBUG: Error processing relations in related items",e);return t})},onRelatedItemsSearch:function(e){const t=e.getParameter("query")||e.getParameter("newValue")||"";const a=this.getModel("viewModel");const o=a.getProperty("/relatedItems")||[];if(!t){a.setProperty("/filteredRelatedItems",o);return}const n=t.toLowerCase();const r=o.filter(e=>Object.values(e).some(e=>{if(e===null||e===undefined){return false}return String(e).toLowerCase().includes(n)}));a.setProperty("/filteredRelatedItems",r);console.log(`🔍 RELATED DEBUG: Filtered related items to ${r.length} of ${o.length} total`)},onRelatedItemPress:function(e){const t=e.getSource();const a=t.getBindingContext("viewModel");if(!a){console.error("No binding context found for related item");return}const o=a.getObject();const n=this.getModel("viewModel");const r=n.getProperty("/tableId");console.log("Item pressed:",o);this.getTableMetadata(r).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined for navigation");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const a=e.primaryKey;const n=o[a];console.log(`Navigating to related item details: ${t.table}/${n}`);this.getRouter().navTo("entityDetail",{table:t.table,id:n})})})},onDeleteRelatedItemPress:function(e){e.preventDefault();e.stopPropagation();const t=e.getSource();const a=t.getParent().getParent();const o=a.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");console.log("Delete related item:",n);this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const a=e.primaryKey;const o=n[a];console.log(`Confirming deletion of related item: ${t.table}/${o}`);sap.m.MessageBox.confirm("Are you sure you want to delete this related item?",{title:"Delete Confirmation",onClose:function(e){if(e===sap.m.MessageBox.Action.OK){console.log(`Deleting related item: ${t.table}/${o}`);r.setProperty("/busy",true);this.getSupabaseClient().from(t.table).delete().eq(a,o).then(({error:e})=>{r.setProperty("/busy",false);if(e){console.error("Error deleting related item:",e);sap.m.MessageBox.error("Error deleting related item: "+e.message);return}console.log("Related item deleted successfully");const t=[...r.getProperty("/relatedItems")];const n=[...r.getProperty("/filteredRelatedItems")];const s=t.findIndex(e=>e[a]===o);if(s!==-1){t.splice(s,1);r.setProperty("/relatedItems",t)}const i=n.findIndex(e=>e[a]===o);if(i!==-1){n.splice(i,1);r.setProperty("/filteredRelatedItems",n)}sap.m.MessageToast.show("Related item deleted successfully")}).catch(e=>{r.setProperty("/busy",false);console.error("Error in delete operation:",e);sap.m.MessageBox.error("Error deleting related item: "+e.message)})}}.bind(this)})})})},onAddRelatedItemPress:function(){console.log("Add related item button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");const a=e.getProperty("/entityId");console.log(`Adding related item for parent entity ${t}/${a}`);this.getTableMetadata(t).then(o=>{if(!o.relations||o.relations.length===0){console.error("No relations defined in metadata");sap.m.MessageBox.error("No relations defined for this entity");return}const n=o.relations[0];const r=n.table;console.log(`Creating dialog for new ${r} related to ${t}/${a}`);this.getTableMetadata(r).then(t=>{const s={};t.columns.forEach(e=>{if(e.name===n.foreignKey){s[e.name]=a}else if(e.type==="boolean"){s[e.name]=false}else if(e.type==="number"){s[e.name]=0}else if(e.type==="date"){s[e.name]=(new Date).toISOString().split("T")[0]}else{s[e.name]=""}});const i=new sap.ui.model.json.JSONModel({entity:s,validationErrors:{},title:`Add New ${t.titleField?t.titleField:"Related Item"}`,busy:false});const l=new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:0,emptySpanL:0,emptySpanM:0,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,singleContainerFullSize:false});const d={};t.columns.forEach(o=>{if(o.editable===false||o.name===t.primaryKey||o.name==="created_at"||o.name==="updated_at"){return}const r=o.name===n.foreignKey;if(r){l.addContent(new sap.m.Label({text:o.label,required:o.required}));l.addContent(new sap.m.Text({text:`Connected to ${e.getProperty("/tableName")} (ID: ${a})`}));return}l.addContent(new sap.m.Label({text:o.label,required:o.required===true}));let s;switch(o.type){case"relation":s=new sap.m.ComboBox({selectedKey:"{/entity/"+o.name+"}",width:"100%",enabled:true,valueState:"{= ${/validationErrors/"+o.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+o.name+"}"});this._loadRelationOptionsForDialog(s,o.relation,o.required);break;case"boolean":s=new sap.m.CheckBox({selected:"{/entity/"+o.name+"}"});break;case"date":s=new sap.m.DatePicker({value:{path:"/entity/"+o.name,type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%",required:o.required===true,valueState:"{= ${/validationErrors/"+o.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+o.name+"}"});break;case"number":s=new sap.m.Input({value:{path:"/entity/"+o.name,type:new sap.ui.model.type.Float({minFractionDigits:0,maxFractionDigits:2})},type:"Number",width:"100%",required:o.required===true,valueState:"{= ${/validationErrors/"+o.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+o.name+"}"});break;case"email":s=new sap.m.Input({value:"{/entity/"+o.name+"}",type:"Email",width:"100%",required:o.required===true,valueState:"{= ${/validationErrors/"+o.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+o.name+"}"});break;case"text":s=new sap.m.TextArea({value:"{/entity/"+o.name+"}",rows:3,growing:true,width:"100%",required:o.required===true,valueState:"{= ${/validationErrors/"+o.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+o.name+"}"});break;default:s=new sap.m.Input({value:"{/entity/"+o.name+"}",width:"100%",required:o.required===true,valueState:"{= ${/validationErrors/"+o.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+o.name+"}"})}l.addContent(s);d[o.name]=s});const c=new sap.m.Dialog({title:"{/title}",contentWidth:"40rem",contentHeight:"auto",resizable:true,draggable:true,stretch:sap.ui.Device.system.phone,content:[l],beginButton:new sap.m.Button({text:"Create",type:"Emphasized",press:function(){const s=this._validateDialogForm(t,i.getProperty("/entity"),d);if(!s){sap.m.MessageToast.show("Please correct the errors in the form");return}i.setProperty("/busy",true);const l=i.getProperty("/entity");l[n.foreignKey]=a;this.getSupabaseClient().from(r).insert(l).then(({data:t,error:a})=>{i.setProperty("/busy",false);if(a){console.error("Error creating related item:",a);sap.m.MessageBox.error("Error creating related item: "+a.message);return}c.close();sap.m.MessageToast.show("Related item created successfully");this._loadRelatedItems(o,e.getProperty("/entity"))}).catch(e=>{i.setProperty("/busy",false);console.error("Error in Supabase query:",e);sap.m.MessageBox.error("Error creating related item: "+e.message)})}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){c.close()}}),afterClose:function(){c.destroy()}});c.setModel(i);this.getView().addDependent(c);c.open()})})},onEditRelatedItemPress:function(e){e.preventDefault();e.stopPropagation();const t=e.getSource();const a=t.getParent().getParent().getParent();const o=a.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");const i=r.getProperty("/entityId");console.log("Editing related item:",JSON.stringify(n,null,2));console.log("Parent entity:",s,i);this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");l.error("No relations defined for this entity");return}const t=e.relations[0];const a=t.table;console.log(`Relation found: ${a} with foreign key ${t.foreignKey}`);this.getTableMetadata(a).then(e=>{const o=e.primaryKey;const r=n[o];console.log(`Related item primary key: ${o}, value: ${r}`);const l={parentTable:s,parentId:i,isEditing:true,foreignKey:t.foreignKey};console.log("Storing parent info in session storage:",JSON.stringify(l,null,2));sessionStorage.setItem("parentEntityInfo",JSON.stringify(l));this.getRouter().navTo("entityDetail",{table:a,id:r})})})},_configureRelatedItemsTable:function(e){console.log("🔍 TABLE DEBUG: Started _configureRelatedItemsTable for table:",e);try{const t=this.getView().byId("relatedItemsTable");if(!t){console.error("🔍 TABLE DEBUG: Related items table not found in the view! Check ID in XML");return}t.removeAllColumns();console.log("🔍 TABLE DEBUG: Removed all columns");this.getTableMetadata(e).then(a=>{console.log("🔍 TABLE DEBUG: Got metadata for table",e);const o=a.columns.filter(e=>e.visible).slice(0,5);console.log("🔍 TABLE DEBUG: Visible columns:",o.length);o.forEach((e,a)=>{console.log(`🔍 TABLE DEBUG: Adding column ${a+1}:`,e.name);t.addColumn(new sap.m.Column({header:new sap.m.Label({text:e.label})}))});console.log("🔍 TABLE DEBUG: Adding actions column");t.addColumn(new sap.m.Column({header:new sap.m.Label({text:"Actions"}),hAlign:"Right"}));console.log("🔍 TABLE DEBUG: Finished adding columns, total:",t.getColumns().length);t.setMode("None");console.log("🔍 TABLE DEBUG: Creating template for binding");const n=new sap.m.ColumnListItem({type:"Inactive"});o.forEach((e,t)=>{console.log(`🔍 TABLE DEBUG: Adding cell ${t+1} for column:`,e.name);let a;switch(e.type){case"relation":a=new sap.m.Text({text:"{viewModel>"+e.name+"_text}"});break;case"boolean":a=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}}});break;case"date":a=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e)return"";return new Date(e).toLocaleDateString()}}});break;case"number":a=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){if(e===undefined||e===null)return"";return parseFloat(e).toFixed(2)}}});break;default:a=new sap.m.Text({text:"{viewModel>"+e.name+"}"})}n.addCell(a)});console.log("🔍 TABLE DEBUG: Adding actions cell to template");const r=new sap.m.HBox({justifyContent:"End",items:[new sap.m.Button({icon:"sap-icon://edit",type:"Transparent",tooltip:"Edit",press:this._handleRelatedItemEdit.bind(this)}).addStyleClass("sapUiTinyMarginEnd"),new sap.m.Button({icon:"sap-icon://display",type:"Transparent",tooltip:"View Details",press:this._handleRelatedItemView.bind(this)}).addStyleClass("sapUiTinyMarginEnd"),new sap.m.Button({icon:"sap-icon://delete",type:"Transparent",tooltip:"Delete",press:this._handleRelatedItemDelete.bind(this)})]});n.addCell(r);try{if(t.isBound("items")){console.log("🔍 TABLE DEBUG: Unbinding existing items");t.unbindItems()}t.bindItems({path:"viewModel>/filteredRelatedItems",template:n});console.log("🔍 TABLE DEBUG: Items bound successfully")}catch(e){console.error("🔍 TABLE DEBUG: Error during item binding:",e)}t.invalidate()}).catch(e=>{console.error("🔍 TABLE DEBUG: Error getting metadata:",e)})}catch(e){console.error("🔍 TABLE DEBUG: Critical error in _configureRelatedItemsTable:",e)}},_handleRelatedItemEdit:function(e){console.log("🔍 HANDLER DEBUG: Edit button clicked");const t=e.getSource();const a=t.getParent().getParent().getParent();const o=a.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");sap.m.MessageBox.error("No relations defined for this entity");return}const t=e.relations[0];const a=t.table;console.log(`Using relation: ${a} with foreign key ${t.foreignKey}`);this.getTableMetadata(a).then(o=>{const s=o.primaryKey;const i=n[s];console.log(`Primary key: ${s}, value: ${i}`);const l=new sap.ui.model.json.JSONModel({entity:JSON.parse(JSON.stringify(n)),validationErrors:{},title:`Edit ${n[o.titleField]||"Related Item"}`});const d=new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:0,emptySpanL:0,emptySpanM:0,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,singleContainerFullSize:false});const c={};o.columns.forEach(e=>{if(e.editable===false||e.name===o.primaryKey||e.name==="created_at"||e.name==="updated_at"){return}const a=e.name===t.foreignKey;d.addContent(new sap.m.Label({text:e.label,required:e.required===true}));let n;if(a){n=new sap.m.Text({text:`Connected to ${r.getProperty("/tableName")} (ID: ${r.getProperty("/entityId")})`})}else if(e.type==="relation"){n=new sap.m.ComboBox({selectedKey:{path:"/entity/"+e.name},width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"});this._loadRelationOptionsForDialog(n,e.relation,e.required===true)}else if(e.type==="boolean"){n=new sap.m.CheckBox({selected:{path:"/entity/"+e.name}})}else if(e.type==="date"){n=new sap.m.DatePicker({value:{path:"/entity/"+e.name,type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}else if(e.type==="number"){n=new sap.m.Input({value:{path:"/entity/"+e.name,type:new sap.ui.model.type.Float({minFractionDigits:0,maxFractionDigits:2})},type:"Number",width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}else if(e.type==="text"){n=new sap.m.TextArea({value:{path:"/entity/"+e.name},rows:3,growing:true,width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}else{n=new sap.m.Input({value:{path:"/entity/"+e.name},width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}d.addContent(n);c[e.name]=n});const m=new sap.m.Dialog({title:"{/title}",contentWidth:"40rem",contentHeight:"auto",resizable:true,draggable:true,content:[d],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){const n=this._validateDialogForm(o,l.getProperty("/entity"),c);if(!n){sap.m.MessageBox.error("Please correct the errors in the form");return}const d=l.getProperty("/entity");d[t.foreignKey]=r.getProperty("/entityId");console.log("Saving updated data:",JSON.stringify(d,null,2));m.setBusy(true);this.getSupabaseClient().from(a).update(d).eq(s,i).then(({data:t,error:a})=>{m.setBusy(false);if(a){console.error("Error updating related item:",a);sap.m.MessageBox.error("Error updating related item: "+a.message);return}console.log("Related item updated successfully:",t);sap.m.MessageToast.show("Related item updated successfully");m.close();this._loadRelatedItems(e,r.getProperty("/entity"))}).catch(e=>{m.setBusy(false);console.error("Error in Supabase query:",e);sap.m.MessageBox.error("Error updating related item: "+e.message)})}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){m.close()}}),afterClose:function(){m.destroy()}});m.setModel(l);this.getView().addDependent(m);m.open()}).catch(e=>{console.error("Error loading related table metadata:",e);sap.m.MessageBox.error("Error loading metadata: "+e.message)})}).catch(e=>{console.error("Error loading parent table metadata:",e);sap.m.MessageBox.error("Error loading metadata: "+e.message)})},_handleRelatedItemView:function(e){console.log("🔍 HANDLER DEBUG: View button clicked");const t=e.getSource();const a=t.getParent().getParent().getParent();const o=a.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const a=e.primaryKey;const o=n[a];console.log(`Navigating to related item details: ${t.table}/${o}`);this.getRouter().navTo("entityDetail",{table:t.table,id:o})})})},_handleRelatedItemDelete:function(e){console.log("🔍 HANDLER DEBUG: Delete button clicked");const t=e.getSource();const a=t.getParent().getParent().getParent();const o=a.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");return}const t=e.relations[0];this.getTableMetadata(t.table).then(e=>{const a=e.primaryKey;const o=n[a];console.log(`Confirming deletion of related item: ${t.table}/${o}`);sap.m.MessageBox.confirm("Are you sure you want to delete this related item?",{title:"Delete Confirmation",onClose:function(e){if(e===sap.m.MessageBox.Action.OK){console.log(`Deleting related item: ${t.table}/${o}`);r.setProperty("/busy",true);this.getSupabaseClient().from(t.table).delete().eq(a,o).then(({error:e})=>{r.setProperty("/busy",false);if(e){console.error("Error deleting related item:",e);sap.m.MessageBox.error("Error deleting related item: "+e.message);return}console.log("Related item deleted successfully");const t=[...r.getProperty("/relatedItems")];const n=[...r.getProperty("/filteredRelatedItems")];const s=t.findIndex(e=>e[a]===o);if(s!==-1){t.splice(s,1);r.setProperty("/relatedItems",t)}const i=n.findIndex(e=>e[a]===o);if(i!==-1){n.splice(i,1);r.setProperty("/filteredRelatedItems",n)}sap.m.MessageToast.show("Related item deleted successfully")}).catch(e=>{r.setProperty("/busy",false);console.error("Error in delete operation:",e);sap.m.MessageBox.error("Error deleting related item: "+e.message)})}}.bind(this)})})})},_setupRelatedItemsTable:function(e){const t=this.getView().byId("relatedItemsTable");if(!t){console.error("Related items table not found");return}t.removeAllColumns();t.removeAllItems();const a=this.getModel("viewModel");const o=a.getProperty("/filteredRelatedItems")||[];this.getTableMetadata(e).then(a=>{if(!a.relations||a.relations.length===0){console.log("No relations defined for table:",e);return}const n=a.relations[0];const r=n.table;this.getTableMetadata(r).then(e=>{const a=e.columns.filter(e=>e.visible).slice(0,4);a.forEach(e=>{t.addColumn(new sap.m.Column({header:new sap.m.Label({text:e.label})}))});t.addColumn(new sap.m.Column({header:new sap.m.Label({text:"Actions"}),hAlign:"End"}));o.forEach((o,r)=>{const s=new sap.m.ColumnListItem({type:"Inactive"});a.forEach(e=>{let t;const a=o[e.name];switch(e.type){case"relation":t=new sap.m.Text({text:o[e.name+"_text"]||a});break;case"boolean":t=new sap.m.Text({text:a?"Yes":"No"});break;case"date":t=new sap.m.Text({text:a?new Date(a).toLocaleDateString():""});break;case"number":t=new sap.m.Text({text:a!==undefined&&a!==null?parseFloat(a).toFixed(2):""});break;default:t=new sap.m.Text({text:a||""})}s.addCell(t)});const i=new sap.m.HBox({justifyContent:"End",items:[new sap.m.Button({icon:"sap-icon://edit",type:"Transparent",tooltip:"Edit",press:function(){this._openEditDialog(n.table,o,e)}.bind(this)}).addStyleClass("sapUiTinyMarginEnd"),new sap.m.Button({icon:"sap-icon://display",type:"Transparent",tooltip:"View Details",press:function(){const t=e.primaryKey;this.getRouter().navTo("entityDetail",{table:n.table,id:o[t]})}.bind(this)}).addStyleClass("sapUiTinyMarginEnd"),new sap.m.Button({icon:"sap-icon://delete",type:"Transparent",tooltip:"Delete",press:function(){this._confirmDeleteItem(n.table,o,e)}.bind(this)})]});s.addCell(i);t.addItem(s)})})})},_openEditDialog:function(e,t,a){const o=new sap.ui.model.json.JSONModel({entity:JSON.parse(JSON.stringify(t)),validationErrors:{},title:`Edit ${t[a.titleField]||"Related Item"}`});const n=new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:0,emptySpanL:0,emptySpanM:0,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,singleContainerFullSize:false});const r={};a.columns.forEach(e=>{if(e.editable===false||e.name===a.primaryKey||e.name==="created_at"||e.name==="updated_at"){return}n.addContent(new sap.m.Label({text:e.label,required:e.required===true}));let t;switch(e.type){case"relation":t=new sap.m.ComboBox({selectedKey:{path:"/entity/"+e.name},width:"100%"});break;case"boolean":t=new sap.m.CheckBox({selected:{path:"/entity/"+e.name}});break;case"date":t=new sap.m.DatePicker({value:{path:"/entity/"+e.name,type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%"});break;case"number":t=new sap.m.Input({value:{path:"/entity/"+e.name,type:new sap.ui.model.type.Float({minFractionDigits:0,maxFractionDigits:2})},type:"Number",width:"100%"});break;case"text":t=new sap.m.TextArea({value:{path:"/entity/"+e.name},rows:3,growing:true,width:"100%"});break;default:t=new sap.m.Input({value:{path:"/entity/"+e.name},width:"100%"})}n.addContent(t);r[e.name]=t});const s=new sap.m.Dialog({title:"{/title}",contentWidth:"40rem",contentHeight:"auto",resizable:true,draggable:true,content:[n],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){const n=o.getProperty("/entity");this.getSupabaseClient().from(e).update(n).eq(a.primaryKey,t[a.primaryKey]).then(({data:e,error:t})=>{if(t){sap.m.MessageBox.error("Error updating item: "+t.message);return}sap.m.MessageToast.show("Item updated successfully");s.close();this._loadRelatedItems(this._oTableMetadata,this.getModel("viewModel").getProperty("/entity"))}).catch(e=>{sap.m.MessageBox.error("Error: "+e.message)})}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){s.close()}}),afterClose:function(){s.destroy()}});s.setModel(o);this.getView().addDependent(s);s.open()},_confirmDeleteItem:function(e,t,a){sap.m.MessageBox.confirm("Are you sure you want to delete this item?",{title:"Delete Confirmation",onClose:function(o){if(o===sap.m.MessageBox.Action.OK){this.getSupabaseClient().from(e).delete().eq(a.primaryKey,t[a.primaryKey]).then(({error:e})=>{if(e){sap.m.MessageBox.error("Error deleting item: "+e.message);return}sap.m.MessageToast.show("Item deleted successfully");this._loadRelatedItems(this._oTableMetadata,this.getModel("viewModel").getProperty("/entity"))}).catch(e=>{sap.m.MessageBox.error("Error: "+e.message)})}}.bind(this)})},_loadRelatedItems:function(e,t){console.log("Starting _loadRelatedItems method");try{const a=this.getModel("viewModel");const o=a.getProperty("/tableId");const n=this.getView().byId("relatedItemsSection");if(n){n.setVisible(true)}if(!e.relations||e.relations.length===0){console.log("No relations defined for table:",o);a.setProperty("/relatedItems",[]);a.setProperty("/filteredRelatedItems",[]);this._setupRelatedItemsTable(o);a.setProperty("/busy",false);return Promise.resolve([])}const r=e.relations[0];const s=e.primaryKey||`${o}_id`;const i=t[s];if(!i){console.error("Primary key value not found in entity data!");a.setProperty("/relatedItems",[]);a.setProperty("/filteredRelatedItems",[]);this._setupRelatedItemsTable(o);a.setProperty("/busy",false);return Promise.resolve([])}this._sRelatedTableId=r.table;console.log(`Loading data from ${r.table} where ${r.foreignKey}=${i}`);return this.getSupabaseClient().from(r.table).select("*").eq(r.foreignKey,i).then(({data:e,error:t})=>{if(t){console.error("Error loading related items:",t);a.setProperty("/busy",false);return[]}const n=e||[];console.log(`Loaded ${n.length} related items`);return this._processRelatedItemsRelations(r.table,n).then(e=>{a.setProperty("/relatedItems",e);a.setProperty("/filteredRelatedItems",e);this._updateDeleteButtonState(e);this._configureRelatedItemsTable(o);a.setProperty("/busy",false);console.log("Related items loading complete");return e})}).catch(e=>{console.error("Error in Supabase query:",e);a.setProperty("/busy",false);return[]})}catch(e){console.error("Critical error in _loadRelatedItems:",e);const t=this.getModel("viewModel");if(t){t.setProperty("/busy",false)}return Promise.resolve([])}},onInit:function(){console.log("EntityDetail controller initialized");const e=new JSONModel({tableName:"",tableId:"",entityId:"",entityTitle:"",entitySubtitle:"",entity:{},originalEntity:{},relatedItems:[],filteredRelatedItems:[],editMode:false,busy:false,delay:0,validationErrors:{},parentInfo:null});this.setModel(e,"viewModel");this.getRouter().getRoute("entityDetail").attachPatternMatched(this._onRouteMatched,this);this._loadParentInfoForEdit();try{this._registerExtensions()}catch(e){console.error("Could not register extensions:",e)}},_loadParentInfoForEdit:function(){try{const e=sessionStorage.getItem("parentEntityInfo");console.log("Checking for parent info in detail view:",e);if(e){const t=JSON.parse(e);if(t.isEditing===true){console.log("Found parent info for edit mode:",JSON.stringify(t,null,2));const e=this.getModel("viewModel");e.setProperty("/parentInfo",t);this._parentInfoBackup=JSON.parse(JSON.stringify(t))}}}catch(e){console.error("Error parsing parent entity info:",e)}},onNavBack:function(){console.log("Back button pressed");const e=this.getModel("viewModel");const t=e.getProperty("/tableId");let a=e.getProperty("/parentInfo");if(!a&&this._parentInfoBackup){console.log("Using parent info backup for back navigation");a=this._parentInfoBackup}if(!a){try{const e=sessionStorage.getItem("parentEntityInfo");if(e){a=JSON.parse(e);console.log("Retrieved parent info from session storage for back navigation")}}catch(e){console.error("Error retrieving parent info from session storage:",e)}}try{sessionStorage.removeItem("parentEntityInfo");console.log("Cleared parent info from session storage")}catch(e){console.warn("Could not clear session storage:",e)}if(a&&a.parentTable&&a.parentId){console.log("Navigating to parent entity after back button:",a.parentTable,a.parentId);try{setTimeout(()=>{this.getRouter().navTo("entityDetail",{table:a.parentTable,id:a.parentId});console.log("Navigation to parent initiated after back button")},100)}catch(e){console.error("Error during navigation to parent after back button:",e);this.getRouter().navTo("entityList",{table:t})}}else{console.log("No parent info, navigating to list view after back button");this.getRouter().navTo("entityList",{table:t})}},_handleRelatedItemEdit:function(e){console.log("🔍 HANDLER DEBUG: Edit button clicked");const t=e.getSource();const a=t.getParent().getParent().getParent();const o=a.getBindingContext("viewModel");if(!o){console.error("No binding context found for related item");return}const n=o.getObject();const r=this.getModel("viewModel");const s=r.getProperty("/tableId");this.getTableMetadata(s).then(e=>{if(!e.relations||e.relations.length===0){console.error("No relations defined in metadata");sap.m.MessageBox.error("No relations defined for this entity");return}const t=e.relations[0];const a=t.table;console.log(`Using relation: ${a} with foreign key ${t.foreignKey}`);this.getTableMetadata(a).then(o=>{const s=o.primaryKey;const i=n[s];console.log(`Primary key: ${s}, value: ${i}`);const l=new sap.ui.model.json.JSONModel({entity:JSON.parse(JSON.stringify(n)),validationErrors:{},title:`Edit ${n[o.titleField]||"Related Item"}`});const d=new sap.ui.layout.form.SimpleForm({editable:true,layout:"ResponsiveGridLayout",labelSpanXL:4,labelSpanL:4,labelSpanM:4,labelSpanS:12,adjustLabelSpan:false,emptySpanXL:0,emptySpanL:0,emptySpanM:0,emptySpanS:0,columnsXL:1,columnsL:1,columnsM:1,singleContainerFullSize:false});const c={};o.columns.forEach(e=>{if(e.editable===false||e.name===o.primaryKey||e.name==="created_at"||e.name==="updated_at"){return}const a=e.name===t.foreignKey;d.addContent(new sap.m.Label({text:e.label,required:e.required===true}));let n;if(a){n=new sap.m.Text({text:`Connected to ${r.getProperty("/tableName")} (ID: ${r.getProperty("/entityId")})`})}else if(e.type==="relation"){n=new sap.m.ComboBox({selectedKey:{path:"/entity/"+e.name},width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"});this._loadRelationOptionsForDialog(n,e.relation,e.required===true)}else if(e.type==="boolean"){n=new sap.m.CheckBox({selected:{path:"/entity/"+e.name}})}else if(e.type==="date"){n=new sap.m.DatePicker({value:{path:"/entity/"+e.name,type:new sap.ui.model.type.Date({pattern:"yyyy-MM-dd"})},valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}else if(e.type==="number"){n=new sap.m.Input({value:{path:"/entity/"+e.name,type:new sap.ui.model.type.Float({minFractionDigits:0,maxFractionDigits:2})},type:"Number",width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}else if(e.type==="text"){n=new sap.m.TextArea({value:{path:"/entity/"+e.name},rows:3,growing:true,width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}else{n=new sap.m.Input({value:{path:"/entity/"+e.name},width:"100%",valueState:"{= ${/validationErrors/"+e.name+"} ? 'Error' : 'None' }",valueStateText:"{/validationErrors/"+e.name+"}"})}d.addContent(n);c[e.name]=n});const m=new sap.m.Dialog({title:"{/title}",contentWidth:"40rem",contentHeight:"auto",resizable:true,draggable:true,content:[d],beginButton:new sap.m.Button({text:"Save",type:"Emphasized",press:function(){const n=this._validateDialogForm(o,l.getProperty("/entity"),c);if(!n){sap.m.MessageBox.error("Please correct the errors in the form");return}const d=l.getProperty("/entity");d[t.foreignKey]=r.getProperty("/entityId");console.log("Saving updated data:",JSON.stringify(d,null,2));m.setBusy(true);this.getSupabaseClient().from(a).update(d).eq(s,i).then(({data:t,error:a})=>{m.setBusy(false);if(a){console.error("Error updating related item:",a);sap.m.MessageBox.error("Error updating related item: "+a.message);return}console.log("Related item updated successfully:",t);sap.m.MessageToast.show("Related item updated successfully");m.close();this._loadRelatedItems(e,r.getProperty("/entity"))}).catch(e=>{m.setBusy(false);console.error("Error in Supabase query:",e);sap.m.MessageBox.error("Error updating related item: "+e.message)})}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){m.close()}}),afterClose:function(){m.destroy()}});m.setModel(l);this.getView().addDependent(m);m.open()}).catch(e=>{console.error("Error loading related table metadata:",e);sap.m.MessageBox.error("Error loading metadata: "+e.message)})}).catch(e=>{console.error("Error loading parent table metadata:",e);sap.m.MessageBox.error("Error loading metadata: "+e.message)})},_validateDialogForm:function(e,t,a){const o={};let n=true;Object.values(a).forEach(e=>{if(e.setValueState){e.setValueState("None");if(e.setValueStateText){e.setValueStateText("")}}});e.columns.forEach(r=>{if(r.editable===false||r.name===e.primaryKey||r.name==="created_at"||r.name==="updated_at"){return}const s=r.name;const i=t[s];const l=a[s];if(!l)return;if(r.required&&(i===undefined||i===null||i==="")){n=false;o[s]="This field is required";if(l.setValueState){l.setValueState("Error");if(l.setValueStateText){l.setValueStateText("This field is required")}}console.log("Required field validation failed:",s);return}if(i===undefined||i===null||i===""){return}let d=true;let c="";switch(r.type){case"number":if(isNaN(parseFloat(i))||!isFinite(i)){d=false;c="Please enter a valid number"}break;case"date":const e=new Date(i);if(isNaN(e.getTime())){d=false;c="Please enter a valid date"}break;case"email":const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;if(!t.test(i)){d=false;c="Please enter a valid email address"}break;case"url":const a=/^(http|https):\/\/[^ "]+$/;if(!a.test(i)){d=false;c="Please enter a valid URL (starting with http:// or https://)"}break}if(!d){n=false;o[s]=c;if(l.setValueState){l.setValueState("Error");if(l.setValueStateText){l.setValueStateText(c)}}console.log("Type validation failed:",s,c)}});return n},_loadRelationOptionsForDialog:function(e,t,a){console.log(`Loading relation options for table ${t}`);this.getTableMetadata(t).then(o=>{const n=o.primaryKey;const r=o.titleField||n;console.log(`Using primary key ${n} and title field ${r}`);this.getSupabaseClient().from(t).select("*").then(({data:o,error:s})=>{if(s){console.error(`Error loading relation options for ${t}:`,s);return}console.log(`Loaded ${o?o.length:0} options from ${t}`);e.removeAllItems();if(!a){e.addItem(new sap.ui.core.Item({key:"",text:"- None -"}))}if(o&&o.length>0){o.forEach(t=>{const a=t[r]||`ID: ${t[n]}`;e.addItem(new sap.ui.core.Item({key:t[n],text:a}));console.log(`Added option: ${t[n]} - ${a}`)})}else{console.log(`No items found in ${t}`)}}).catch(e=>{console.error(`Error in Supabase query for ${t}:`,e)})}).catch(e=>{console.error(`Error getting metadata for relation ${t}:`,e)})},_updateDeleteButtonState:function(e){let t=null;const a=this.getView().byId("ObjectPageLayout");if(a){const e=a.getHeaderTitle();if(e){const a=e.getActions()||[];for(let e=0;e<a.length;e++){const o=a[e];if(o.getIcon&&o.getIcon()==="sap-icon://delete"){t=o;break}}}}if(!t){t=this.getView().byId("deleteButton")}if(t){const a=e&&e.length>0;t.setEnabled(!a);if(a){t.setTooltip("Cannot delete while related items exist")}else{t.setTooltip("Delete this entity")}}},_updateDeleteButtonState:function(e){const t=this.getView().byId("ObjectPageLayout");if(t){const a=t.getHeaderTitle();if(a){const t=a.getActions()||[];for(let a=0;a<t.length;a++){const o=t[a];if(o.getIcon&&o.getIcon()==="sap-icon://delete"){const t=e&&e.length>0;o.setEnabled(!t);if(t){o.setTooltip("Cannot delete while related items exist")}else{o.setTooltip("Delete this entity")}break}}}}}})});
//# sourceMappingURL=EntityDetailRelatedItems.controller.js.map