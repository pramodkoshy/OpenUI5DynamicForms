sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/Label","sap/m/Input","sap/m/DatePicker","sap/m/CheckBox","sap/m/ComboBox","sap/m/Token","sap/m/Dialog","sap/m/List","sap/m/StandardListItem","sap/ui/core/Item","sap/ui/layout/form/SimpleForm","sap/m/MessageToast","sap/m/MessageBox","sap/m/Button"],function(e,t,o,n,r,i,s,a,l,c,d,h,u,m,f,g,p,y){"use strict";return e.extend("com.supabase.easyui5.controller.EntityList",{_isAdjustingWidths:false,onInit:function(){const e=new t({tableName:"",tableId:"",items:[],allItems:[],busy:false,visibleColumns:[],availableColumns:[],filterCriteria:{},filterInfo:""});this.setModel(e,"viewModel");this.getRouter().getRoute("entityList").attachPatternMatched(this._onRouteMatched,this);this.getView().addEventDelegate({onAfterRendering:function(){setTimeout(this._forceColumnWidths.bind(this),500)}.bind(this)},this);this._resizeHandler=this._onWindowResize.bind(this);window.addEventListener("resize",this._resizeHandler)},onExit:function(){if(this._resizeHandler){window.removeEventListener("resize",this._resizeHandler)}jQuery(".horizontalScrollWrapper").remove()},_onWindowResize:function(){if(this._resizeTimer){clearTimeout(this._resizeTimer)}this._resizeTimer=setTimeout(function(){const e=this.getModel("viewModel");const t=e.getProperty("/visibleColumns")||[];if(t.length>5){this._createTopScrollContainer(t.length*6)}}.bind(this),250)},onAfterRendering:function(){try{var e=this.byId("entityTable");if(!e){return}var t=this.getModel("viewModel");if(!t){console.log("View model not available yet in onAfterRendering");return}try{var o=t.getProperty("/visibleColumns")||[];if(o.length>5){this._createTopScrollContainer(o.length);setTimeout(this._forceColumnWidths.bind(this),300)}var n=this.byId("dynamicPageId");if(n){n.setHeaderExpanded(false)}}catch(e){console.log("Could not access view model properties:",e)}}catch(e){console.error("Error in onAfterRendering:",e)}},onToggleNav:function(){try{const e=sap.ui.getCore().byId("content");let t=null;if(this.getOwnerComponent()&&this.getOwnerComponent().getSplitApp){t=this.getOwnerComponent().getSplitApp()}if(!t&&this.getOwnerComponent()&&this.getOwnerComponent().getRootControl){const e=this.getOwnerComponent().getRootControl();if(e){t=e.byId("app")}}if(!t){t=sap.ui.getCore().byId("__component0---app");if(!t){t=sap.ui.getCore().byId("__xmlview0--app")}}if(!t){const e=sap.ui.getCore().byFieldGroupId("").filter(function(e){return e instanceof sap.m.SplitApp});if(e.length>0){t=e[0]}}if(!t){console.error("SplitApp control not found!");return}const o=this.getOwnerComponent().getModel("appView");if(!o){console.error("AppView model not found!");return}const n=o.getProperty("/navExpanded");const r=this.getView().byId("navToggleButton");console.log("Entity List toggle nav button pressed. Current state:",n?"expanded":"collapsed");if(n){if(sap.ui.Device.system.phone){t.hideMaster()}else{const e=t.getMode();if(e!=="HideMode"&&e!=="ShowHideMode"){t.setMode("ShowHideMode")}t.hideMaster()}if(r){r.setIcon("sap-icon://menu2");r.setTooltip("Show Navigation")}o.setProperty("/navExpanded",false)}else{if(sap.ui.Device.system.phone){t.showMaster()}else{t.setMode("ShowHideMode");t.showMaster()}if(r){r.setIcon("sap-icon://navigation-left-arrow");r.setTooltip("Hide Navigation")}o.setProperty("/navExpanded",true)}}catch(e){console.error("Error in menu toggle:",e)}},_onRouteMatched:function(e){console.log("1. _onRouteMatched started");const t=e.getParameter("arguments").table;console.log("2. Table ID:",t);const o=this.getModel("viewModel");console.log("3. ViewModel:",o?"available":"not available");o.setProperty("/filterCriteria",{});o.setProperty("/visibleColumns",[]);o.setProperty("/availableColumns",[]);o.setProperty("/filterInfo","");const n=t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ");o.setProperty("/tableName",n);o.setProperty("/tableId",t);this.getView().byId("entityListPage").setTitle(n+" List");try{const e=this.getView().byId("dynamicPageId");if(e){e.setHeaderExpanded(false)}}catch(e){console.error("Error setting header state:",e)}console.log("4. About to call getTableMetadata");this.getTableMetadata(t).then(e=>{console.log("5. Metadata received:",e);this._tableMetadata=e;this._configureSearchForm(e);this._configureTable(e);console.log("6. About to call _loadData");this._loadData(t,e)}).catch(e=>{console.error("Error loading metadata:",e);p.error("Failed to load table metadata: "+e.message)})},_configureSearchForm:function(e){const t=this.getView().byId("searchForm");t.removeAllContent();e.columns.forEach(e=>{if(!e.visible||e.name==="created_at"||e.name==="updated_at"){return}t.addContent(new r({text:e.label,tooltip:"Search by "+e.label}));let o;switch(e.type){case"date":o=new s({valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%"});break;case"boolean":o=new l({width:"100%",items:[new m({key:"",text:"All"}),new m({key:"true",text:"Yes"}),new m({key:"false",text:"No"})]});break;case"relation":o=new l({width:"100%",showSecondaryValues:true});this._loadRelationOptions(o,e.relation,e.name);break;default:o=new i({width:"100%"})}o.data("columnName",e.name);o.data("columnType",e.type);t.addContent(o)})},_configureTable:function(e){const t=this.getView().byId("entityTable");const o=this.getModel("viewModel");t.setFixedLayout(true);t.setSticky(["ColumnHeaders"]);t.removeAllColumns();const n=e.columns.filter(e=>e.visible).slice(0,7);o.setProperty("/visibleColumns",n);const r=e.columns.filter(e=>e.visible);o.setProperty("/availableColumns",r);n.forEach((e,o)=>{let n=this._getOptimizedColumnWidth(e.type,o,e.name);const r=new sap.m.Column({header:new sap.m.Label({text:e.label,design:"Bold"}),width:n,hAlign:e.type==="number"?"End":"Begin",demandPopin:true,minScreenWidth:"Tablet"});r.data("columnName",e.name);r.data("columnType",e.type);t.addColumn(r)});var i=new sap.m.ColumnListItem({type:"Navigation",press:this.onItemPress.bind(this)});n.forEach(function(e){var t;switch(e.type){case"date":t=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e)return"";return new Date(e).toLocaleDateString()}}});break;case"boolean":t=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}}});break;case"relation":t=new sap.m.Text({text:{path:"viewModel>"+e.name+"_text"}});break;default:t=new sap.m.Text({text:"{viewModel>"+e.name+"}"})}i.addCell(t)});t.unbindItems();t.bindItems({path:"viewModel>/items",template:i,templateShareable:false});if(n.length>5){setTimeout(()=>{this._createTopScrollContainer(n.length*6)},300)}},_getOptimizedColumnWidth:function(e,t,o){let n;switch(e){case"boolean":n="5rem";break;case"date":n="8rem";break;case"number":case"integer":n="7rem";break;case"email":case"url":n="12rem";break;case"relation":n="10rem";break;default:if(t===0){n="10rem"}else if(t===1){n="12rem"}else if(t===2){n="12rem"}else{n="9rem"}}if(o){const e=o.toLowerCase();if(e.includes("id")&&e!=="id"){n="6rem"}else if(e==="id"){n="5rem"}else if(e.includes("code")||e.includes("status")){n="6rem"}else if(e==="entity_id"){n="6rem"}else if(e==="entity_type"){n="8rem"}}return n},_populateRelationComboBox:function(e,t,o,n){if(!e)return;e.removeAllItems();e.addItem(new sap.ui.core.Item({key:"",text:"All"}));if(t&&t.length>0){t.forEach(t=>{e.addItem(new sap.ui.core.Item({key:t[o],text:t[n]||t[o]}))})}},_loadRelationOptions:function(e,t,o){if(this._relationCache&&this._relationCache[t]){const o=this._relationCache[t];this._populateRelationComboBox(e,o.items,o.metadata.primaryKey,o.metadata.titleField);return}this.getTableMetadata(t).then(n=>{const r=n.primaryKey;const i=n.titleField||r;this.getSupabaseClient().from(t).select(`${r}, ${i}`).then(({data:s,error:a})=>{if(a){console.error(`Error loading relation options for ${o}:`,a);return}if(!this._relationCache){this._relationCache={}}this._relationCache[t]={items:s,metadata:n,lookup:s.reduce((e,t)=>{e[t[r]]=t[i];return e},{})};this._populateRelationComboBox(e,s,r,i)}).catch(e=>{console.error(`Error in Supabase query for relation options:`,e)})}).catch(e=>{console.error(`Error getting metadata for relation ${t}:`,e)})},onColumnsButtonPress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/availableColumns");const o=e.getProperty("/visibleColumns");if(!this._oColumnDialog){this._oColumnDialog=new sap.m.Dialog({title:"Select Columns",contentWidth:"400px",content:new sap.m.List({mode:"MultiSelect",includeItemInSelection:true,items:{path:"columns>/",template:new sap.m.StandardListItem({title:"{columns>label}",description:"{columns>name}",type:"Active",selected:{path:"columns>visible",formatter:function(e){return e===true}}})}}),beginButton:new sap.m.Button({text:"Apply",type:"Emphasized",press:function(){const t=this._oColumnDialog.getContent()[0];const o=t.getSelectedItems();if(o.length===0){sap.m.MessageToast.show("Please select at least one column.");return}const n=o.map(e=>{const t=e.getBindingContext("columns");const o=t.getPath();const n=this._oColumnDialog.getModel("columns").getProperty(o);const r=this.getModel("viewModel");const i=r.getProperty("/availableColumns");return i.find(e=>e.name===n.name)}).filter(e=>e!==undefined);console.log("Selected columns:",n.map(e=>e.name));e.setProperty("/visibleColumns",n);this._reconfigureTable(n);setTimeout(()=>{const e=this.getView().byId("entityTable");const t=e.getBinding("items");if(t){t.refresh(true)}},100);this._oColumnDialog.close();setTimeout(this._forceColumnWidths.bind(this),200);setTimeout(this._forceColumnWidths.bind(this),600)}.bind(this)}),endButton:new sap.m.Button({text:"Cancel",press:function(){this._oColumnDialog.close()}.bind(this)})});this.getView().addDependent(this._oColumnDialog)}const n=t.map(e=>({name:e.name,label:e.label,type:e.type,visible:o.some(t=>t.name===e.name)}));this._oColumnDialog.setModel(new sap.ui.model.json.JSONModel(n),"columns");this._oColumnDialog.open()},_reconfigureTableWithFixedWidths:function(e){const t=this.getView().byId("entityTable");t.setWidth("100%");t.removeAllColumns();let i=t.getBindingInfo("items")&&t.getBindingInfo("items").template;if(!i){i=new sap.m.ColumnListItem({type:"Navigation",press:this.onItemPress.bind(this)})}else{i.removeAllCells()}const s=Math.max(jQuery(t.getDomRef()).width(),800);const a=Math.floor(s/(e.length||1));const l=80;console.log("Table width:",s,"Average column width:",a);let c=0;e.forEach((e,s)=>{let a;switch(e.type){case"boolean":a=5;break;case"date":a=8;break;case"number":case"integer":a=7;break;case"email":case"url":a=10;break;case"relation":a=8;break;default:if(s===0){a=8}else if(s===1){a=10}else if(s===2){a=10}else{a=7}}if(e.name){const t=e.name.toLowerCase();if(t.includes("id")&&t!=="id"){a=6}else if(t==="id"){a=5}else if(t.includes("code")||t.includes("status")){a=6}}c+=a;const l=a+"rem";const d=new o({header:new r({text:e.label,design:"Bold"}),width:l,minScreenWidth:"Tablet",demandPopin:true,popinDisplay:"Inline",hAlign:e.type==="number"||e.type==="integer"?"End":"Begin"});d.data("columnName",e.name);d.data("columnType",e.type);t.addColumn(d);let h;switch(e.type){case"date":h=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e){return""}return new Date(e).toLocaleDateString()}},wrapping:false});break;case"boolean":h=new n({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}},wrapping:false});break;case"relation":h=new n({text:{path:"viewModel>"+e.name+"_text"},wrapping:false});break;case"number":h=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(e===undefined||e===null)return"";return parseFloat(e).toFixed(2)}},wrapping:false});break;default:h=new n({text:"{viewModel>"+e.name+"}",wrapping:false,maxLines:1})}i.addCell(h)});console.log("Total allocated width (rem):",c);t.unbindItems();t.bindItems({path:"viewModel>/items",template:i});setTimeout(function(){this._createFixedWidthScrollContainer(c)}.bind(this),100)},_createFixedScrollContainer:function(e){try{var t=this.byId("entityTable");if(!t)return;var o=t.$().parent();if(!o.length)return;jQuery(".tableScrollContainer").remove();var n=document.createElement("div");n.className="tableScrollContainer";n.style.width="100%";n.style.overflowX="auto";n.style.position="sticky";n.style.top="0";n.style.zIndex="99";n.style.backgroundColor="#fff";n.style.borderBottom="1px solid #e5e5e5";n.style.padding="4px 0";var r=parseFloat(getComputedStyle(document.documentElement).fontSize);var i=Math.max(e*r,o.width());var s=document.createElement("div");s.style.width=i+"px";s.style.height="16px";n.appendChild(s);o.prepend(n);var a=t.$().find("table");if(a.length){a.css({"min-width":i+"px",width:i+"px","table-layout":"fixed"})}if(!document.getElementById("fixedScrollStyles")){var l=document.createElement("style");l.id="fixedScrollStyles";l.innerHTML=`\n                        .tableScrollContainer::-webkit-scrollbar {\n                            height: 8px;\n                            background-color: #f5f5f5;\n                        }\n                        \n                        .tableScrollContainer::-webkit-scrollbar-thumb {\n                            border-radius: 4px;\n                            background-color: #999;\n                        }\n                        \n                        .tableScrollContainer::-webkit-scrollbar-thumb:hover {\n                            background-color: #777;\n                        }\n                        \n                        .tableScrollContainer {\n                            scrollbar-width: thin;\n                            scrollbar-color: #999 #f5f5f5;\n                        }\n                        \n                        .sapMListTblHeader {\n                            position: sticky !important;\n                            top: 28px !important; \n                            z-index: 98 !important;\n                        }\n                    `;document.head.appendChild(l)}n.addEventListener("scroll",function(){var e=t.$().find(".sapMListTblCnt");if(e.length){e.scrollLeft(this.scrollLeft)}});t.$().find(".sapMListTblCnt").on("scroll",function(){n.scrollLeft=this.scrollLeft});console.log("Fixed scroll container created")}catch(e){console.error("Error creating fixed scroll container:",e)}},_reconfigureTable:function(e){const t=this.getView().byId("entityTable");t.removeAllColumns();let i=t.getBindingInfo("items")&&t.getBindingInfo("items").template;if(!i){i=new sap.m.ColumnListItem({type:"Navigation",press:this.onItemPress.bind(this)})}else{i.removeAllCells()}e.forEach((e,s)=>{let a=this._getOptimizedColumnWidth(e.type,s,e.name);const l=new o({header:new r({text:e.label,design:"Bold"}),width:a,minScreenWidth:"Tablet",demandPopin:true,popinDisplay:"Inline",hAlign:e.type==="number"||e.type==="integer"?"End":"Begin"});l.data("columnName",e.name);l.data("columnType",e.type);t.addColumn(l);let c;switch(e.type){case"date":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e){return""}return new Date(e).toLocaleDateString()}},wrapping:false});break;case"boolean":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}},wrapping:false});break;case"relation":c=new n({text:{path:"viewModel>"+e.name+"_text"},wrapping:false});break;case"number":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(e===undefined||e===null)return"";return parseFloat(e).toFixed(2)}},wrapping:false});break;default:c=new n({text:"{viewModel>"+e.name+"}",wrapping:false,maxLines:2})}c.addStyleClass("sapUiTinyMarginBeginEnd");i.addCell(c)});t.unbindItems();t.bindItems({path:"viewModel>/items",template:i});if(e.length>5){setTimeout(function(){this._createTopScrollContainer(e.length*6)}.bind(this),300)}else{jQuery(".horizontalScrollWrapper").remove()}},onServerSearchPress:function(){try{var e=this.getView().byId("dynamicPageId");if(e){e.setHeaderExpanded(true);g.show("Server search activated - use form to search database")}}catch(e){console.error("Error in server search button handler:",e);g.show("Could not activate server search form")}},onResetSearch:function(){const e=this.getView().byId("searchForm");const t=e.getContent();for(let e=0;e<t.length;e++){const o=t[e];if(o instanceof r){continue}if(o instanceof l){o.setSelectedKey("")}else if(o instanceof a){o.setSelected(false)}else if(o instanceof s){o.setValue("")}else{o.setValue("")}}const o=this.getModel("viewModel");o.setProperty("/filterCriteria",{});o.setProperty("/filterInfo","");o.setProperty("/items",o.getProperty("/allItems"));const n=o.getProperty("/items");const i=n.length+" "+(n.length===1?"item":"items");this.getView().byId("tableCountText").setText(i);g.show("Search criteria reset. Showing all records.");const c=o.getProperty("/visibleColumns")||[];if(c.length>5){setTimeout(function(){this._createTopScrollContainer(c.length*12)}.bind(this),300)}},onSearch:function(e){const t=e.getParameter("query").toLowerCase();const o=this.getModel("viewModel");const n=[...o.getProperty("/allItems")];if(!t){o.setProperty("/items",n);o.setProperty("/filterInfo","");const e=n.length+" "+(n.length===1?"item":"items");this.getView().byId("tableCountText").setText(e);return}const r=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t));o.setProperty("/items",r);o.setProperty("/filterInfo","Table search for: "+t);const i=r.length+" "+(r.length===1?"item":"items")+" (filtered)";this.getView().byId("tableCountText").setText(i);const s=o.getProperty("/visibleColumns")||[];if(s.length>5){setTimeout(function(){this._createTopScrollContainer(s.length*12)}.bind(this),300)}},onItemPress:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");if(!o){console.error("No binding context found");return}const n=o.getObject();const r=this.getModel("viewModel");const i=r.getProperty("/tableId");console.log("Item clicked:",n);console.log("Table ID:",i);if(!i){console.error("Table ID is empty. Cannot navigate.");g.show("Navigation error: Cannot determine table");return}this.getTableMetadata(i).then(e=>{const t=e.primaryKey||`${i}_id`;console.log("Primary key field:",t);console.log("Item data keys:",Object.keys(n));const o=n[t];if(o===undefined){console.error("Primary key value is undefined. Cannot navigate.");g.show("Navigation error: Record ID not found");return}console.log("Navigating to detail with ID:",o);try{this.getRouter().navTo("entityDetail",{table:i,id:o},false);console.log("Navigation call completed")}catch(e){console.error("Navigation error:",e);g.show("Navigation error: "+e.message)}}).catch(e=>{console.error("Error getting metadata for navigation:",e);g.show("Navigation error: Could not retrieve table metadata")})},onCreatePress:function(){const e=this.getModel("viewModel").getProperty("/tableId");this.getRouter().navTo("entityCreate",{table:e})},onRefreshPress:function(){const e=this.getModel("viewModel").getProperty("/tableId");const t=this.getModel("viewModel");t.setProperty("/filterCriteria",{});t.setProperty("/filterInfo","");const o=this.getView().byId("searchForm");const n=o.getContent();for(let e=0;e<n.length;e++){const t=n[e];if(t instanceof r){continue}if(t instanceof l){t.setSelectedKey("")}else if(t instanceof a){t.setSelected(false)}else if(t instanceof s){t.setValue("")}else{t.setValue("")}}const i=this.getView().byId("quickSearch");if(i){i.setValue("")}const c=this.getView().byId("tableSearch");if(c){c.setValue("")}this.getTableMetadata(e).then(t=>{this._loadData(e,t)})},onExportPress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/items");const o=e.getProperty("/tableName");if(!t||t.length===0){g.show("No data to export");return}const n=e.getProperty("/visibleColumns");const r=n.map(e=>e.label);const i=n.map(e=>e.name);let s=r.join(",")+"\n";t.forEach(e=>{const t=i.map(t=>{const o=e[t]===undefined?"":e[t];if(typeof o==="string"){return`"${o.replace(/"/g,'""')}"`}else if(o===null){return""}else{return o}});s+=t.join(",")+"\n"});const a=new Blob([s],{type:"text/csv;charset=utf-8"});const l=`${o}_Export_${(new Date).toISOString().split("T")[0]}.csv`;if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveBlob(a,l)}else{const e=document.createElement("a");e.href=URL.createObjectURL(a);e.download=l;document.body.appendChild(e);e.click();document.body.removeChild(e)}g.show(`Exported ${t.length} records to ${l}`)},onNavBack:function(){this.navBack()},_createTopScrollContainer:function(e){if(!this._scrollRetryCount){this._scrollRetryCount=0}if(this._scrollContainerInProgress||this._scrollRetryCount>5){if(this._scrollRetryCount>5){console.warn("Maximum scroll container retry attempts reached - giving up");this._scrollRetryCount=0}return}this._scrollContainerInProgress=true;this._scrollRetryCount++;try{var t=this.byId("entityTable");if(!t){console.error("Table control not found");this._scrollContainerInProgress=false;return}var o=t.getDomRef();if(!o){console.log("Table DOM not ready - scheduling retry #"+this._scrollRetryCount);if(this._scrollRetryCount<=5){setTimeout(function(){this._scrollContainerInProgress=false;this._createTopScrollContainer(e)}.bind(this),1e3)}else{console.warn("Maximum retry attempts reached - giving up");this._scrollRetryCount=0;this._scrollContainerInProgress=false}return}this._scrollRetryCount=0;console.log("Creating horizontal scroll container");jQuery(".horizontalScrollWrapper").remove();const l=this._shouldShowScrollOnBottom(t,o);console.log("Scroll position:",l?"bottom":"top");var n=document.createElement("div");n.className="horizontalScrollWrapper";n.style.width="100%";n.style.overflowX="auto";n.style.position=l?"fixed":"sticky";n.style.zIndex="100";n.style.height="16px";n.style.background="#f5f5f5";n.style.borderRadius="4px";n.style.border="1px solid #e5e5e5";if(l){n.style.bottom="60px";n.style.left="0";n.style.right="0"}else{n.style.top="0"}var r=parseInt(getComputedStyle(document.documentElement).fontSize)||16;var i=e*r;var s=document.createElement("div");s.style.width=i+"px";s.style.height="1px";n.appendChild(s);if(l){document.body.appendChild(n)}else{o.parentNode.insertBefore(n,o)}var a=t.$().find(".sapMListTbl");if(a.length){a.css({"min-width":i+"px","table-layout":"fixed"})}jQuery(o).css({"overflow-x":"hidden","min-width":"100%"});n.addEventListener("scroll",function(){var e=jQuery(o).find(".sapMListTbl");if(e.length){e.css("margin-left",-this.scrollLeft+"px")}});if(l){const e=jQuery(o).find(".sapMListItems");if(e.length){e.on("scroll",function(){n.scrollLeft=this.scrollLeft})}}console.log("Scroll container created successfully")}catch(e){console.error("Error creating scroll container:",e)}finally{setTimeout(function(){this._scrollContainerInProgress=false}.bind(this),300)}},_shouldShowScrollOnBottom:function(e,t){try{const o=e.getItems();const n=o.length;if(n===0){return false}const r=window.innerHeight;const i=t.getBoundingClientRect();const s=i.top;const a=o[0];if(a&&a.getDomRef()){const e=a.getDomRef().offsetHeight;const t=50;const o=60;const i=t+e*n;const l=r-s-o;console.log(`Table visibility check: ${n} rows, total height: ${i}px, available: ${l}px`);return i<=l}return false}catch(e){console.error("Error determining scroll position:",e);return false}},_getOptimizedColumnWidth:function(e,t,o){let n;switch(e){case"boolean":n="5rem";break;case"date":n="8rem";break;case"number":case"integer":n="7rem";break;case"email":case"url":n="12rem";break;case"relation":n="10rem";break;default:if(t===0){n="10rem"}else if(t===1){n="12rem"}else if(t===2){n="12rem"}else{n="9rem"}}if(o){const e=o.toLowerCase();if(e.includes("id")&&e!=="id"){n="6rem"}else if(e==="id"){n="5rem"}else if(e.includes("code")||e.includes("status")){n="6rem"}}return n},_forceColumnWidths:function(){if(this._isAdjustingWidths){console.log("Width adjustment already in progress, skipping");return}try{this._isAdjustingWidths=true;var e=this.byId("entityTable");if(!e)return;var t=e.getColumns();if(!t||t.length===0)return;console.log("Forcing strict column widths for",t.length,"columns");var o="";o+=`\n                    #${e.getId()} table {\n                        table-layout: fixed !important;\n                        width: auto !important;\n                    }\n                    \n                    #${e.getId()} .sapMListTblCell {\n                        padding-left: 4px !important;\n                        padding-right: 4px !important;\n                        overflow: hidden;\n                        text-overflow: ellipsis;\n                        white-space: nowrap;\n                    }\n                `;t.forEach(function(e,t){var n=e.getId();var r=e.data("columnType")||"string";var i=e.data("columnName")||"";var s;switch(r){case"boolean":s="50px";break;case"date":s="80px";break;case"number":case"integer":s="70px";break;case"relation":s="100px";break;default:if(t===0){s="80px"}else if(t===1){s="100px"}else{s="90px"}}if(i){var a=i.toLowerCase();if(a.includes("id")&&a!=="id"){s="60px"}else if(a==="id"){s="50px"}}o+=`\n                        #${n} {\n                            width: ${s} !important;\n                            max-width: ${s} !important;\n                            min-width: 0 !important;\n                        }\n                    `});var n="entityTableColumnStyles";var r=document.getElementById(n);if(!r){r=document.createElement("style");r.id=n;document.head.appendChild(r)}r.innerHTML=o;jQuery("#"+e.getId()).find(".sapMListTbl").css({"table-layout":"fixed",width:"auto"});console.log("Column width styles applied directly to DOM")}catch(e){console.error("Error forcing column widths:",e)}finally{this._isAdjustingWidths=false}},_loadData:function(e,t,o){console.log("_loadData started for table:",e);const n=this.getModel("viewModel");n.setProperty("/busy",true);const r=this.getOwnerComponent().getEntityCacheManager();const i={ignoreCache:o===true};r.getEntityData(e,i,()=>{console.log("Loading fresh data from server for:",e);return new Promise((o,n)=>{const r=this.getSupabaseClient();r.from(e).select("*").then(async({data:e,error:r})=>{if(r){console.error("Error loading data:",r);n(r);return}e=e||[];console.log(`Loaded ${e.length} records from server`);if(t&&t.columns){const e=t.columns.filter(e=>e.type==="relation");if(e.length>0){}}o(e)}).catch(e=>{console.error("Error in Supabase query:",e);n(e)})})}).then(e=>{n.setProperty("/items",e);n.setProperty("/allItems",[...e]);const o=e.length+" "+(e.length===1?"item":"items");this.getView().byId("tableCountText").setText(o);var r=this.byId("entityTable");if(r){var i=r.getBinding("items");if(i){console.log("Refreshing existing table binding");i.refresh(true)}else{console.log("No binding found, table may need configuration");var s=n.getProperty("/visibleColumns")||[];if(s.length>0){this._configureTable(t)}}}}).catch(e=>{console.error("Error loading data:",e);this.showErrorMessage("Error loading data",e)}).finally(()=>{n.setProperty("/busy",false)})},_executeAdvancedSearch:function(e,t){const o=this.getModel("viewModel");o.setProperty("/busy",true);let n=this.getSupabaseClient().from(e).select("*");const r=[];Object.keys(t).forEach(e=>{const o=t[e];const i=o.value;const s=o.type;if(s==="relation"||s==="number"||s==="boolean"){n=n.eq(e,i);r.push(`${e} = ${i}`)}else if(s==="date"){n=n.eq(e,i);r.push(`${e} = ${i}`)}else{n=n.ilike(e,`%${i}%`);r.push(`${e} contains "${i}"`)}});n.then(async({data:e,error:t})=>{if(t){console.error("Error executing search:",t);this.showErrorMessage("Error executing search",t);o.setProperty("/busy",false);return}e=e||[];console.log(`Search returned ${e.length} records`);for(let t=0;t<e.length;t++){for(const o of this._tableMetadata.columns){if(o.type==="relation"&&e[t][o.name]){const n=e[t][o.name];const r=o.relation;try{const i=await this.getTableMetadata(r);const{data:s,error:a}=await this.getSupabaseClient().from(r).select("*").eq(i.primaryKey,n).single();if(!a&&s){e[t][o.name+"_text"]=s[i.titleField]}}catch(e){console.error("Error loading related data",e)}}}}const n=this.getOwnerComponent().getEntityCacheManager();o.setProperty("/items",e);const i=r.length>0?"Filtered by: "+r.join(", "):"";o.setProperty("/filterInfo",i);const s=e.length+" "+(e.length===1?"item":"items")+(r.length>0?" (filtered)":"");this.getView().byId("tableCountText").setText(s);o.setProperty("/busy",false);const a=o.getProperty("/visibleColumns")||[];if(a.length>5){setTimeout(()=>{this._createTopScrollContainer(a.length*6)},300)}}).catch(e=>{console.error("Error in Supabase query:",e);o.setProperty("/busy",false)})},onRefreshPress:function(){const e=this.getModel("viewModel").getProperty("/tableId");const t=this.getModel("viewModel");t.setProperty("/filterCriteria",{});t.setProperty("/filterInfo","");const o=this.getView().byId("searchForm");const n=o.getContent();for(let e=0;e<n.length;e++){const t=n[e];if(t instanceof r){continue}if(t instanceof l){t.setSelectedKey("")}else if(t instanceof a){t.setSelected(false)}else if(t instanceof s){t.setValue("")}else{t.setValue("")}}const i=this.getView().byId("quickSearch");if(i){i.setValue("")}const c=this.getView().byId("tableSearch");if(c){c.setValue("")}const d=this.getOwnerComponent().getEntityCacheManager();d.clearEntityCache(e);this.getTableMetadata(e).then(t=>{this._loadData(e,t,true)});g.show("Refreshing data from server...")},onAdvancedSearch:function(){console.log("Starting advanced search...");const e=this.getView().byId("searchForm");const t=this.getModel("viewModel");const o=t.getProperty("/tableId");console.log("Current table ID:",o);const n={};let i=false;const c=e.getContent();for(let e=0;e<c.length;e++){const t=c[e];if(t instanceof r){continue}const o=t.data("columnName");const d=t.data("columnType");let h;if(t instanceof l){h=t.getSelectedKey()}else if(t instanceof a){h=t.getSelected()?"true":"false"}else if(t instanceof s){h=t.getValue()}else{h=t.getValue()}if(h&&h.trim()!==""){n[o]={value:h,type:d};i=true;console.log(`Added filter: ${o} = ${h} (${d})`)}}const d=this.getOwnerComponent().getEntityCacheManager();if(d){console.log(`Explicitly clearing cache for ${o} before search`);d.clearEntityCache(o);if(d.isCached(o)){console.error(`WARNING: Cache for ${o} was not properly cleared!`)}else{console.log(`Confirmed: Cache for ${o} is now cleared`)}}else{console.error("Cache manager not available!")}if(!i){console.log("No search criteria specified, loading all data from server");t.setProperty("/busy",true);this.getSupabaseClient().from(o).select("*").then(async({data:e,error:n})=>{if(n){console.error("Error loading data:",n);this.showErrorMessage("Error loading data",n);t.setProperty("/busy",false);return}e=e||[];console.log(`Loaded ${e.length} records directly from server`);if(d){console.log(`Explicitly updating cache for ${o} with ${e.length} records`);d.setEntityCache(o,e);if(d.isCached(o)){console.log(`Confirmed: Cache for ${o} has been updated`)}else{console.error(`WARNING: Cache for ${o} was not properly updated!`)}}t.setProperty("/items",e);t.setProperty("/allItems",[...e]);t.setProperty("/filterInfo","");const r=e.length+" "+(e.length===1?"item":"items");this.getView().byId("tableCountText").setText(r);t.setProperty("/busy",false);g.show("Loaded all records from server")}).catch(e=>{console.error("Error loading data:",e);t.setProperty("/busy",false)});return}t.setProperty("/filterCriteria",n);console.log("Executing server search with filters:",Object.keys(n).length);this._executeAdvancedSearch(o,n)},_executeAdvancedSearch:function(e,t){console.log("Starting server search execution for",e);const o=this.getModel("viewModel");o.setProperty("/busy",true);let n=this.getSupabaseClient().from(e).select("*");const r=[];Object.keys(t).forEach(e=>{const o=t[e];const i=o.value;const s=o.type;if(s==="relation"||s==="number"||s==="boolean"){n=n.eq(e,i);r.push(`${e} = ${i}`)}else if(s==="date"){n=n.eq(e,i);r.push(`${e} = ${i}`)}else{n=n.ilike(e,`%${i}%`);r.push(`${e} contains "${i}"`)}});console.log("Executing Supabase query with filters:",r);n.then(async({data:t,error:n})=>{if(n){console.error("Error executing search:",n);this.showErrorMessage("Error executing search",n);o.setProperty("/busy",false);return}t=t||[];console.log(`Search returned ${t.length} records from server`);const i=this.getOwnerComponent().getEntityCacheManager();if(i){console.log(`Explicitly updating cache for ${e} with ${t.length} records from search`);if(i.isCached(e)){console.warn(`Cache for ${e} was not cleared properly. Clearing now.`);i.clearEntityCache(e)}i.setEntityCache(e,t);if(i.isCached(e)){console.log(`Confirmed: Cache for ${e} has been updated with search results`)}else{console.error(`WARNING: Failed to update cache for ${e}!`)}}else{console.error("Cache manager not available during search results processing!")}o.setProperty("/items",t);o.setProperty("/allItems",[...t]);const s=r.length>0?"Filtered by: "+r.join(", "):"";o.setProperty("/filterInfo",s);const a=t.length+" "+(t.length===1?"item":"items")+(r.length>0?" (filtered)":"");this.getView().byId("tableCountText").setText(a);o.setProperty("/busy",false);g.show(`Search complete: Found ${t.length} records`);if(this._scrollTimerId){clearTimeout(this._scrollTimerId)}this._scrollTimerId=setTimeout(()=>{var e=o.getProperty("/visibleColumns")||[];if(e.length>5){this._createTopScrollContainer(e.length*6)}delete this._scrollTimerId},500)}).catch(e=>{console.error("Error in Supabase query:",e);o.setProperty("/busy",false)})}})});
//# sourceMappingURL=EntityList.controller.js.map