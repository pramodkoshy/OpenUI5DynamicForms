sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/Label","sap/m/Input","sap/m/DatePicker","sap/m/CheckBox","sap/m/ComboBox","sap/m/Token","sap/m/Dialog","sap/m/List","sap/m/StandardListItem","sap/ui/core/Item","sap/ui/layout/form/SimpleForm","sap/m/MessageToast","sap/m/MessageBox","sap/m/Button"],function(e,t,o,n,s,a,r,i,l,c,d,m,p,u,g,f,h,y){"use strict";return e.extend("com.supabase.easyui5.controller.EntityList",{onInit:function(){const e=new t({tableName:"",tableId:"",items:[],allItems:[],busy:false,visibleColumns:[],availableColumns:[],filterCriteria:{},filterInfo:""});this.setModel(e,"viewModel");this.getRouter().getRoute("entityList").attachPatternMatched(this._onRouteMatched,this)},onToggleNav:function(){try{const e=sap.ui.getCore().byId("content");let t=null;if(this.getOwnerComponent()&&this.getOwnerComponent().getSplitApp){t=this.getOwnerComponent().getSplitApp()}if(!t&&this.getOwnerComponent()&&this.getOwnerComponent().getRootControl){const e=this.getOwnerComponent().getRootControl();if(e){t=e.byId("app")}}if(!t){t=sap.ui.getCore().byId("__component0---app");if(!t){t=sap.ui.getCore().byId("__xmlview0--app")}}if(!t){const e=sap.ui.getCore().byFieldGroupId("").filter(function(e){return e instanceof sap.m.SplitApp});if(e.length>0){t=e[0]}}if(!t){console.error("SplitApp control not found!");return}const o=this.getOwnerComponent().getModel("appView");if(!o){console.error("AppView model not found!");return}const n=o.getProperty("/navExpanded");const s=this.getView().byId("navToggleButton");console.log("Entity List toggle nav button pressed. Current state:",n?"expanded":"collapsed");if(n){if(sap.ui.Device.system.phone){t.hideMaster()}else{const e=t.getMode();if(e!=="HideMode"&&e!=="ShowHideMode"){t.setMode("ShowHideMode")}t.hideMaster()}if(s){s.setIcon("sap-icon://menu2");s.setTooltip("Show Navigation")}o.setProperty("/navExpanded",false)}else{if(sap.ui.Device.system.phone){t.showMaster()}else{t.setMode("ShowHideMode");t.showMaster()}if(s){s.setIcon("sap-icon://navigation-left-arrow");s.setTooltip("Hide Navigation")}o.setProperty("/navExpanded",true)}}catch(e){console.error("Error in menu toggle:",e)}},_onRouteMatched:function(e){const t=e.getParameter("arguments").table;console.log("EntityList route matched with table:",t);const o=this.getModel("viewModel");o.setProperty("/tableId",t);o.setProperty("/filterCriteria",{});o.setProperty("/visibleColumns",[]);o.setProperty("/availableColumns",[]);o.setProperty("/filterInfo","");const n=t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ");o.setProperty("/tableName",n);this.getView().byId("entityListPage").setTitle(n+" List");try{const e=this.getView().byId("entityListPage").getContent()[0];if(e&&e.setHeaderExpanded){e.setHeaderExpanded(false)}}catch(e){console.error("Error setting header state:",e)}this.getTableMetadata(t).then(e=>{this._tableMetadata=e;this._configureSearchForm(e);this._configureTable(e);this._loadData(t,e)}).catch(e=>{console.error("Error loading metadata:",e);h.error("Failed to load table metadata: "+e.message)})},_configureSearchForm:function(e){const t=this.getView().byId("searchForm");t.removeAllContent();e.columns.forEach(e=>{if(!e.visible||e.name==="created_at"||e.name==="updated_at"){return}t.addContent(new s({text:e.label,tooltip:"Search by "+e.label}));let o;switch(e.type){case"date":o=new r({valueFormat:"yyyy-MM-dd",displayFormat:"medium",width:"100%"});break;case"boolean":o=new l({width:"100%",items:[new u({key:"",text:"All"}),new u({key:"true",text:"Yes"}),new u({key:"false",text:"No"})]});break;case"relation":o=new l({width:"100%",showSecondaryValues:true});this._loadRelationOptions(o,e.relation,e.name);break;default:o=new a({width:"100%"})}o.data("columnName",e.name);o.data("columnType",e.type);t.addContent(o)})},_configureTable:function(e){const t=this.getView().byId("entityTable");const a=this.getModel("viewModel");t.removeAllColumns();let r=t.getBindingInfo("items")&&t.getBindingInfo("items").template;if(!r){r=new sap.m.ColumnListItem({type:"Navigation",press:this.onItemPress.bind(this)})}else{r.removeAllCells()}const i=e.columns.filter(e=>e.visible).slice(0,7);const l=e.columns.filter(e=>e.visible);a.setProperty("/availableColumns",l);a.setProperty("/visibleColumns",i);i.forEach((e,a)=>{let i;switch(e.type){case"boolean":i="8rem";break;case"date":i="12rem";break;case"number":case"integer":i="10rem";break;case"email":case"url":i="18rem";break;case"relation":i="15rem";break;default:if(a===0){i="18rem"}else if(a===1){i="20rem"}else if(a===2){i="20rem"}else{i="15rem"}}const l=new o({header:new s({text:e.label,design:"Bold"}),width:i,minScreenWidth:"Tablet",demandPopin:true,popinDisplay:"Inline",hAlign:e.type==="number"||e.type==="integer"?"End":"Begin"});l.data("columnName",e.name);l.data("columnType",e.type);t.addColumn(l);let c;switch(e.type){case"date":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e){return""}return new Date(e).toLocaleDateString()}},wrapping:false});break;case"boolean":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}},wrapping:false});break;case"relation":c=new n({text:{path:"viewModel>"+e.name+"_text"},wrapping:false});break;case"number":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(e===undefined||e===null)return"";return parseFloat(e).toFixed(2)}},wrapping:false});break;default:c=new n({text:"{viewModel>"+e.name+"}",wrapping:false,maxLines:2})}c.addStyleClass("sapUiTinyMarginBeginEnd");r.addCell(c)});t.bindItems({path:"viewModel>/items",template:r});t.setFixedLayout(false);t.setAlternateRowColors(true);t.setPopinLayout("Block")},_loadData:function(e,t){const o=this.getModel("viewModel");o.setProperty("/busy",true);console.log("Loading data from table:",e);this.getSupabaseClient().from(e).select("*").then(async({data:e,error:n})=>{if(n){console.error("Error loading data:",n);this.showErrorMessage("Error loading data",n);o.setProperty("/busy",false);return}e=e||[];console.log(`Loaded ${e.length} records`);for(let o=0;o<e.length;o++){for(const n of t.columns){if(n.type==="relation"&&e[o][n.name]){const t=e[o][n.name];const s=n.relation;try{const a=await this.getTableMetadata(s);const{data:r,error:i}=await this.getSupabaseClient().from(s).select("*").eq(a.primaryKey,t).single();if(!i&&r){e[o][n.name+"_text"]=r[a.titleField]}}catch(e){console.error("Error loading related data",e)}}}}o.setProperty("/items",e);o.setProperty("/allItems",[...e]);o.setProperty("/busy",false);const s=e.length+" "+(e.length===1?"item":"items");this.getView().byId("tableCountText").setText(s)}).catch(e=>{console.error("Error in Supabase query:",e);o.setProperty("/busy",false)})},_loadRelationOptions:function(e,t,o){this.getTableMetadata(t).then(n=>{const s=n.primaryKey;const a=n.titleField||s;this.getSupabaseClient().from(t).select("*").then(({data:t,error:n})=>{if(n){console.error(`Error loading relation options for ${o}:`,n);return}e.removeAllItems();e.addItem(new u({key:"",text:"All"}));if(t&&t.length>0){t.forEach(t=>{e.addItem(new u({key:t[s],text:t[a]||t[s]}))})}}).catch(e=>{console.error(`Error in Supabase query for relation options:`,e)})}).catch(e=>{console.error(`Error getting metadata for relation ${t}:`,e)})},onColumnsButtonPress:function(){const e=this.getModel("viewModel");const o=e.getProperty("/availableColumns");const n=e.getProperty("/visibleColumns");if(!this._oColumnDialog){this._oColumnDialog=new d({title:"Select Columns",contentWidth:"400px",content:new m({mode:"MultiSelect",includeItemInSelection:true,items:{path:"columns>/",template:new p({title:"{columns>label}",description:"{columns>name}",type:"Active",selected:{path:"columns>visible",formatter:function(e){return e===true}}})}}),beginButton:new y({text:"Apply",type:"Emphasized",press:function(){const t=this._oColumnDialog.getContent()[0];const o=t.getSelectedItems();const n=o.map(e=>{const t=e.getBindingContext("columns").getPath();return this._oColumnDialog.getModel("columns").getProperty(t)});e.setProperty("/visibleColumns",n);this._reconfigureTable(n);this._oColumnDialog.close()}.bind(this)}),endButton:new y({text:"Cancel",press:function(){this._oColumnDialog.close()}.bind(this)})});this.getView().addDependent(this._oColumnDialog)}const s=o.map(e=>({name:e.name,label:e.label,type:e.type,visible:n.some(t=>t.name===e.name)}));this._oColumnDialog.setModel(new t(s),"columns");this._oColumnDialog.open()},_reconfigureTable:function(e){const t=this.getView().byId("entityTable");t.removeAllColumns();let a=t.getBindingInfo("items")&&t.getBindingInfo("items").template;if(!a){a=new sap.m.ColumnListItem({type:"Navigation",press:this.onItemPress.bind(this)})}else{a.removeAllCells()}e.forEach((e,r)=>{let i;switch(e.type){case"boolean":i="8rem";break;case"date":i="12rem";break;case"number":case"integer":i="10rem";break;case"email":case"url":i="18rem";break;case"relation":i="15rem";break;default:if(r===0){i="18rem"}else if(r===1){i="20rem"}else if(r===2){i="20rem"}else{i="15rem"}}const l=new o({header:new s({text:e.label,design:"Bold"}),width:i,minScreenWidth:"Tablet",demandPopin:true,popinDisplay:"Inline",hAlign:e.type==="number"||e.type==="integer"?"End":"Begin"});l.data("columnName",e.name);l.data("columnType",e.type);t.addColumn(l);let c;switch(e.type){case"date":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e){return""}return new Date(e).toLocaleDateString()}},wrapping:false});break;case"boolean":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}},wrapping:false});break;case"relation":c=new n({text:{path:"viewModel>"+e.name+"_text"},wrapping:false});break;case"number":c=new n({text:{path:"viewModel>"+e.name,formatter:function(e){if(e===undefined||e===null)return"";return parseFloat(e).toFixed(2)}},wrapping:false});break;default:c=new n({text:"{viewModel>"+e.name+"}",wrapping:false,maxLines:2})}c.addStyleClass("sapUiTinyMarginBeginEnd");a.addCell(c)});const r=t.getBinding("items");if(r){r.getTemplate=function(){return a};t.invalidate()}else{t.bindItems({path:"viewModel>/items",template:a})}},onServerSearchPress:function(){try{var e=this.getView().byId("entityListPage").getContent()[0];if(e){e.setHeaderExpanded(true);f.show("Server search activated - use form to search database")}}catch(e){console.error("Error in server search button handler:",e);f.show("Could not activate server search form")}},onAdvancedSearch:function(){const e=this.getView().byId("searchForm");const t=this.getModel("viewModel");const o=t.getProperty("/tableId");const n={};let a=false;const c=e.getContent();for(let e=0;e<c.length;e++){const t=c[e];if(t instanceof s){continue}const o=t.data("columnName");const d=t.data("columnType");let m;if(t instanceof l){m=t.getSelectedKey()}else if(t instanceof i){m=t.getSelected()?"true":"false"}else if(t instanceof r){m=t.getValue()}else{m=t.getValue()}if(m&&m.trim()!==""){n[o]={value:m,type:d};a=true}}if(!a){t.setProperty("/items",t.getProperty("/allItems"));t.setProperty("/filterInfo","");const e=t.getProperty("/items");const o=e.length+" "+(e.length===1?"item":"items");this.getView().byId("tableCountText").setText(o);f.show("No search criteria specified. Showing all records.");return}t.setProperty("/filterCriteria",n);this._executeAdvancedSearch(o,n)},_executeAdvancedSearch:function(e,t){const o=this.getModel("viewModel");o.setProperty("/busy",true);let n=this.getSupabaseClient().from(e).select("*");const s=[];Object.keys(t).forEach(e=>{const o=t[e];const a=o.value;const r=o.type;if(r==="relation"||r==="number"||r==="boolean"){n=n.eq(e,a);s.push(`${e} = ${a}`)}else if(r==="date"){n=n.eq(e,a);s.push(`${e} = ${a}`)}else{n=n.ilike(e,`%${a}%`);s.push(`${e} contains "${a}"`)}});n.then(async({data:e,error:t})=>{if(t){console.error("Error executing search:",t);this.showErrorMessage("Error executing search",t);o.setProperty("/busy",false);return}e=e||[];console.log(`Search returned ${e.length} records`);for(let t=0;t<e.length;t++){for(const o of this._tableMetadata.columns){if(o.type==="relation"&&e[t][o.name]){const n=e[t][o.name];const s=o.relation;try{const a=await this.getTableMetadata(s);const{data:r,error:i}=await this.getSupabaseClient().from(s).select("*").eq(a.primaryKey,n).single();if(!i&&r){e[t][o.name+"_text"]=r[a.titleField]}}catch(e){console.error("Error loading related data",e)}}}}o.setProperty("/items",e);const n=s.length>0?"Filtered by: "+s.join(", "):"";o.setProperty("/filterInfo",n);const a=e.length+" "+(e.length===1?"item":"items")+(s.length>0?" (filtered)":"");this.getView().byId("tableCountText").setText(a);o.setProperty("/busy",false)}).catch(e=>{console.error("Error in Supabase query:",e);o.setProperty("/busy",false)})},onResetSearch:function(){const e=this.getView().byId("searchForm");const t=e.getContent();for(let e=0;e<t.length;e++){const o=t[e];if(o instanceof s){continue}if(o instanceof l){o.setSelectedKey("")}else if(o instanceof i){o.setSelected(false)}else if(o instanceof r){o.setValue("")}else{o.setValue("")}}const o=this.getModel("viewModel");o.setProperty("/filterCriteria",{});o.setProperty("/filterInfo","");o.setProperty("/items",o.getProperty("/allItems"));const n=o.getProperty("/items");const a=n.length+" "+(n.length===1?"item":"items");this.getView().byId("tableCountText").setText(a);f.show("Search criteria reset. Showing all records.")},onQuickSearch:function(e){const t=e.getParameter("query").toLowerCase();const o=this.getModel("viewModel");const n=[...o.getProperty("/allItems")];if(!t){o.setProperty("/items",n);o.setProperty("/filterInfo","");const e=n.length+" "+(n.length===1?"item":"items");this.getView().byId("tableCountText").setText(e);return}const s=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t));o.setProperty("/items",s);o.setProperty("/filterInfo","Quick search for: "+t);const a=s.length+" "+(s.length===1?"item":"items")+" (filtered)";this.getView().byId("tableCountText").setText(a)},onSearch:function(e){const t=e.getParameter("query").toLowerCase();const o=this.getModel("viewModel");const n=[...o.getProperty("/allItems")];if(!t){o.setProperty("/items",n);o.setProperty("/filterInfo","");const e=n.length+" "+(n.length===1?"item":"items");this.getView().byId("tableCountText").setText(e);return}const s=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t));o.setProperty("/items",s);o.setProperty("/filterInfo","Table search for: "+t);const a=s.length+" "+(s.length===1?"item":"items")+" (filtered)";this.getView().byId("tableCountText").setText(a)},onItemPress:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");if(!o){console.error("No binding context found");return}const n=o.getObject();const s=this.getModel("viewModel").getProperty("/tableId");console.log("Item clicked:",n);this.getTableMetadata(s).then(e=>{const t=e.primaryKey||`${s}_id`;console.log("Primary key field:",t);console.log("Item data keys:",Object.keys(n));const o=n[t];if(o===undefined){console.error("Primary key value is undefined. Cannot navigate.");return}console.log("Navigating to detail with ID:",o);try{this.getRouter().navTo("entityDetail",{table:s,id:o},false);console.log("Navigation call completed")}catch(e){console.error("Navigation error:",e)}}).catch(e=>{console.error("Error getting metadata for navigation:",e)})},onCreatePress:function(){const e=this.getModel("viewModel").getProperty("/tableId");this.getRouter().navTo("entityCreate",{table:e})},onRefreshPress:function(){const e=this.getModel("viewModel").getProperty("/tableId");const t=this.getModel("viewModel");t.setProperty("/filterCriteria",{});t.setProperty("/filterInfo","");const o=this.getView().byId("searchForm");const n=o.getContent();for(let e=0;e<n.length;e++){const t=n[e];if(t instanceof s){continue}if(t instanceof l){t.setSelectedKey("")}else if(t instanceof i){t.setSelected(false)}else if(t instanceof r){t.setValue("")}else{t.setValue("")}}const a=this.getView().byId("quickSearch");if(a){a.setValue("")}const c=this.getView().byId("tableSearch");if(c){c.setValue("")}this.getTableMetadata(e).then(t=>{this._loadData(e,t)})},onExportPress:function(){const e=this.getModel("viewModel");const t=e.getProperty("/items");const o=e.getProperty("/tableName");if(!t||t.length===0){f.show("No data to export");return}const n=e.getProperty("/visibleColumns");const s=n.map(e=>e.label);const a=n.map(e=>e.name);let r=s.join(",")+"\n";t.forEach(e=>{const t=a.map(t=>{const o=e[t]===undefined?"":e[t];if(typeof o==="string"){return`"${o.replace(/"/g,'""')}"`}else if(o===null){return""}else{return o}});r+=t.join(",")+"\n"});const i=new Blob([r],{type:"text/csv;charset=utf-8"});const l=`${o}_Export_${(new Date).toISOString().split("T")[0]}.csv`;if(window.navigator.msSaveOrOpenBlob){window.navigator.msSaveBlob(i,l)}else{const e=document.createElement("a");e.href=URL.createObjectURL(i);e.download=l;document.body.appendChild(e);e.click();document.body.removeChild(e)}f.show(`Exported ${t.length} records to ${l}`)},onNavBack:function(){this.navBack()}})});
//# sourceMappingURL=EntityList.controller.js.map