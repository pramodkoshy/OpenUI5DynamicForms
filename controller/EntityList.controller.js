sap.ui.define(["com/supabase/easyui5/controller/BaseController","sap/ui/model/json/JSONModel","sap/m/Column","sap/m/Text","sap/m/Label"],function(e,t,o,n,a){"use strict";return e.extend("com.supabase.easyui5.controller.EntityList",{onInit:function(){const e=new t({tableName:"",tableId:"",items:[],busy:false});this.setModel(e,"viewModel");this.getRouter().getRoute("entityList").attachPatternMatched(this._onRouteMatched,this)},onToggleNav:function(){try{const e=sap.ui.getCore().byId("content");let t=null;if(this.getOwnerComponent()&&this.getOwnerComponent().getSplitApp){t=this.getOwnerComponent().getSplitApp()}if(!t&&this.getOwnerComponent()&&this.getOwnerComponent().getRootControl){const e=this.getOwnerComponent().getRootControl();if(e){t=e.byId("app")}}if(!t){t=sap.ui.getCore().byId("__component0---app");if(!t){t=sap.ui.getCore().byId("__xmlview0--app")}}if(!t){const e=sap.ui.getCore().byFieldGroupId("").filter(function(e){return e instanceof sap.m.SplitApp});if(e.length>0){t=e[0]}}if(!t){console.error("SplitApp control not found!");return}const o=this.getOwnerComponent().getModel("appView");if(!o){console.error("AppView model not found!");return}const n=o.getProperty("/navExpanded");const a=this.getView().byId("navToggleButton");console.log("Entity List toggle nav button pressed. Current state:",n?"expanded":"collapsed");if(n){if(sap.ui.Device.system.phone){t.hideMaster()}else{const e=t.getMode();if(e!=="HideMode"&&e!=="ShowHideMode"){t.setMode("ShowHideMode")}t.hideMaster()}if(a){a.setIcon("sap-icon://menu2");a.setTooltip("Show Navigation")}o.setProperty("/navExpanded",false)}else{if(sap.ui.Device.system.phone){t.showMaster()}else{t.setMode("ShowHideMode");t.showMaster()}if(a){a.setIcon("sap-icon://navigation-left-arrow");a.setTooltip("Hide Navigation")}o.setProperty("/navExpanded",true)}}catch(e){console.error("Error in menu toggle:",e)}},_onRouteMatched:function(e){const t=e.getParameter("arguments").table;console.log("EntityList route matched with table:",t);const o=this.getModel("viewModel");o.setProperty("/tableId",t);const n=t.charAt(0).toUpperCase()+t.slice(1).replace(/_/g," ");o.setProperty("/tableName",n);this.getView().byId("entityListPage").setTitle(n+" List");this.getTableMetadata(t).then(e=>{this._configureTable(e);this._loadData(t,e)}).catch(e=>{console.error("Error loading metadata:",e)})},_configureTable:function(e){const t=this.getView().byId("entityTable");t.removeAllColumns();let o=t.getBindingInfo("items")&&t.getBindingInfo("items").template;if(!o){o=new sap.m.ColumnListItem({type:"Navigation",press:this.onItemPress.bind(this)})}else{o.removeAllCells()}this._visibleColumns=[];const n=e.columns.filter(e=>e.visible).slice(0,5);n.forEach((e,n)=>{this._visibleColumns.push(e);let a;switch(e.type){case"boolean":a="8rem";break;case"date":a="12rem";break;case"number":case"integer":a="10rem";break;case"email":case"url":a="18rem";break;case"relation":a="15rem";break;default:if(n===0){a="18rem"}else if(n===1){a="20rem"}else if(n===2){a="20rem"}else{a="15rem"}}const s=new sap.m.Column({header:new sap.m.Label({text:e.label,design:"Bold"}),width:a,minScreenWidth:"Tablet",demandPopin:true,popinDisplay:"Inline",hAlign:e.type==="number"||e.type==="integer"?"End":"Begin"});t.addColumn(s);let i;switch(e.type){case"date":i=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){if(!e){return""}return new Date(e).toLocaleDateString()}},wrapping:false});break;case"boolean":i=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){return e?"Yes":"No"}},wrapping:false});break;case"relation":i=new sap.m.Text({text:{path:"viewModel>"+e.name+"_text"},wrapping:false});break;case"number":i=new sap.m.Text({text:{path:"viewModel>"+e.name,formatter:function(e){if(e===undefined||e===null)return"";return parseFloat(e).toFixed(2)}},wrapping:false});break;default:i=new sap.m.Text({text:"{viewModel>"+e.name+"}",wrapping:false,maxLines:2})}i.addStyleClass("sapUiTinyMarginBeginEnd");o.addCell(i)});t.bindItems({path:"viewModel>/items",template:o});t.setFixedLayout(false);t.setAlternateRowColors(true);t.setPopinLayout("Block");t.addStyleClass("sapUiResponsiveMargin")},_loadData:function(e,t){const o=this.getModel("viewModel");o.setProperty("/busy",true);console.log("Loading data from table:",e);this.getSupabaseClient().from(e).select("*").then(async({data:e,error:n})=>{if(n){console.error("Error loading data:",n);this.showErrorMessage("Error loading data",n);o.setProperty("/busy",false);return}e=e||[];console.log(`Loaded ${e.length} records`);for(let o=0;o<e.length;o++){for(const n of t.columns){if(n.type==="relation"&&e[o][n.name]){const t=e[o][n.name];const a=n.relation;try{const s=await this.getTableMetadata(a);const{data:i,error:r}=await this.getSupabaseClient().from(a).select("*").eq(s.primaryKey,t).single();if(!r&&i){e[o][n.name+"_text"]=i[s.titleField]}}catch(e){console.error("Error loading related data",e)}}}}o.setProperty("/items",e);o.setProperty("/busy",false);const a=e.length+" "+(e.length===1?"item":"items");this.getView().byId("tableCountText").setText(a)}).catch(e=>{console.error("Error in Supabase query:",e);o.setProperty("/busy",false)})},onItemPress:function(e){const t=e.getSource();const o=t.getBindingContext("viewModel");if(!o){console.error("No binding context found");return}const n=o.getObject();const a=this.getModel("viewModel").getProperty("/tableId");console.log("Item clicked:",n);this.getTableMetadata(a).then(e=>{const t=e.primaryKey||`${a}_id`;console.log("Primary key field:",t);console.log("Item data keys:",Object.keys(n));const o=n[t];if(o===undefined){console.error("Primary key value is undefined. Cannot navigate.");return}console.log("Navigating to detail with ID:",o);try{const e=this.getRouter();console.log("Router object:",e);console.log("Route params:",{routeName:"entityDetail",params:{table:a,id:o}});e.navTo("entityDetail",{table:a,id:o},false);console.log("Navigation call completed")}catch(e){console.error("Navigation error:",e)}}).catch(e=>{console.error("Error getting metadata for navigation:",e)})},onCreatePress:function(){const e=this.getModel("viewModel").getProperty("/tableId");this.getRouter().navTo("entityCreate",{table:e})},onRefreshPress:function(){const e=this.getModel("viewModel").getProperty("/tableId");this.getTableMetadata(e).then(t=>{this._loadData(e,t)})},onSearch:function(e){const t=e.getParameter("query").toLowerCase();const o=this.getModel("viewModel");const n=[...o.getProperty("/items")];if(!t){const e=o.getProperty("/tableId");this.getTableMetadata(e).then(t=>{this._loadData(e,t)});return}const a=n.filter(e=>JSON.stringify(e).toLowerCase().includes(t));o.setProperty("/items",a);const s=a.length+" "+(a.length===1?"item":"items")+" (filtered)";this.getView().byId("tableCountText").setText(s)},onTableUpdateFinished:function(e){const t=e.getParameter("total");const o=t+" "+(t===1?"item":"items");this.getView().byId("tableCountText").setText(o)},onNavBack:function(){this.navBack()}})});
//# sourceMappingURL=EntityList.controller.js.map