sap.ui.define(["sap/ui/base/Object"],function(e){"use strict";return e.extend("com.supabase.easyui5.service.SchemaDetectionService",{constructor:function(t){e.call(this);this._oSupabaseClient=t;this._mSchemaCache={}},detectSchema:function(e){if(this._mSchemaCache[e]){return Promise.resolve(this._mSchemaCache[e])}return this._fetchSampleData(e).then(t=>{if(!t||t.length===0){return this._fetchTableDefinition(e)}const i=this._detectSchemaFromSample(e,t);this._mSchemaCache[e]=i;return i})},_fetchSampleData:function(e){return this._oSupabaseClient.from(e).select("*").limit(10).then(({data:e,error:t})=>{if(t){console.error("Error fetching sample data:",t);return[]}return e||[]}).catch(e=>{console.error("Error in Supabase query:",e);return[]})},_fetchTableDefinition:function(e){const t=this._createDefaultSchema(e);this._mSchemaCache[e]=t;return Promise.resolve(t)},_detectSchemaFromSample:function(e,t){const i={primaryKey:null,titleField:null,subtitleField:null,columns:[],relations:[]};if(!t||t.length===0){return this._createDefaultSchema(e)}const r=t[0];const n=Object.keys(r);const s=["id",`${e}_id`,"uuid","key","code"];for(const e of s){if(n.includes(e)){i.primaryKey=e;break}}if(!i.primaryKey&&n.length>0){i.primaryKey=n[0]}const a=["name","title","label","description","summary"];for(const e of a){if(n.includes(e)){i.titleField=e;break}}if(!i.titleField){i.titleField=i.primaryKey}const l=["description","summary","subtitle","details","status"];for(const e of l){if(n.includes(e)&&e!==i.titleField){i.subtitleField=e;break}}n.forEach(r=>{const n=t.map(e=>e[r]).filter(e=>e!==null&&e!==undefined);const s=this._detectColumnProperties(r,n,e);i.columns.push(s);if(this._isLikelyRelationField(r,n)){const t=this._detectRelatedTable(r);if(t&&t!==e){s.type="relation";s.relation=t;i.relations.push({table:t,foreignKey:r})}}});this._mSchemaCache[e]=i;return i},_detectColumnProperties:function(e,t,i){const r={name:e,label:this._generateLabel(e),type:"string",visible:true,editable:true,required:false};if(!t||t.length===0){return r}if(this._matchesPattern(e,["id",`${i}_id`,"code","uuid"])){r.editable=false;r.required=false}else if(this._matchesPattern(e,["created_at","created","creation_date"])){r.type="date";r.editable=false;r.required=false}else if(this._matchesPattern(e,["updated_at","modified","modified_date"])){r.type="date";r.editable=false;r.required=false}else if(this._matchesPattern(e,["name","title"])){r.type="string";r.required=true}else if(this._matchesPattern(e,["description","details","notes"])){r.type="text"}else if(this._matchesPattern(e,["email"])){r.type="email"}else if(this._matchesPattern(e,["url","website","link"])){r.type="url"}else if(this._matchesPattern(e,["phone","telephone","mobile"])){r.type="phone"}else if(this._matchesPattern(e,["password","pwd"])){r.type="password"}else if(this._matchesPattern(e,["color","colour"])){r.type="color"}else if(this._matchesPattern(e,["date","day"])){r.type="date"}else if(this._matchesPattern(e,["time"])){r.type="time"}else if(this._matchesPattern(e,["datetime","timestamp"])){r.type="datetime"}else if(this._matchesPattern(e,["enabled","active","is_","has_"])){r.type="boolean"}else if(this._matchesPattern(e,["price","amount","total","cost","fee"])){r.type="number"}else if(this._matchesPattern(e,["quantity","count","number","age","duration"])){r.type="integer"}else if(this._matchesPattern(e,["tags","categories","keywords"])){r.type="tags"}else if(this._endsWithPattern(e,["_id"])){r.type="relation";r.relation=e.replace(/_id$/,"");r.required=true}if(r.type==="string"){const e=t.find(e=>e!==null&&e!==undefined);if(e!==undefined){const t=this._detectTypeFromValue(e);if(t!=="string"){r.type=t}}}return r},_matchesPattern:function(e,t){const i=e.toLowerCase();return t.some(e=>{const t=e.toLowerCase();return i===t||i.includes(t)||i.startsWith(t)})},_endsWithPattern:function(e,t){const i=e.toLowerCase();return t.some(e=>{const t=e.toLowerCase();return i.endsWith(t)})},_generateLabel:function(e){let t=e.replace(/^(fk_|pk_|r_|tbl_|col_)/i,"").replace(/_id$/i,"");t=t.split("_").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" ");t=t.replace(/([a-z])([A-Z])/g,"$1 $2");return t},_detectTypeFromValue:function(e){if(e===null||e===undefined){return"string"}const t=typeof e;switch(t){case"boolean":return"boolean";case"number":return Number.isInteger(e)?"integer":"number";case"string":if(this._isDateString(e)){return"date"}if(this._isTimeString(e)){return"time"}if(this._isDateTimeString(e)){return"datetime"}if(this._isEmailString(e)){return"email"}if(this._isUrlString(e)){return"url"}if(this._isColorString(e)){return"color"}if(e.length>100){return"text"}return"string";case"object":if(e instanceof Date){return"datetime"}if(Array.isArray(e)){return"tags"}return"string";default:return"string"}},_isDateString:function(e){const t=[/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{1,2}\.\d{1,2}\.\d{4}$/,/^\d{4}\/\d{1,2}\/\d{1,2}$/];return t.some(t=>t.test(e))},_isTimeString:function(e){const t=[/^\d{1,2}:\d{2}(:\d{2})?$/];return t.some(t=>t.test(e))},_isDateTimeString:function(e){const t=[/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}/,/^\d{4}-\d{2}-\d{2}\s\d{2}:\d{2}:\d{2}/];return t.some(t=>t.test(e))},_isEmailString:function(e){const t=/^[^\s@]+@[^\s@]+\.[^\s@]+$/;return t.test(e)},_isUrlString:function(e){const t=/^(https?:\/\/)/i;return t.test(e)},_isColorString:function(e){const t=/^#([0-9A-F]{3}|[0-9A-F]{6})$/i;return t.test(e)},_isLikelyRelationField:function(e,t){if(e.endsWith("_id")||e.endsWith("Id")||e.endsWith("_key")||e.startsWith("fk_")){return true}if(t.length>0){const e=t.every(e=>typeof e==="number"||typeof e==="string"&&/^[a-zA-Z0-9_-]+$/.test(e));if(e){return true}}return false},_detectRelatedTable:function(e){if(e.endsWith("_id")){return e.substring(0,e.length-3)}if(e.endsWith("Id")&&e.length>2){const t=e.substring(0,e.length-2);return t.replace(/([a-z])([A-Z])/g,"$1_$2").toLowerCase()}if(e.startsWith("fk_")&&e.length>3){return e.substring(3)}return e.replace(/_key$/,"").replace(/_code$/,"").replace(/_ref$/,"")},_createDefaultSchema:function(e){return{primaryKey:"id",titleField:"name",subtitleField:"description",columns:[{name:"id",label:"ID",type:"string",visible:true,editable:false,required:false},{name:"name",label:"Name",type:"string",visible:true,editable:true,required:true},{name:"description",label:"Description",type:"text",visible:true,editable:true,required:false},{name:"created_at",label:"Created At",type:"date",visible:true,editable:false,required:false},{name:"updated_at",label:"Updated At",type:"date",visible:true,editable:false,required:false}],relations:[]}}})});
//# sourceMappingURL=SchemaDetectionService.js.map